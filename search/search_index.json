{"config":{"lang":["en"],"separator":"[\\s\\u200b\\u3000\\-\u3001\u3002\uff0c\uff0e\uff1f\uff01\uff1b]+","pipeline":["stemmer"]},"docs":[{"location":"","title":"\u4f60\u597d\ud83d\udc4b","text":"<p>\u6b22\u8fce\u6765\u5230\u6211\u7684\u7f51\u7ad9\uff01 ZJU 2021\u7ea7 \u8f6f\u4ef6\u5de5\u7a0b\u672c\u79d1\u5728\u8bfb\u3002 \u5199\u70b9\u6709\u610f\u601d\u7684\u4e1c\u897f\u3002 \u65e0\u754f\u5951\u7ea6\uff1a\u6211\u5f00\u6446\u4e86\u4f60\u5462#1987\u3002\u6b22\u8fce\u7ea6\u74e6\u3002</p>"},{"location":"#lets-go","title":"Let's Go!","text":"<pre><code>func main() {\n    fmt.Println(\"Let's Go!\");\n}\n</code></pre>"},{"location":"#_2","title":"\u4e00\u9996\u559c\u6b22\u7684\u5c0f\u8bd7\uff08\u8282\u9009\uff09","text":"<p>\u4f60\uff0c\u5982\u4eca\u4e0d\u8bb0\u5f97</p> <p>\u4ece\u53e6\u4e00\u4e2a\u4e16\u754c\u5230\u6765\u7684\u8dcb\u6d89\uff0c</p> <p>\u6211\u544a\u8bc9\u4f60\u6211\u53c8\u80fd\u8bb2\u8bdd\u4e86\uff1a\u4e00\u5207</p> <p>\u4ece\u9057\u5fd8\u4e2d\u8fd4\u56de\u7684\uff0c\u8fd4\u56de</p> <p>\u53bb\u53d1\u73b0\u4e00\u4e2a\u58f0\u97f3\uff1a</p> <p>\u4ece\u6211\u751f\u547d\u7684\u6838\u5fc3\uff0c\u6d8c\u8d77</p> <p>\u5de8\u5927\u7684\u55b7\u6cc9\uff0c\u6e5b\u84dd\u8272</p> <p>\u6295\u5f71\u5728\u851a\u84dd\u7684\u6d77\u6c34\u4e0a</p>"},{"location":"blog/","title":"Blog","text":""},{"location":"blog/2023/10/20/go-range/","title":"Go Range\u7684\u5947\u602a\u673a\u5236","text":"<p>\u5728\u4e0b\u9762\u7684\u4ee3\u7801\u4e2d\uff0c\u8bf7\u95ee\u8f93\u51fa\u662f\u4ec0\u4e48\uff1f <pre><code>l := []int{1, 2, 3}  \nfor _, v := range l {\n    fmt.Printf(\"%d, %p\", v, &amp;v)\n}\n</code></pre></p> <p>\u7b54\u6848\u662f: <pre><code>1 \u67d0\u4e2a\u5730\u5740A\n2 A\n3 A\n</code></pre> \u4f60\u53ef\u80fd\u89c9\u5f97\u5f88\u5947\u602a\uff0c\u4e3a\u4ec0\u4e48\u901a\u8fc7<code>range</code>\u5f97\u5230\u7684<code>v</code>\u503c\u4e0d\u4e00\u6837\uff0c\u4f46\u662f\u5730\u5740\u4e00\u6837\u5462\uff1f  </p> <p>\u5047\u8bbeGo\u662f\u4e00\u5bb6\u6f2b\u753b\u5e97\u7684\u8001\u677f\uff0c\u6700\u8fd1\u6709\u4e2a3\u9875\u7684\u6f2b\u753b\uff0c\u4f60\u60f3\u53bb\u770b\u3002Go\u8001\u677f\u62ff\u51fa\u4e00\u53f0pad\uff0c\u4e0a\u9762\u4e00\u6b21\u53ea\u80fd\u663e\u793a\u4e00\u9875\u6f2b\u753b\u3002\u4e8e\u662f\uff0c\u4f60\u901a\u8fc7\u540c\u4e00\u4e2apad\u8bfb\u53d6\u4e86\u4e09\u9875\u4e0d\u540c\u7684\u6f2b\u753b\u3002  </p> <p>\u8fd9\u5c31\u662frange\u7684\u8bbe\u8ba1\u65b9\u5f0f\uff0cGo\u8ba4\u4e3a\u4f60\u901a\u8fc7range\u662f\u60f3\u8bfb\u4e00\u4e2a\u53d8\u91cf\uff0c\u800c\u4e0d\u662f\u5f97\u5230\u53d8\u91cf\u672c\u8eab\u3002\u4e8e\u662f\uff0c\u5728\u904d\u5386\u4e00\u4e2a\u5143\u7d20<code>var A []T</code>\u7684\u65f6\u5019Go\u4f1a\u5f00\u8f9f\u4e00\u4e2a\u7c7b\u578b<code>T</code>\u7684\u4e00\u5757\u7a7a\u95f4\uff0c\u6bcf\u6b21\u904d\u5386\uff0c\u5c31\u4ece<code>A</code>\u7684\u5bf9\u5e94\u4f4d\u7f6e\u8bfb\u503c\uff0c\u8d4b\u7ed9\u5f00\u8f9f\u7684\u7a7a\u95f4\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u6bcf\u6b21\u904d\u5386\u90fd\u662f\u5728\u540c\u4e00\u4e2a\u5185\u5b58\u5730\u5740\u8bfb\u526f\u672c\u3002  </p> <p>\u90a3\u4e48\u5982\u679c\u662f\u60f3\u8fdb\u884c\u5982\u5217\u8868\u5143\u7d20append\u4e4b\u7c7b\u7684\u64cd\u4f5c\u600e\u4e48\u529e\u5462\uff1f\u5728for\u7684\u4e0b\u9762\u52a0\u4e00\u884c\u5c31\u597d\uff1a <pre><code>v := v\n</code></pre></p>"},{"location":"blog/2023/10/19/","title":"\u535a\u5ba2\u9996\u9875\uff01","text":"<p>\u6b22\u8fce\u6765\u770b\u6211\u7684\u4e00\u4e9b\u788e\u788e\u5ff5x \u8d28\u91cf\u4e0d\u4e00\u5b9a\u9ad8\uff0c\u5982\u679c\u6709\u95ee\u9898\u6b22\u8fce\u53cd\u9988\uff01</p>"},{"location":"course/","title":"\u65e9\u516b\u8c0b\u6740\u4eba\u7c7b","text":"<p>\u8fd9\u91cc\u8bb0\u5f55\u4e0b\u5b66\u4e86\u4e9b\u5565\u3002 \u53ef\u80fd\u6709\u4e9blab\u8bb0\u5f55\u3002 \u4e0d\u8981\u65e9\u516b\uff01</p>"},{"location":"course/blockchain/basics/","title":"Overview","text":"<p>\u533a\u5757\u94fe\u4e0d\u662f\u6570\u5b57\u8d27\u5e01\uff0c\u662f\u4e00\u79cd\u6280\u672f\uff0c\u662f\u53bb\u4e2d\u5fc3\u5316\u7684\u5206\u5e03\u5f0f\u8d26\u672c\u3002  </p>"},{"location":"course/blockchain/basics/#_1","title":"\u7279\u70b9","text":""},{"location":"course/blockchain/basics/#_2","title":"\u53bb\u4e2d\u5fc3\u5316","text":"<p>\u4ec0\u4e48\u662f\u53bb\u4e2d\u5fc3\u5316\u5462\uff1f\u5c31\u662f\u6ca1\u6709\u4e00\u4e2a\u6838\u5fc3\u7684authority\uff0c\u800c\u662f\u6bcf\u4e2a\u7528\u6237\uff08\u533a\u5757\u94fe\u8282\u70b9\uff09\u90fd\u6709\u4e00\u5b9a\u7684control\u3002\u53ef\u4ee5\u7406\u89e3\u4e3a\u628a\u4e00\u4e2a\u4e2d\u592e\u94f6\u884c\uff0c\u62c6\u6210\u6bcf\u4e2a\u4eba\u90fd\u662f\u4e2a\u5c0f\u94f6\u884c\u3002  </p> <p>\u53bb\u4e2d\u5fc3\u5316\u548ctrust\u6709\u9ad8\u5ea6\u8054\u7cfb\u3002\u5728\u4e00\u4e2a\u4e2d\u5fc3\u5316\u7684\u4ea4\u6613\u7cfb\u7edf\u91cc\uff0c\u56e0\u4e3atrust\uff0c\u6211\u4eec\u624d\u4f1a\u5728authority\u76d1\u7ba1\u4e0b\u8fdb\u884c\u4ea4\u6613\u3002\u800c\u53bb\u4e2d\u5fc3\u5316\uff0c\u6bcf\u4e2a\u4eba\u90fd\u624b\u63e1\u4e00\u6837\u7684\u4fe1\u606f\uff0c\u53ea\u8981\u4e00\u534a\u4ee5\u4e0a\u7684\u4eba\u4fe1\u606f\u76f8\u540c\uff0c\u6211\u5c31\u53ef\u4ee5\u653e\u5fc3\u4ea4\u6613\uff0c\u800c\u4e0d\u7528\u8003\u8651\u6240\u8c13\u7684trust\u3002 </p> <p>\u5728\u533a\u5757\u94fe\u4e2d\uff0c\u53bb\u4e2d\u5fc3\u5316\u4f53\u73b0\u4e3a\uff0c\u6bcf\u4e2a\u533a\u5757\u94fe\u7f51\u7edc\u4e2d\u7684\u8282\u70b9\uff0c\u90fd\u6709\u4e00\u4efd\u533a\u5757\u94fe\u7684copy\u3002\u4e0d\u540c\u7684\u8282\u70b9\u90fd\u53ef\u4ee5\u7ade\u4e89\u6210\u4e3a\u77ff\u5de5\u6765\u83b7\u5f97\u8bb0\u8d26\u6743\u3002\u83b7\u5f97\u8bb0\u8d26\u6743\u540e\uff0c\u77ff\u5de5\u628a\u4ea4\u6613\u6253\u5305\u8fdb\u4e00\u4e2a\u5757\uff0c\u4e00\u5b9a\u65f6\u95f4\u540e\u628a\u5757\u5199\u8fdb\u94fe\uff0c\u4e4b\u540e\u533a\u5757\u94fe\u5e7f\u64ad\u7ed9\u5176\u4f59\u8282\u70b9\u3002  </p> <p> </p>"},{"location":"course/blockchain/basics/#_3","title":"\u5206\u5e03\u5f0f\u8d26\u672c","text":"<p>\u6bcf\u4e00\u6761\u533a\u5757\u94fe\u7684\u7b2c\u4e00\u4e2ablock\u662f\u521b\u4e16\u5757\uff0c\u4e4b\u540e\u6bcf\u4e00\u4e2ablock\u90fd\u8bb0\u5f55\u4e86\u591a\u6761\u4ea4\u6613\u548c\u5176\u4ed6\u7684meta\u4fe1\u606f\uff0cblock\u4e4b\u95f4\u7528\u94fe\u8868\u7684\u65b9\u5f0f\u4e32\u8d77\u6765\uff08key\u4e3ahash\u503c\uff09\uff0c\u5c31\u5f62\u6210\u4e86\u533a\u5757\u94fe\u3002  </p> <p>\u4e00\u6761\u533a\u5757\u94fe\u5728\u591a\u4e2a\u8282\u70b9\u91cc\u90fd\u6709\u5907\u4efd\uff0c\u6240\u4ee5\u8bf4\u5b83\u662f\u5206\u5e03\u5f0f\u7684\uff1b\u6bcf\u4e2a\u533a\u5757\u94fe\u90fd\u8bb0\u5f55\u7684\u975e\u5e38\u591a\u7684\u4ea4\u6613\u4fe1\u606f\uff0c\u6240\u4ee5\u8bf4\u5b83\u662f\u8d26\u672c\u3002 </p> <p> </p>"},{"location":"course/blockchain/basics/#p2p","title":"P2P\u67b6\u6784","text":"<p>\u5b83\u6ca1\u6709\u91c7\u7528C/S\u67b6\u6784\uff0c\u800c\u662fP2P\u67b6\u6784\uff0c\u56e0\u4e3aP2P\u67b6\u6784\u4e2d\u6bcf\u4e00\u53f0\u90fd\u662fpeer\uff0c\u6b63\u7b26\u5408\u53bb\u4e2d\u5fc3\u5316\u7684\u7279\u70b9\u3002\u6bcf\u4e00\u4e2apeer\uff0c\u5728\u533a\u5757\u94fe\u7684\u672f\u8bed\u91cc\uff0c\u662f\u4e00\u4e2a\u8282\u70b9\uff08node\uff09\uff0c\u80fd\u591f\u8bbf\u95ee\u533a\u5757\u94fe\u7684\u4fe1\u606f\u7b49\u3002 </p> <p> </p>"},{"location":"course/blockchain/basics/#_4","title":"\u900f\u660e\uff0c\u4f46\u662f\u5b89\u5168","text":"<p>\u56e0\u4e3a\u4e00\u4e2a\u533a\u5757\u94fe\u5bf9\u5e94\u7684\u8282\u70b9\u8bb0\u5f55\u7684\u5e94\u8be5\u662f\u4e00\u6837\u7684\u4fe1\u606f\uff0c\u800c\u53bb\u4e2d\u5fc3\u5316\u7684\u67b6\u6784\u4f7f\u5f97\u5927\u4f19\u90fd\u80fd\u8bbf\u95ee\u8282\u70b9\uff0c\u6240\u4ee5\u6240\u6709\u4ea4\u6613\u90fd\u662f\u80fd\u88ab\u5927\u4f19\u770b\u5230\u7684\u3002 </p> <p>\u4f46\u662f\u7531\u4e8e\u533a\u5757\u94fe\u8bb0\u5f55\u7684\u662f\u52a0\u5bc6\u540e\u7684\u4fe1\u606f\uff0c\u6240\u4ee5\u9664\u4e86\u7b7e\u53d1\u7684\u4eba\u77e5\u9053\uff0c\u5176\u4ed6\u4eba\u662f\u4e0d\u77e5\u9053\u7684\uff0c\u5f88\u5b89\u5168\u3002  </p>"},{"location":"course/blockchain/basics/#_5","title":"\u4e0d\u53ef\u7be1\u6539","text":"<p>\u4ea4\u6613\u9a8c\u8bc1\u540e\uff0c\u533a\u5757\u4fe1\u606f\u4e00\u65e6\u5199\u5165\u94fe\uff0c\u5c31\u51e0\u4e4e\u4e0d\u53ef\u7be1\u6539\uff0c\u56e0\u4e3a\u8981\u7be1\u6539\u5c31\u8981\u52a8\u5f88\u591a\u53f0\u7535\u8111\u7684\u533a\u5757\u94fehash\u503c\u3002\u79c1\u6709\u94fe\u5012\u662f\u6709\u53ef\u80fd\u6539\u3002</p>"},{"location":"course/blockchain/basics/#_6","title":"\u533a\u5757\u94fe\u5904\u7406\u4ea4\u6613","text":"<p>\u6700\u5148\u9a8c\u8bc1\u4ea4\u6613\u5408\u7406\u5e76\u4e14\u80fd\u5199\u5757\u5165\u94fe\u7684\u77ff\u5de5\u4f1a\u83b7\u5f97\u6bd4\u7279\u5e01\u5956\u52b1\u3002  </p> <p> </p>"},{"location":"course/blockchain/basics/#_7","title":"\u4f7f\u7528","text":"<p>\u9664\u4e86\u6570\u5b57\u8d27\u5e01\uff0c\u4e00\u4e9b\u4f01\u4e1a\u751a\u81f3\u5728\u7528\u52a0\u5bc6\u8d27\u5e01\uff0c\u4ee5\u745e\u5e78\u4e3a\u4f8b\uff1a  </p> <p> </p>"},{"location":"course/oslab/mylab1/","title":"\u75db\u82e6\uff0c\u4e3a\u4ec0\u4e48\u8981\u6298\u78e8\u4e00\u4e2a\u53ea\u4e0a\u8fc7\u8ba1\u539f\u7684\u8f6f\u5de5\u5b66\u5b50","text":""},{"location":"course/oslab/mylab1/#_2","title":"\u75db\u82e6\uff0c\u4e3a\u4ec0\u4e48\u8981\u6298\u78e8\u4e00\u4e2a\u53ea\u4e0a\u8fc7\u8ba1\u539f\u7684\u8f6f\u5de5\u5b66\u5b50","text":""},{"location":"course/oslab/oslab0/","title":"Lab 0: GDB &amp; QEMU \u8c03\u8bd5 64 \u4f4d RISC-V LINUX","text":""},{"location":"course/oslab/oslab0/#1","title":"1 \u5b9e\u9a8c\u76ee\u7684","text":"<ul> <li>\u4f7f\u7528\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177, \u5b8c\u6210Linux\u5185\u6838\u4ee3\u7801\u7f16\u8bd1</li> <li>\u4f7f\u7528QEMU\u8fd0\u884c\u5185\u6838</li> <li>\u719f\u6089GDB\u548cQEMU\u8054\u5408\u8c03\u8bd5</li> </ul>"},{"location":"course/oslab/oslab0/#2","title":"2 \u5b9e\u9a8c\u73af\u5883","text":"<ul> <li>Ubuntu 22.04.3 LTS</li> <li>Ubuntu 22.04.2 LTS Windows Subsystem for Linux 2</li> <li>Mac with Apple Silicon</li> <li>\u5176\u4ed6\u53ef\u884c\u7684\u5e73\u53f0\uff0c\u4f46\u6211\u4eec\u4e0d\u63d0\u4f9b\u6280\u672f\u652f\u6301</li> </ul>"},{"location":"course/oslab/oslab0/#3","title":"3 \u5b9e\u9a8c\u57fa\u7840\u77e5\u8bc6\u4ecb\u7ecd","text":""},{"location":"course/oslab/oslab0/#31-linux","title":"3.1 Linux \u4f7f\u7528\u57fa\u7840","text":"<p>\u5728 Linux \u73af\u5883\u4e0b\uff0c\u4eba\u4eec\u901a\u5e38\u4f7f\u7528\u547d\u4ee4\u884c\u63a5\u53e3\u6765\u5b8c\u6210\u4e0e\u8ba1\u7b97\u673a\u7684\u4ea4\u4e92\u3002\u7ec8\u7aef\uff08Terminal\uff09\u662f\u7528\u4e8e\u5904\u7406\u8be5\u8fc7\u7a0b\u7684\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\uff0c\u901a\u8fc7\u7ec8\u7aef\u4f60\u53ef\u4ee5\u8fd0\u884c\u5404\u79cd\u7a0b\u5e8f\u4ee5\u53ca\u5728\u81ea\u5df1\u7684\u8ba1\u7b97\u673a\u4e0a\u5904\u7406\u6587\u4ef6\u3002\u5728\u7c7b Unix \u7684\u64cd\u4f5c\u7cfb\u7edf\u4e0a\uff0c\u7ec8\u7aef\u53ef\u4ee5\u4e3a\u4f60\u5b8c\u6210\u4e00\u5207\u4f60\u6240\u9700\u8981\u7684\u64cd\u4f5c\u3002\u4e0b\u9762\u6211\u4eec\u4ec5\u5bf9\u5b9e\u9a8c\u4e2d\u6d89\u53ca\u7684\u4e00\u4e9b\u6982\u5ff5\u8fdb\u884c\u4ecb\u7ecd\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u94fe\u63a5\u6765\u5bf9\u547d\u4ee4\u884c\u7684\u4f7f\u7528\u8fdb\u884c\u5b66\u4e60\uff1a</p> <ol> <li>The Missing Semester of Your CS Education&gt;&gt;Video&lt;&lt;</li> <li>GNU/Linux Command-Line Tools Summary</li> <li>Basics of UNIX</li> </ol>"},{"location":"course/oslab/oslab0/#32-qemu","title":"3.2 QEMU \u4f7f\u7528\u57fa\u7840","text":""},{"location":"course/oslab/oslab0/#qemu","title":"\u4ec0\u4e48\u662fQEMU","text":"<p>QEMU \u662f\u4e00\u4e2a\u529f\u80fd\u5f3a\u5927\u7684\u6a21\u62df\u5668\uff0c\u53ef\u4ee5\u5728 x86 \u5e73\u53f0\u4e0a\u6267\u884c\u4e0d\u540c\u67b6\u6784\u4e0b\u7684\u7a0b\u5e8f\u3002\u6211\u4eec\u5b9e\u9a8c\u4e2d\u91c7\u7528 QEMU \u6765\u5b8c\u6210 RISC-V \u67b6\u6784\u7684\u7a0b\u5e8f\u7684\u6a21\u62df\u3002</p>"},{"location":"course/oslab/oslab0/#qemu_1","title":"\u5982\u4f55\u4f7f\u7528 QEMU\uff08\u5e38\u89c1\u53c2\u6570\u4ecb\u7ecd\uff09","text":"<p>\u4ee5\u4ee5\u4e0b\u547d\u4ee4\u4e3a\u4f8b\uff0c\u6211\u4eec\u7b80\u5355\u4ecb\u7ecd QEMU \u7684\u53c2\u6570\u6240\u4ee3\u8868\u7684\u542b\u4e49</p> <pre><code>$ qemu-system-riscv64 \\\n    -nographic \\\n    -machine virt \\\n    -kernel path/to/linux/arch/riscv/boot/Image \\\n    -device virtio-blk-device,drive=hd0 \\\n    -append \"root=/dev/vda ro console=ttyS0\" \\\n    -bios default \\\n    -drive file=rootfs.img,format=raw,id=hd0 \\\n    -S -s\n</code></pre> <ul> <li><code>-nographic</code>: \u4e0d\u4f7f\u7528\u56fe\u5f62\u7a97\u53e3\uff0c\u4f7f\u7528\u547d\u4ee4\u884c</li> <li><code>-machine</code>: \u6307\u5b9a\u8981 emulate \u7684\u673a\u5668\uff0c\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4 <code>qemu-system-riscv64 -machine help</code> \u67e5\u770b\u53ef\u9009\u62e9\u7684\u673a\u5668\u9009\u9879</li> <li><code>-kernel</code>: \u6307\u5b9a\u5185\u6838 image</li> <li><code>-append cmdline</code>: \u4f7f\u7528cmdline\u4f5c\u4e3a\u5185\u6838\u7684\u547d\u4ee4\u884c</li> <li><code>-device</code>: \u6307\u5b9a\u8981\u6a21\u62df\u7684\u8bbe\u5907\uff0c\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4 <code>qemu-system-riscv64 -device help</code> \u67e5\u770b\u53ef\u9009\u62e9\u7684\u8bbe\u5907\uff0c\u901a\u8fc7\u547d\u4ee4 <code>qemu-system-riscv64 -device &lt;\u5177\u4f53\u7684\u8bbe\u5907&gt;,help</code> \u67e5\u770b\u67d0\u4e2a\u8bbe\u5907\u7684\u547d\u4ee4\u9009\u9879</li> <li><code>-drive, file=&lt;file_name&gt;</code>: \u4f7f\u7528 <code>file_name</code> \u4f5c\u4e3a\u6587\u4ef6\u7cfb\u7edf</li> <li><code>-S</code>: \u542f\u52a8\u65f6\u6682\u505cCPU\u6267\u884c</li> <li><code>-s</code>: <code>-gdb tcp::1234</code> \u7684\u7b80\u5199</li> <li><code>-bios default</code>: \u4f7f\u7528\u9ed8\u8ba4\u7684 OpenSBI firmware \u4f5c\u4e3a bootloader</li> </ul> <p>\u66f4\u591a\u53c2\u6570\u4fe1\u606f\u53ef\u4ee5\u53c2\u8003\u8fd9\u91cc</p>"},{"location":"course/oslab/oslab0/#33-gdb","title":"3.3 GDB \u4f7f\u7528\u57fa\u7840","text":""},{"location":"course/oslab/oslab0/#gdb","title":"\u4ec0\u4e48\u662f GDB","text":"<p>GNU \u8c03\u8bd5\u5668\uff08\u82f1\u8bed\uff1aGNU Debugger\uff0c\u7f29\u5199\uff1agdb\uff09\u662f\u4e00\u4e2a\u7531 GNU \u5f00\u6e90\u7ec4\u7ec7\u53d1\u5e03\u7684\u3001UNIX/LINUX \u64cd\u4f5c\u7cfb\u7edf\u4e0b\u7684\u3001\u57fa\u4e8e\u547d\u4ee4\u884c\u7684\u3001\u529f\u80fd\u5f3a\u5927\u7684\u7a0b\u5e8f\u8c03\u8bd5\u5de5\u5177\u3002\u501f\u52a9\u8c03\u8bd5\u5668\uff0c\u6211\u4eec\u80fd\u591f\u67e5\u770b\u53e6\u4e00\u4e2a\u7a0b\u5e8f\u5728\u6267\u884c\u65f6\u5b9e\u9645\u5728\u505a\u4ec0\u4e48\uff08\u6bd4\u5982\u8bbf\u95ee\u54ea\u4e9b\u5185\u5b58\u3001\u5bc4\u5b58\u5668\uff09\uff0c\u5728\u5176\u4ed6\u7a0b\u5e8f\u5d29\u6e83\u7684\u65f6\u5019\u53ef\u4ee5\u6bd4\u8f83\u5feb\u901f\u5730\u4e86\u89e3\u5bfc\u81f4\u7a0b\u5e8f\u5d29\u6e83\u7684\u539f\u56e0\u3002 \u88ab\u8c03\u8bd5\u7684\u7a0b\u5e8f\u53ef\u4ee5\u548c GDB \u8fd0\u884c\u5728\u540c\u4e00\u53f0\u673a\u5668\u4e0a\uff0c\u5e76\u7531 GDB \u63a7\u5236\uff08\u672c\u5730\u8c03\u8bd5 native debug\uff09\u3002\u4e5f\u53ef\u4ee5\u53ea\u548c <code>gdb-server</code> \u8fd0\u884c\u5728\u540c\u4e00\u53f0\u673a\u5668\u4e0a\uff0c\u7531\u8fde\u63a5\u7740 <code>gdb-server</code> \u7684 GDB \u8fdb\u884c\u63a7\u5236\uff08\u8fdc\u7a0b\u8c03\u8bd5 remote debug\uff09\u3002</p> <p>GDB \u7684\u529f\u80fd\u5341\u5206\u5f3a\u5927\uff0c\u6211\u4eec\u7ecf\u5e38\u5728\u8c03\u8bd5\u4e2d\u7528\u5230\u7684\u6709:</p> <ul> <li>\u542f\u52a8\u7a0b\u5e8f\uff0c\u5e76\u6307\u5b9a\u53ef\u80fd\u5f71\u54cd\u5176\u884c\u4e3a\u7684\u6240\u6709\u5185\u5bb9</li> <li>\u4f7f\u7a0b\u5e8f\u5728\u6307\u5b9a\u6761\u4ef6\u4e0b\u505c\u6b62</li> <li>\u68c0\u67e5\u7a0b\u5e8f\u505c\u6b62\u65f6\u53d1\u751f\u4e86\u4ec0\u4e48</li> <li>\u66f4\u6539\u7a0b\u5e8f\u4e2d\u7684\u5185\u5bb9\uff0c\u4ee5\u4fbf\u7ea0\u6b63\u4e00\u4e2abug\u7684\u5f71\u54cd</li> </ul>"},{"location":"course/oslab/oslab0/#gdb_1","title":"GDB \u57fa\u672c\u547d\u4ee4\u4ecb\u7ecd","text":"<ul> <li><code>(gdb) layout asm</code>: \u663e\u793a\u6c47\u7f16\u4ee3\u7801</li> <li><code>(gdb) start</code>: \u5355\u6b65\u6267\u884c\uff0c\u8fd0\u884c\u7a0b\u5e8f\uff0c\u505c\u5728\u7b2c\u4e00\u6267\u884c\u8bed\u53e5</li> <li><code>(gdb) continue</code>: \u4ece\u65ad\u70b9\u540e\u7ee7\u7eed\u6267\u884c\uff0c\u7b80\u5199 <code>c</code></li> <li><code>(gdb) next</code>: \u5355\u6b65\u8c03\u8bd5\uff08\u9010\u8fc7\u7a0b\uff0c\u51fd\u6570\u76f4\u63a5\u6267\u884c\uff09\uff0c\u7b80\u5199 <code>n</code></li> <li><code>(gdb) step instruction</code>: \u6267\u884c\u5355\u6761\u6307\u4ee4\uff0c\u7b80\u5199 <code>si</code></li> <li><code>(gdb) run</code>: \u91cd\u65b0\u5f00\u59cb\u8fd0\u884c\u6587\u4ef6\uff08run-text\uff1a\u52a0\u8f7d\u6587\u672c\u6587\u4ef6\uff0crun-bin\uff1a\u52a0\u8f7d\u4e8c\u8fdb\u5236\u6587\u4ef6\uff09\uff0c\u7b80\u5199 <code>r</code></li> <li><code>(gdb) backtrace</code>\uff1a\u67e5\u770b\u51fd\u6570\u7684\u8c03\u7528\u7684\u6808\u5e27\u548c\u5c42\u7ea7\u5173\u7cfb\uff0c\u7b80\u5199 <code>bt</code></li> <li><code>(gdb) break</code> \u8bbe\u7f6e\u65ad\u70b9\uff0c\u7b80\u5199 <code>b</code></li> <li>\u65ad\u5728 <code>foo</code> \u51fd\u6570\uff1a<code>b foo</code></li> <li>\u65ad\u5728\u67d0\u5730\u5740: <code>b * 0x80200000</code></li> <li><code>(gdb) finish</code>: \u7ed3\u675f\u5f53\u524d\u51fd\u6570\uff0c\u8fd4\u56de\u5230\u51fd\u6570\u8c03\u7528\u70b9</li> <li><code>(gdb) frame</code>: \u5207\u6362\u51fd\u6570\u7684\u6808\u5e27\uff0c\u7b80\u5199 <code>f</code></li> <li><code>(gdb) print</code>: \u6253\u5370\u503c\u53ca\u5730\u5740\uff0c\u7b80\u5199 <code>p</code></li> <li><code>(gdb) info</code>: \u67e5\u770b\u51fd\u6570\u5185\u90e8\u5c40\u90e8\u53d8\u91cf\u7684\u6570\u503c\uff0c\u7b80\u5199 <code>i</code></li> <li>\u67e5\u770b\u5bc4\u5b58\u5668 ra \u7684\u503c: <code>i r ra</code></li> <li><code>(gdb) display</code>: \u8ffd\u8e2a\u67e5\u770b\u5177\u4f53\u53d8\u91cf\u503c</li> <li><code>(gdb) x/4x &lt;addr&gt;</code>: \u4ee5 16 \u8fdb\u5236\u6253\u5370 <code>&lt;addr&gt;</code> \u5904\u5f00\u59cb\u7684 16 Bytes \u5185\u5bb9</li> </ul> <p>\u66f4\u591a\u547d\u4ee4\u53ef\u4ee5\u53c2\u8003100\u4e2agdb\u5c0f\u6280\u5de7</p>"},{"location":"course/oslab/oslab0/#34-linux","title":"3.4 Linux \u5185\u6838\u7f16\u8bd1\u57fa\u7840","text":""},{"location":"course/oslab/oslab0/#_1","title":"\u4ea4\u53c9\u7f16\u8bd1","text":"<p>\u4ea4\u53c9\u7f16\u8bd1\u6307\u7684\u662f\u5728\u4e00\u4e2a\u5e73\u53f0\u4e0a\u7f16\u8bd1\u53ef\u4ee5\u5728\u53e6\u4e00\u4e2a\u67b6\u6784\u8fd0\u884c\u7684\u7a0b\u5e8f\u3002\u4f8b\u5982\u5728 x86 \u673a\u5668\u4e0a\u7f16\u8bd1\u53ef\u4ee5\u5728 RISC-V \u67b6\u6784\u8fd0\u884c\u7684\u7a0b\u5e8f\uff0c\u4ea4\u53c9\u7f16\u8bd1\u9700\u8981\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\u7684\u652f\u6301\uff0c\u5728\u6211\u4eec\u7684\u5b9e\u9a8c\u4e2d\u6240\u7528\u7684\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\u5c31\u662f <code>riscv-gnu-toolchain</code>\u3002</p>"},{"location":"course/oslab/oslab0/#_2","title":"\u5185\u6838\u914d\u7f6e","text":"<p>\u5185\u6838\u914d\u7f6e\u662f\u7528\u4e8e\u914d\u7f6e\u662f\u5426\u542f\u7528\u5185\u6838\u7684\u5404\u9879\u7279\u6027\uff0c\u5185\u6838\u4f1a\u63d0\u4f9b\u4e00\u4e2a\u540d\u4e3a <code>defconfig</code> (\u5373default configuration) \u7684\u9ed8\u8ba4\u914d\u7f6e\uff0c\u8be5\u914d\u7f6e\u6587\u4ef6\u4f4d\u4e8e\u5404\u4e2a\u67b6\u6784\u76ee\u5f55\u7684 <code>configs</code> \u6587\u4ef6\u5939\u4e0b\uff0c\u4f8b\u5982\u5bf9\u4e8eRISC-V\u800c\u8a00\uff0c\u5176\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\u4e3a <code>arch/riscv/configs/defconfig</code>\u3002\u4f7f\u7528 <code>make ARCH=riscv defconfig</code> \u547d\u4ee4\u53ef\u4ee5\u5728\u5185\u6838\u6839\u76ee\u5f55\u4e0b\u751f\u6210\u4e00\u4e2a\u540d\u4e3a <code>.config</code> \u7684\u6587\u4ef6\uff0c\u5305\u542b\u4e86\u5185\u6838\u5b8c\u6574\u7684\u914d\u7f6e\uff0c\u5185\u6838\u5728\u7f16\u8bd1\u65f6\u4f1a\u6839\u636e <code>.config</code> \u8fdb\u884c\u7f16\u8bd1\u3002</p> <p>\u914d\u7f6e\u4e4b\u95f4\u5b58\u5728\u76f8\u4e92\u7684\u4f9d\u8d56\u5173\u7cfb\uff0c\u76f4\u63a5\u4fee\u6539defconfig\u6587\u4ef6\u6216\u8005 <code>.config</code> \u6709\u65f6\u5019\u5e76\u4e0d\u80fd\u8fbe\u5230\u60f3\u8981\u7684\u6548\u679c\uff0c\u6216\u662f\u7ed9\u8fdb\u4e00\u6b65\u5185\u6838\u914d\u7f6e\u5e26\u6765\u540c\u6b65\u95ee\u9898\u3002\u56e0\u6b64\u5982\u679c\u9700\u8981\u4fee\u6539\u914d\u7f6e\u4e00\u822c\u91c7\u7528 <code>make ARCH=riscv menuconfig</code> \u7684\u65b9\u5f0f\u5bf9\u5185\u6838\u8fdb\u884c\u914d\u7f6e\u3002</p>"},{"location":"course/oslab/oslab0/#_3","title":"\u7f16\u8bd1\u5de5\u5177","text":"<p><code>make</code> \u662f\u7528\u4e8e\u7a0b\u5e8f\u6784\u5efa\u7684\u91cd\u8981\u5de5\u5177\uff0c\u5b83\u7684\u884c\u4e3a\u7531\u5f53\u524d\u76ee\u5f55\u6216 <code>make -C</code> \u6307\u5b9a\u76ee\u5f55\u4e0b\u7684 <code>Makefile</code> \u6765\u51b3\u5b9a\u3002\u66f4\u591a\u6709\u5173 <code>Makefile</code> \u7684\u5185\u5bb9\u53ef\u4ee5\u53c2\u8003 Learn Makefiles With the tastiest examples\u3002\u4e0b\u9762\u7528\u672c\u6b21\u5b9e\u9a8c\u4e2d\u53ef\u80fd\u7528\u5230\u7684\u7528\u4e8e\u7f16\u8bd1 Linux \u5185\u6838\u7684\u7f16\u8bd1\u547d\u4ee4\u4f5c\u4e3a\u793a\u4f8b\uff1a</p> <pre><code>$ make help             # \u67e5\u770bmake\u547d\u4ee4\u7684\u5404\u79cd\u53c2\u6570\u89e3\u91ca\n\n$ make &lt;target-name&gt;    # \u7f16\u8bd1\u540d\u4e3a &lt;target-name&gt; \u7684\u76ee\u6807\u6587\u4ef6\u6216\u76ee\u6807\u4efb\u52a1 \n$ make defconfig        # \u4f7f\u7528\u5f53\u524d\u5e73\u53f0\u7684\u9ed8\u8ba4\u914d\u7f6e\uff0c\u5728x86\u673a\u5668\u4e0a\u4f1a\u4f7f\u7528x86\u7684\u9ed8\u8ba4\u914d\u7f6e\n$ make clean            # \u6e05\u9664\u6240\u6709\u7f16\u8bd1\u597d\u7684 object \u6587\u4ef6\n$ make mrproper         # \u5220\u9664\u6240\u6709\u7f16\u8bd1\u4ea7\u7269\u548c\u914d\u7f6e\u6587\u4ef6\n\n$ make -j&lt;thread-count&gt; # \u4f7f\u7528 &lt;thread-count&gt; \u4e2a\u7269\u7406\u7ebf\u7a0b\u6765\u8fdb\u884c\u591a\u7ebf\u7a0b\u7f16\u8bd1 \n$ make -j4              # \u7f16\u8bd1\u5f53\u524d\u5e73\u53f0\u7684\u5185\u6838\uff0c-j4 \u4e3a\u4f7f\u7528 4 \u7ebf\u7a0b\u8fdb\u884c\u591a\u7ebf\u7a0b\u7f16\u8bd1\n$ make -j$(nproc)       # \u7f16\u8bd1\u5f53\u524d\u5e73\u53f0\u7684\u5185\u6838\uff0c-j$(nproc) \u4e3a\u4ee5\u5168\u90e8\u673a\u5668\u786c\u4ef6\u7ebf\u7a0b\u6570\u8fdb\u884c\u591a\u7ebf\u7a0b\u7f16\u8bd1\n\n$ make &lt;var-name&gt;=&lt;var-value&gt;                       # \u5728\u7f16\u8bd1\u8fc7\u7a0b\u4e2d\u5c06 &lt;var-name&gt; \u53d8\u91cf\u7684\u503c\u624b\u52a8\u8bbe\u7f6e\u4e3a &lt;val-value&gt;\n$ make ARCH=riscv defconfig                         # \u4f7f\u7528 RISC-V \u5e73\u53f0\u7684\u9ed8\u8ba4\u914d\u7f6e\n$ make ARCH=riscv CROSS_COMPILE=riscv64-linux-gnu-  # \u7f16\u8bd1 RISC-V \u5e73\u53f0\u5185\u6838\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u624b\u52a8\u4e3a <code>make</code> \u6307\u5b9a\u53d8\u91cf\u7684\u503c\uff0c\u672c\u6b21\u5b9e\u9a8c\u4e2d\u7528\u5230\u7684\u5982\u4e0b\uff1a</p> <ul> <li><code>ARCH</code> \u6307\u5b9a\u67b6\u6784\uff0c\u53ef\u9009\u7684\u503c\u5305\u62ec arch \u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\u5939\u540d\uff0c\u5982 x86\u3001arm\u3001arm64 \u7b49\uff0c\u4e0d\u540c\u4e8e arm \u548c arm64\uff0c32 \u4f4d\u548c 64 \u4f4d\u7684RISC-V\u5171\u7528 <code>arch/riscv</code> \u76ee\u5f55\uff0c\u901a\u8fc7\u4f7f\u7528\u4e0d\u540c\u7684 config \u53ef\u4ee5\u7f16\u8bd1 32 \u4f4d\u6216 64 \u4f4d\u7684\u5185\u6838\u3002</li> <li><code>CROSS_COMPILE</code> \u6307\u5b9a\u4f7f\u7528\u7684\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\uff0c\u4f8b\u5982\u6307\u5b9a <code>CROSS_COMPILE=riscv64-linux-gnu-</code>\uff0c\u5219\u7f16\u8bd1\u65f6\u4f1a\u91c7\u7528 <code>riscv64-linux-gnu-gcc</code> \u4f5c\u4e3a\u7f16\u8bd1\u5668\uff0c\u7f16\u8bd1\u5728 RISC-V 64 \u4f4d\u5e73\u53f0\u4e0a\u8fd0\u884c\u7684 Linux \u5185\u6838\u3002</li> </ul>"},{"location":"course/oslab/oslab0/#4","title":"4 \u5b9e\u9a8c\u6b65\u9aa4","text":"<p>\u5728\u6267\u884c\u6bcf\u4e00\u6761\u547d\u4ee4\u524d\uff0c\u8bf7\u4f60\u5bf9\u5c06\u8981\u8fdb\u884c\u7684\u64cd\u4f5c\u8fdb\u884c\u601d\u8003\uff0c\u7ed9\u51fa\u7684\u547d\u4ee4\u4e0d\u9700\u8981\u5168\u90e8\u6267\u884c\uff0c\u5e76\u4e14\u4e0d\u662f\u6240\u6709\u7684\u547d\u4ee4\u90fd\u53ef\u4ee5\u65e0\u6761\u4ef6\u6267\u884c\uff0c\u8bf7\u4e0d\u8981\u76f4\u63a5\u590d\u5236\u7c98\u8d34\u547d\u4ee4\u53bb\u6267\u884c\u3002</p>"},{"location":"course/oslab/oslab0/#41","title":"4.1 \u642d\u5efa\u5b9e\u9a8c\u73af\u5883\u73af\u5883","text":"<p>\u5982\u679c\u4f60\u5728\u4f7f\u7528 Mac with Apple Silicon, \u8bf7\u76f4\u63a5\u4f7f\u7528 Docker Desktop \u8fdb\u884c\u8bfe\u7a0b\u5b9e\u9a8c\u3002 Docker Desktop \u7684\u5b89\u88c5\u53ef\u4ee5\u53c2\u8003 Docker Desktop for Apple silicon\u3002 \u4e4b\u540e\u4f7f\u7528 <code>docker pull ubuntu:22.04 &amp;&amp; docker run -it --name &lt;some-name&gt; ubuntu:22.04 bash</code> \u6765\u542f\u52a8\u4e00\u4e2a\u8fd0\u884c\u5728\u865a\u62df\u673a\u4e0a\u7684 Ubuntu for ARM \u5bb9\u5668\uff0c\u5e76\u5c06\u8fd9\u4e2a Ubuntu \u4f5c\u4e3a\u5b9e\u9a8c\u73af\u5883\u3002</p> <p>\u9996\u5148\u5b89\u88c5\u7f16\u8bd1\u5185\u6838\u6240\u9700\u8981\u7684\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\u548c\u7528\u4e8e\u6784\u5efa\u7a0b\u5e8f\u7684\u8f6f\u4ef6\u5305</p> <pre><code>$ sudo apt install  gcc-riscv64-linux-gnu\n$ sudo apt install  autoconf automake autotools-dev curl libmpc-dev libmpfr-dev libgmp-dev \\\n                    gawk build-essential bison flex texinfo gperf libtool patchutils bc \\\n                    zlib1g-dev libexpat-dev git\n</code></pre> <p>\u63a5\u7740\u662f\u7528\u4e8e\u542f\u52a8 riscv64 \u5e73\u53f0\u4e0a\u7684\u5185\u6838\u7684\u6a21\u62df\u5668 <code>qemu</code></p> <pre><code>$ sudo apt install qemu-system-misc\n</code></pre> <p>\u6211\u4eec\u8fd8\u9700\u8981\u7528 <code>gdb</code> \u6765\u5bf9\u5728 <code>qemu</code> \u4e0a\u8fd0\u884c\u7684 Linux \u5185\u6838\u8fdb\u884c\u8c03\u8bd5</p> <pre><code>$ sudo apt install gdb-multiarch\n</code></pre>"},{"location":"course/oslab/oslab0/#42-linux","title":"4.2 \u83b7\u53d6 Linux \u6e90\u7801\u548c\u5df2\u7ecf\u7f16\u8bd1\u597d\u7684\u6587\u4ef6\u7cfb\u7edf","text":"<p>\u4ece https://www.kernel.org \u4e0b\u8f7d\u6700\u65b0\u7684 Linux \u6e90\u7801\u3002</p> <p>\u622a\u81f3\u5199\u4f5c\u65f6\uff0c\u6700\u65b0\u7684 Linux \u5185\u6838\u7248\u672c\u662f 6.6-rc1.</p> <p>\u5e76\u4e14\u4f7f\u7528 git \u5de5\u5177 clone \u672c\u4ed3\u5e93\u3002\u5176\u4e2d\u5df2\u7ecf\u51c6\u5907\u597d\u4e86\u6839\u6587\u4ef6\u7cfb\u7edf\u7684\u955c\u50cf\u3002</p> <p>\u6839\u6587\u4ef6\u7cfb\u7edf\u4e3a Linux Kernel \u63d0\u4f9b\u4e86\u57fa\u7840\u7684\u6587\u4ef6\u670d\u52a1\uff0c\u5728\u542f\u52a8 Linux Kernel \u65f6\u662f\u5fc5\u8981\u7684\u3002</p> <pre><code>$ git clone https://gitee.com/zju_xiayingjie/os23fall-stu.git\n$ cd os23fall-stu/src/lab0\n$ ls\nrootfs.img  # \u5df2\u7ecf\u6784\u5efa\u5b8c\u6210\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u7684\u955c\u50cf\n</code></pre>"},{"location":"course/oslab/oslab0/#43-linux","title":"4.3 \u7f16\u8bd1 linux \u5185\u6838","text":"<pre><code>$ cd path/to/linux\n$ make ARCH=riscv CROSS_COMPILE=riscv64-linux-gnu- defconfig    # \u4f7f\u7528\u9ed8\u8ba4\u914d\u7f6e\n$ make ARCH=riscv CROSS_COMPILE=riscv64-linux-gnu- -j$(nproc)   # \u7f16\u8bd1\n</code></pre> <p>\u4f7f\u7528\u591a\u7ebf\u7a0b\u7f16\u8bd1\u4e00\u822c\u4f1a\u8017\u8d39\u5927\u91cf\u5185\u5b58\uff0c\u5982\u679c <code>-j</code> \u9009\u9879\u5bfc\u81f4\u5185\u5b58\u8017\u5c3d (out of memory)\uff0c\u8bf7\u5c1d\u8bd5\u8c03\u4f4e\u7ebf\u7a0b\u6570\uff0c\u6bd4\u5982 <code>-j4</code>, <code>-j8</code> \u7b49\u3002</p>"},{"location":"course/oslab/oslab0/#44-qemu","title":"4.4 \u4f7f\u7528QEMU\u8fd0\u884c\u5185\u6838","text":"<pre><code>$ qemu-system-riscv64 -nographic -machine virt -kernel path/to/linux/arch/riscv/boot/Image \\\n    -device virtio-blk-device,drive=hd0 -append \"root=/dev/vda ro console=ttyS0\" \\\n    -bios default -drive file=path/to/rootfs.img,format=raw,id=hd0\n</code></pre> <p>\u9000\u51fa QEMU \u7684\u65b9\u6cd5\u4e3a\uff1a\u4f7f\u7528 Ctrl+A\uff0c**\u677e\u5f00**\u540e\u518d\u6309\u4e0b X \u952e\u5373\u53ef\u9000\u51fa QEMU\u3002</p>"},{"location":"course/oslab/oslab0/#45-gdb","title":"4.5 \u4f7f\u7528 GDB \u5bf9\u5185\u6838\u8fdb\u884c\u8c03\u8bd5","text":"<p>\u8fd9\u4e00\u6b65\u9700\u8981\u5f00\u542f\u4e24\u4e2a Terminal Session\uff0c\u4e00\u4e2a Terminal \u4f7f\u7528 QEMU \u542f\u52a8 Linux\uff0c\u53e6\u4e00\u4e2a Terminal \u4f7f\u7528 GDB \u4e0e QEMU \u8fdc\u7a0b\u901a\u4fe1\uff08\u4f7f\u7528 tcp::1234 \u7aef\u53e3\uff09\u8fdb\u884c\u8c03\u8bd5\u3002</p> <pre><code># Terminal 1\n$ qemu-system-riscv64 -nographic -machine virt -kernel path/to/linux/arch/riscv/boot/Image \\\n    -device virtio-blk-device,drive=hd0 -append \"root=/dev/vda ro console=ttyS0\" \\\n    -bios default -drive file=path/to/rootfs.img,format=raw,id=hd0 -S -s\n\n# Terminal 2\n$ gdb-multiarch path/to/linux/vmlinux\n(gdb) target remote :1234   # \u8fde\u63a5 qemu\n(gdb) b start_kernel        # \u8bbe\u7f6e\u65ad\u70b9\n(gdb) continue              # \u7ee7\u7eed\u6267\u884c\n(gdb) quit                  # \u9000\u51fa gdb\n</code></pre>"},{"location":"course/oslab/oslab0/#5","title":"5 \u5b9e\u9a8c\u4efb\u52a1\u4e0e\u8981\u6c42","text":"<ul> <li>\u8bf7\u5404\u4f4d\u540c\u5b66\u72ec\u7acb\u5b8c\u6210\u4f5c\u4e1a\uff0c\u4efb\u4f55\u6284\u88ad\u884c\u4e3a\u90fd\u5c06\u4f7f\u672c\u6b21\u4f5c\u4e1a\u5224\u4e3a0\u5206\u3002</li> <li>\u7f16\u8bd1\u5185\u6838\uff0c\u4f7f\u7528 QEMU \u542f\u52a8\u540e\uff0c\u8fdc\u7a0b\u8fde\u63a5 GDB \u8fdb\u884c\u8c03\u8bd5\uff0c\u5e76\u5c1d\u8bd5\u4f7f\u7528 GDB \u7684\u5404\u9879\u547d\u4ee4\uff08\u5982 <code>backtrace</code>, <code>finish</code>, <code>frame</code>, <code>info</code>, <code>break</code>, <code>display</code>, <code>next</code>, <code>layout</code> \u7b49\uff09\u3002</li> <li>\u5728\u5b66\u5728\u6d59\u5927\u4e2d\u63d0\u4ea4 pdf \u683c\u5f0f\u7684\u5b9e\u9a8c\u62a5\u544a\uff0c\u8bb0\u5f55\u5b9e\u9a8c\u8fc7\u7a0b\u5e76\u622a\u56fe\uff084.1-4.4\uff09\uff0c\u5bf9\u6bcf\u4e00\u6b65\u7684\u547d\u4ee4\u4ee5\u53ca\u7ed3\u679c\u8fdb\u884c\u5fc5\u8981\u7684\u89e3\u91ca\uff0c\u8bb0\u5f55\u9047\u5230\u7684\u95ee\u9898\u548c\u5fc3\u5f97\u4f53\u4f1a\u3002</li> </ul>"},{"location":"course/oslab/oslab0/#_4","title":"\u601d\u8003\u9898","text":"<ol> <li>\u4f7f\u7528 <code>riscv64-linux-gnu-gcc</code> \u7f16\u8bd1\u5355\u4e2a <code>.c</code> \u6587\u4ef6</li> <li>\u4f7f\u7528 <code>riscv64-linux-gnu-objdump</code> \u53cd\u6c47\u7f16 1 \u4e2d\u5f97\u5230\u7684\u7f16\u8bd1\u4ea7\u7269</li> <li>\u8c03\u8bd5 Linux \u65f6:</li> <li>\u5728 GDB \u4e2d\u67e5\u770b\u6c47\u7f16\u4ee3\u7801</li> <li>\u5728 0x80000000 \u5904\u4e0b\u65ad\u70b9</li> <li>\u67e5\u770b\u6240\u6709\u5df2\u4e0b\u7684\u65ad\u70b9</li> <li>\u5728 0x80200000 \u5904\u4e0b\u65ad\u70b9</li> <li>\u6e05\u9664 0x80000000 \u5904\u7684\u65ad\u70b9</li> <li>\u7ee7\u7eed\u8fd0\u884c\u76f4\u5230\u89e6\u53d1 0x80200000 \u5904\u7684\u65ad\u70b9</li> <li>\u5355\u6b65\u8c03\u8bd5\u4e00\u6b21</li> <li>\u9000\u51fa QEMU</li> <li>\u4f7f\u7528 <code>make</code> \u5de5\u5177\u6e05\u9664 Linux \u7684\u6784\u5efa\u4ea7\u7269</li> <li><code>vmlinux</code> \u548c <code>Image</code> \u7684\u5173\u7cfb\u548c\u533a\u522b\u662f\u4ec0\u4e48\uff1f</li> </ol>"},{"location":"course/oslab/oslab1/","title":"Lab 1: RV64 \u5185\u6838\u5f15\u5bfc\u4e0e\u65f6\u949f\u4e2d\u65ad\u5904\u7406","text":""},{"location":"course/oslab/oslab1/#_1","title":"\u5b9e\u9a8c\u76ee\u7684","text":"<ul> <li>\u5b66\u4e60 RISC-V \u6c47\u7f16\uff0c \u7f16\u5199 head.S \u5b9e\u73b0\u8df3\u8f6c\u5230\u5185\u6838\u8fd0\u884c\u7684\u7b2c\u4e00\u4e2a C \u51fd\u6570\u3002</li> <li>\u5b66\u4e60 OpenSBI\uff0c\u7406\u89e3 OpenSBI \u5728\u5b9e\u9a8c\u4e2d\u6240\u8d77\u5230\u7684\u4f5c\u7528\uff0c\u5e76\u8c03\u7528 OpenSBI \u63d0\u4f9b\u7684\u63a5\u53e3\u5b8c\u6210\u5b57\u7b26\u7684\u8f93\u51fa\u3002</li> <li>\u5b66\u4e60 Makefile \u76f8\u5173\u77e5\u8bc6\uff0c \u8865\u5145\u9879\u76ee\u4e2d\u7684 Makefile \u6587\u4ef6\uff0c \u6765\u5b8c\u6210\u5bf9\u6574\u4e2a\u5de5\u7a0b\u7684\u7ba1\u7406\u3002</li> <li>\u5b66\u4e60 RISC-V \u7684 trap \u5904\u7406\u76f8\u5173\u5bc4\u5b58\u5668\u4e0e\u6307\u4ee4\uff0c\u5b8c\u6210\u5bf9 trap \u5904\u7406\u7684\u521d\u59cb\u5316\u3002</li> <li>\u7406\u89e3 CPU \u4e0a\u4e0b\u6587\u5207\u6362\u673a\u5236\uff0c\u5e76\u6b63\u786e\u5b9e\u73b0\u4e0a\u4e0b\u6587\u5207\u6362\u529f\u80fd\u3002</li> <li>\u7f16\u5199 trap \u5904\u7406\u51fd\u6570\uff0c\u5b8c\u6210\u5bf9\u7279\u5b9a trap \u7684\u5904\u7406\u3002</li> <li>\u8c03\u7528 OpenSBI \u63d0\u4f9b\u7684\u63a5\u53e3\uff0c\u5b8c\u6210\u5bf9\u65f6\u949f\u4e2d\u65ad\u4e8b\u4ef6\u7684\u8bbe\u7f6e\u3002</li> </ul>"},{"location":"course/oslab/oslab1/#_2","title":"\u5b9e\u9a8c\u73af\u5883","text":"<ul> <li>Environment in Lab0</li> </ul>"},{"location":"course/oslab/oslab1/#_3","title":"\u5b9e\u9a8c\u57fa\u7840\u77e5\u8bc6\u4ecb\u7ecd","text":""},{"location":"course/oslab/oslab1/#rv64","title":"RV64 \u5185\u6838\u5f15\u5bfc","text":""},{"location":"course/oslab/oslab1/#_4","title":"\u524d\u7f6e\u77e5\u8bc6","text":"<p>\u4e3a\u4e86\u987a\u5229\u5b8c\u6210 OS \u5b9e\u9a8c\uff0c\u6211\u4eec\u9700\u8981\u4e00\u4e9b\u524d\u7f6e\u77e5\u8bc6\u548c\u8f83\u591a\u8c03\u8bd5\u6280\u5de7\u3002\u5728 OS \u5b9e\u9a8c\u4e2d\u6211\u4eec\u9700\u8981 RISC-V\u6c47\u7f16 \u7684\u524d\u7f6e\u77e5\u8bc6\uff0c\u8bfe\u5802\u4e0a\u4e0d\u4f1a\u8bb2\u6388\uff0c\u8bf7\u540c\u5b66\u4eec\u901a\u8fc7\u9605\u8bfb\u4ee5\u4e0b\u56db\u4efd\u6587\u6863\u81ea\u5b66\uff1a</p> <ul> <li>RISC-V Assembly Programmer's Manual</li> <li>RISC-V Unprivileged Spec</li> <li>RISC-V Privileged Spec</li> <li>RISC-V \u624b\u518c\uff08\u4e2d\u6587\uff09</li> </ul> <p>\u6ce8\uff1aRISC-V \u624b\u518c\uff08\u4e2d\u6587\uff09\u4e2d\u6709\u4e00\u4e9b Typo\uff0c\u8bf7\u8c28\u614e\u53c2\u8003\u3002</p>"},{"location":"course/oslab/oslab1/#risc-v","title":"RISC-V \u7684\u4e09\u79cd\u7279\u6743\u6a21\u5f0f","text":"<p>RISC-V \u6709\u4e09\u4e2a\u7279\u6743\u6a21\u5f0f\uff1aU (user) \u6a21\u5f0f\u3001S (supervisor) \u6a21\u5f0f\u548c M (machine) \u6a21\u5f0f\u3002</p> Level Encoding Name Abbreviation 0 00 User/Application U 1 01 Supervisor S 2 10 Reserved 3 11 Machine M <p>\u5176\u4e2d\uff1a</p> <ul> <li>M \u6a21\u5f0f\u662f\u5bf9\u786c\u4ef6\u64cd\u4f5c\u7684\u62bd\u8c61\uff0c\u6709**\u6700\u9ad8**\u7ea7\u522b\u7684\u6743\u9650</li> <li>S \u6a21\u5f0f\u4ecb\u4e8e M \u6a21\u5f0f\u548c U \u6a21\u5f0f\u4e4b\u95f4\uff0c\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u5bf9\u5e94\u4e8e\u5185\u6838\u6001 (Kernel)\u3002\u5f53\u7528\u6237\u9700\u8981\u5185\u6838\u8d44\u6e90\u65f6\uff0c\u5411\u5185\u6838\u7533\u8bf7\uff0c\u5e76\u5207\u6362\u5230\u5185\u6838\u6001\u8fdb\u884c\u5904\u7406</li> <li>U \u6a21\u5f0f\u7528\u4e8e\u6267\u884c\u7528\u6237\u7a0b\u5e8f\uff0c\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u5bf9\u5e94\u4e8e\u7528\u6237\u6001\uff0c\u6709**\u6700\u4f4e**\u7ea7\u522b\u7684\u6743\u9650</li> </ul>"},{"location":"course/oslab/oslab1/#313-os","title":"3.1.3 \u4ece\u8ba1\u7b97\u673a\u4e0a\u7535\u5230 OS \u8fd0\u884c","text":"<p>\u6211\u4eec\u4ee5\u6700\u57fa\u7840\u7684\u5d4c\u5165\u5f0f\u7cfb\u7edf\u4e3a\u4f8b\uff0c\u8ba1\u7b97\u673a\u4e0a\u7535\u540e\uff0c\u9996\u5148\u786c\u4ef6\u8fdb\u884c\u4e00\u4e9b\u57fa\u7840\u7684\u521d\u59cb\u5316\u540e\uff0c\u5c06 CPU \u7684 Program Counter \u79fb\u52a8\u5230\u5185\u5b58\u4e2d Bootloader \u7684\u8d77\u59cb\u5730\u5740\u3002 Bootloader \u662f\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u8fd0\u884c\u4e4b\u524d\uff0c\u7528\u4e8e\u521d\u59cb\u5316\u786c\u4ef6\uff0c\u52a0\u8f7d\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u3002 \u5728 RISC-V \u67b6\u6784\u91cc\uff0cBootloader \u8fd0\u884c\u5728 M \u6a21\u5f0f\u4e0b\u3002Bootloader \u8fd0\u884c\u5b8c\u6bd5\u540e\u5c31\u4f1a\u628a\u5f53\u524d\u6a21\u5f0f\u5207\u6362\u5230 S \u6a21\u5f0f\u4e0b\uff0c\u673a\u5668\u968f\u540e\u5f00\u59cb\u8fd0\u884c Kernel\u3002</p> <p>\u8fd9\u4e2a\u8fc7\u7a0b\u7b80\u5355\u800c\u8a00\u5c31\u662f\u8fd9\u6837\uff1a</p> <pre><code>   Hardware             RISC-V M Mode           RISC-V S Mode \n+------------+         +--------------+         +----------+\n|  Power On  |  ----&gt;  |  Bootloader  |  ----&gt;  |  Kernel  |\n+------------+         +--------------+         +----------+\n</code></pre>"},{"location":"course/oslab/oslab1/#sbi-opensbi","title":"SBI \u4e0e OpenSBI","text":"<p>SBI (Supervisor Binary Interface) \u662f S-mode \u7684 Kernel \u548c M-mode \u6267\u884c\u73af\u5883\u4e4b\u95f4\u7684\u63a5\u53e3\u89c4\u8303\uff0c\u800c OpenSBI \u662f\u4e00\u4e2a RISC-V SBI \u89c4\u8303\u7684\u5f00\u6e90\u5b9e\u73b0\u3002RISC-V \u5e73\u53f0\u548c SoC \u4f9b\u5e94\u5546\u53ef\u4ee5\u81ea\u4e3b\u6269\u5c55 OpenSBI \u5b9e\u73b0\uff0c\u4ee5\u9002\u5e94\u7279\u5b9a\u7684\u786c\u4ef6\u914d\u7f6e\u3002</p> <p>\u7b80\u5355\u7684\u8bf4\uff0c\u4e3a\u4e86\u4f7f\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u9002\u914d\u4e0d\u540c\u786c\u4ef6\uff0cOpenSBI \u63d0\u51fa\u4e86\u4e00\u7cfb\u5217\u89c4\u8303\u5bf9 M-mode \u4e0b\u7684\u786c\u4ef6\u8fdb\u884c\u4e86\u7edf\u4e00\u5b9a\u4e49\uff0c\u8fd0\u884c\u5728 S-mode \u4e0b\u7684\u5185\u6838\u53ef\u4ee5\u6309\u7167\u8fd9\u4e9b\u89c4\u8303\u5bf9\u4e0d\u540c\u786c\u4ef6\u8fdb\u884c\u64cd\u4f5c\u3002</p> <p></p> <p>\u4e3a\u964d\u4f4e\u5b9e\u9a8c\u96be\u5ea6\uff0c\u6211\u4eec\u9009\u62e9 OpenSBI \u4f5c\u4e3a Bootloader \u6765\u5b8c\u6210\u673a\u5668\u542f\u52a8\u65f6 M-mode \u4e0b\u7684\u786c\u4ef6\u521d\u59cb\u5316\u4e0e\u5bc4\u5b58\u5668\u8bbe\u7f6e\uff0c\u5e76\u4f7f\u7528 OpenSBI \u6240\u63d0\u4f9b\u7684\u63a5\u53e3\u5b8c\u6210\u8bf8\u5982\u5b57\u7b26\u6253\u5370\u7684\u64cd\u4f5c\u3002</p> <p>\u5728\u5b9e\u9a8c\u4e2d\uff0cQEMU \u5df2\u7ecf\u5185\u7f6e\u4e86 OpenSBI \u4f5c\u4e3a Bootloader\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>-bios default</code> \u542f\u7528\u3002\u5982\u679c\u542f\u7528\uff0cQEMU \u4f1a\u5c06 OpenSBI \u4ee3\u7801\u52a0\u8f7d\u5230 0x80000000 \u8d77\u59cb\u5904\u3002OpenSBI \u521d\u59cb\u5316\u5b8c\u6210\u540e\uff0c\u4f1a\u8df3\u8f6c\u5230 0x80200000 \u5904\uff08\u4e5f\u5c31\u662f Kernel \u7684\u8d77\u59cb\u5730\u5740\uff09\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u6240\u7f16\u8bd1\u7684\u4ee3\u7801\u9700\u8981\u653e\u5230 0x80200000 \u5904\u3002</p> <p>\u5982\u679c\u4f60\u5bf9 RISC-V \u67b6\u6784\u7684 Boot \u6d41\u7a0b\u6709\u66f4\u591a\u7684\u597d\u5947\uff0c\u53ef\u4ee5\u53c2\u8003\u8fd9\u4efd bootflow\u3002</p>"},{"location":"course/oslab/oslab1/#makefile","title":"Makefile","text":"<p>Makefile \u53ef\u4ee5\u7b80\u5355\u7684\u8ba4\u4e3a\u662f\u4e00\u4e2a\u5de5\u7a0b\u6587\u4ef6\u7684\u7f16\u8bd1\u89c4\u5219\uff0c\u63cf\u8ff0\u4e86\u6574\u4e2a\u5de5\u7a0b\u7684\u7f16\u8bd1\u548c\u94fe\u63a5\u6d41\u7a0b\u3002\u5728 Lab0 \u4e2d\u6211\u4eec\u5df2\u7ecf\u4f7f\u7528\u4e86 make \u5de5\u5177\u5229\u7528 Makefile \u6587\u4ef6\u6765\u7ba1\u7406\u6574\u4e2a\u5de5\u7a0b\u3002\u5728\u9605\u8bfb\u4e86 Makefile\u4ecb\u7ecd \u8fd9\u4e00\u7ae0\u8282\u540e\uff0c\u540c\u5b66\u4eec\u53ef\u4ee5\u6839\u636e\u5de5\u7a0b\u6587\u4ef6\u5939\u91cc Makefile \u7684\u4ee3\u7801\u6765\u638c\u63e1\u4e00\u4e9b\u57fa\u672c\u7684\u4f7f\u7528\u6280\u5de7\u3002</p>"},{"location":"course/oslab/oslab1/#_5","title":"\u5185\u8054\u6c47\u7f16","text":"<p>\u5185\u8054\u6c47\u7f16\uff08\u901a\u5e38\u7531 asm \u6216\u8005 __asm__ \u5173\u952e\u5b57\u5f15\u5165\uff09\u63d0\u4f9b\u4e86\u5c06\u6c47\u7f16\u8bed\u8a00\u6e90\u4ee3\u7801\u5d4c\u5165 C \u7a0b\u5e8f\u7684\u80fd\u529b\u3002 \u5185\u8054\u6c47\u7f16\u7684\u8be6\u7ec6\u4ecb\u7ecd\u8bf7\u53c2\u8003 Assembler Instructions with C Expression Operands \u3002 \u4e0b\u9762\u7b80\u8981\u4ecb\u7ecd\u4e00\u4e0b\u8fd9\u6b21\u5b9e\u9a8c\u4f1a\u7528\u5230\u7684\u4e00\u4e9b\u5185\u8054\u6c47\u7f16\u77e5\u8bc6\uff1a</p> <p>\u5185\u8054\u6c47\u7f16\u57fa\u672c\u683c\u5f0f\u4e3a\uff1a</p> <pre><code>    __asm__ volatile (\n        \"instruction1\\n\"\n        \"instruction2\\n\"\n        ......\n        ......\n        \"instruction3\\n\"\n        : [out1] \"=r\" (v1),[out2] \"=r\" (v2)\n        : [in1] \"r\" (v1), [in2] \"r\" (v2)\n        : \"memory\"\n    );\n</code></pre> <p>\u5176\u4e2d\uff0c\u4e09\u4e2a <code>:</code> \u5c06\u6c47\u7f16\u90e8\u5206\u5206\u6210\u4e86\u56db\u90e8\u5206\uff1a</p> <ul> <li>\u7b2c\u4e00\u90e8\u5206\u662f\u6c47\u7f16\u6307\u4ee4\uff0c\u6307\u4ee4\u672b\u5c3e\u9700\u8981\u6dfb\u52a0 '\\n'\u3002</li> <li>\u7b2c\u4e8c\u90e8\u5206\u662f\u8f93\u51fa\u64cd\u4f5c\u6570\u90e8\u5206\u3002</li> <li>\u7b2c\u4e09\u90e8\u5206\u662f\u8f93\u5165\u64cd\u4f5c\u6570\u90e8\u5206\u3002</li> <li>\u7b2c\u56db\u90e8\u5206\u662f\u53ef\u80fd\u5f71\u54cd\u7684\u5bc4\u5b58\u5668\u6216\u5b58\u50a8\u5668\uff0c\u7528\u4e8e\u544a\u77e5\u7f16\u8bd1\u5668\u5f53\u524d\u5185\u8054\u6c47\u7f16\u8bed\u53e5\u53ef\u80fd\u4f1a\u5bf9\u67d0\u4e9b\u5bc4\u5b58\u5668\u6216\u5185\u5b58\u8fdb\u884c\u4fee\u6539\uff0c\u4f7f\u5f97\u7f16\u8bd1\u5668\u5728\u4f18\u5316\u65f6\u5c06\u5176\u56e0\u7d20\u8003\u8651\u8fdb\u53bb\u3002</li> </ul> <p>\u8fd9\u56db\u90e8\u5206\u4e2d\u540e\u4e09\u90e8\u5206\u4e0d\u662f\u5fc5\u987b\u7684\u3002</p>"},{"location":"course/oslab/oslab1/#_6","title":"\u793a\u4f8b\u4e00","text":"<pre><code>unsigned long long s_example(unsigned long long type,unsigned long long arg0) {\n    unsigned long long ret_val;\n    __asm__ volatile (\n        \"mv x10, %[type]\\n\"\n        \"mv x11, %[arg0]\\n\"\n        \"mv %[ret_val], x12\"\n        : [ret_val] \"=r\" (ret_val)\n        : [type] \"r\" (type), [arg0] \"r\" (arg0)\n        : \"memory\"\n    );\n    return ret_val;\n}\n</code></pre> <p>\u793a\u4f8b\u4e00\u4e2d\u6307\u4ee4\u90e8\u5206\uff0c<code>%[type]</code>\u3001<code>%[arg0]</code> \u4ee5\u53ca <code>%[ret_val]</code> \u4ee3\u8868\u7740\u7279\u5b9a\u7684\u5bc4\u5b58\u5668\u6216\u662f\u5185\u5b58\u3002</p> <p>\u8f93\u5165\u8f93\u51fa\u90e8\u5206\u4e2d\uff0c<code>[type] \"r\" (type)</code>\u4ee3\u8868\u7740\u5c06 <code>()</code> \u4e2d\u7684\u53d8\u91cf <code>type</code> \u653e\u5165\u5bc4\u5b58\u5668\u4e2d\uff08<code>\"r\"</code> \u6307\u653e\u5165\u5bc4\u5b58\u5668\uff0c\u5982\u679c\u662f <code>\"m\"</code> \u5219\u4e3a\u653e\u5165\u5185\u5b58\uff09\uff0c\u5e76\u4e14\u7ed1\u5b9a\u5230 <code>[]</code> \u4e2d\u547d\u540d\u7684\u7b26\u53f7\u4e2d\u53bb\u3002<code>[ret_val] \"=r\" (ret_val)</code> \u4ee3\u8868\u7740\u5c06\u6c47\u7f16\u6307\u4ee4\u4e2d <code>%[ret_val]</code> \u7684\u503c\u66f4\u65b0\u5230\u53d8\u91cf <code>ret_val</code>\u4e2d\u3002</p>"},{"location":"course/oslab/oslab1/#_7","title":"\u793a\u4f8b\u4e8c","text":"<pre><code>#define write_csr(reg, val) ({\n    __asm__ volatile (\"csrw \" #reg \", %0\" :: \"r\"(val)); })\n</code></pre> <p>\u793a\u4f8b\u4e8c\u5b9a\u4e49\u4e86\u4e00\u4e2a\u5b8f\uff0c\u5176\u4e2d <code>%0</code> \u4ee3\u8868\u7740\u8f93\u51fa\u8f93\u5165\u90e8\u5206\u7684\u7b2c\u4e00\u4e2a\u7b26\u53f7\uff0c\u5373 <code>val</code>\u3002</p> <p><code>#reg</code> \u662fc\u8bed\u8a00\u7684\u4e00\u4e2a\u7279\u6b8a\u5b8f\u5b9a\u4e49\u8bed\u6cd5\uff0c\u76f8\u5f53\u4e8e\u5c06reg\u8fdb\u884c\u5b8f\u66ff\u6362\u5e76\u7528\u53cc\u5f15\u53f7\u5305\u88f9\u8d77\u6765\u3002</p> <p>\u4f8b\u5982 <code>write_csr(sstatus,val)</code> \u7ecf\u5b8f\u5c55\u5f00\u4f1a\u5f97\u5230\uff1a</p> <pre><code>({\n    __asm__ volatile (\"csrw \" \"sstatus\" \", %0\" :: \"r\"(val)); })\n</code></pre>"},{"location":"course/oslab/oslab1/#_8","title":"\u7f16\u8bd1\u76f8\u5173\u77e5\u8bc6\u4ecb\u7ecd","text":""},{"location":"course/oslab/oslab1/#vmlinuxlds","title":"vmlinux.lds","text":"<p>GNU ld \u5373\u94fe\u63a5\u5668\uff0c\u7528\u4e8e\u5c06 <code>*.o</code> \u6587\u4ef6\uff08\u548c\u5e93\u6587\u4ef6\uff09\u94fe\u63a5\u6210\u53ef\u6267\u884c\u6587\u4ef6\u3002\u5728\u64cd\u4f5c\u7cfb\u7edf\u5f00\u53d1\u4e2d\uff0c\u4e3a\u4e86\u6307\u5b9a\u7a0b\u5e8f\u7684\u5185\u5b58\u5e03\u5c40\uff0cld \u4f7f\u7528\u94fe\u63a5\u811a\u672c\uff08Linker Script\uff09\u6765\u63a7\u5236\uff0c\u5728 Linux Kernel \u4e2d\u94fe\u63a5\u811a\u672c\u88ab\u547d\u540d\u4e3a vmlinux.lds\u3002\u66f4\u591a\u5173\u4e8e ld \u7684\u4ecb\u7ecd\u53ef\u4ee5\u4f7f\u7528 <code>man ld</code> \u547d\u4ee4\u3002</p> <p>\u4e0b\u9762\u7ed9\u51fa\u4e00\u4e2a vmlinux.lds \u7684\u4f8b\u5b50\uff1a</p> <pre><code>/* \u76ee\u6807\u67b6\u6784 */\nOUTPUT_ARCH( \"riscv\" )\n\n/* \u7a0b\u5e8f\u5165\u53e3 */\nENTRY( _start )\n\n/* kernel\u4ee3\u7801\u8d77\u59cb\u4f4d\u7f6e */\nBASE_ADDR = 0x80200000;\n\nSECTIONS\n{\n    /* . \u4ee3\u8868\u5f53\u524d\u5730\u5740 */\n    . = BASE_ADDR;\n\n    /* \u8bb0\u5f55kernel\u4ee3\u7801\u7684\u8d77\u59cb\u5730\u5740 */\n    _skernel = .;\n\n    /* ALIGN(0x1000) \u8868\u793a4KB\u5bf9\u9f50 */\n    /* _stext, _etext \u5206\u522b\u8bb0\u5f55\u4e86text\u6bb5\u7684\u8d77\u59cb\u4e0e\u7ed3\u675f\u5730\u5740 */\n    .text : ALIGN(0x1000){\n        _stext = .;\n\n        *(.text.entry)\n        *(.text .text.*)\n\n        _etext = .;\n    }\n\n    .rodata : ALIGN(0x1000){\n        _srodata = .;\n\n        *(.rodata .rodata.*)\n\n        _erodata = .;\n    }\n\n    .data : ALIGN(0x1000){\n        _sdata = .;\n\n        *(.data .data.*)\n\n        _edata = .;\n    }\n\n    .bss : ALIGN(0x1000){\n        _sbss = .;\n\n        *(.bss.stack)\n        sbss = .;\n        *(.bss .bss.*)\n\n        _ebss = .;\n    }\n\n    /* \u8bb0\u5f55kernel\u4ee3\u7801\u7684\u7ed3\u675f\u5730\u5740 */\n    _ekernel = .;\n}\n</code></pre> <p>\u9996\u5148\u6211\u4eec\u4f7f\u7528 OUTPUT_ARCH \u6307\u5b9a\u4e86\u67b6\u6784\u4e3a RISC-V \uff0c\u4e4b\u540e\u4f7f\u7528 ENTRY \u6307\u5b9a\u7a0b\u5e8f\u5165\u53e3\u70b9\u4e3a <code>_start</code> \u51fd\u6570\uff0c\u7a0b\u5e8f\u5165\u53e3\u70b9\u5373\u7a0b\u5e8f\u542f\u52a8\u65f6\u8fd0\u884c\u7684\u51fd\u6570\uff0c\u7ecf\u8fc7\u8fd9\u6837\u7684\u6307\u5b9a\u540e\u5728head.S\u4e2d\u9700\u8981\u7f16\u5199 <code>_start</code> \u51fd\u6570\uff0c\u7a0b\u5e8f\u624d\u80fd\u6b63\u5e38\u8fd0\u884c\u3002</p> <p>\u94fe\u63a5\u811a\u672c\u4e2d\u6709<code>.</code> <code>*</code>\u4e24\u4e2a\u91cd\u8981\u7684\u7b26\u53f7\u3002\u5355\u72ec\u7684<code>.</code>\u5728\u94fe\u63a5\u811a\u672c\u4ee3\u8868\u5f53\u524d\u5730\u5740\uff0c\u5b83\u6709\u8d4b\u503c\u3001\u88ab\u8d4b\u503c\u3001\u81ea\u589e\u7b49\u64cd\u4f5c\u3002\u800c<code>*</code>\u6709\u4e24\u79cd\u7528\u6cd5\uff0c\u5176\u4e00\u662f<code>*()</code>\u5728\u5927\u62ec\u53f7\u4e2d\u8868\u793a\u5c06\u6240\u6709\u6587\u4ef6\u4e2d\u7b26\u5408\u62ec\u53f7\u5185\u8981\u6c42\u7684\u6bb5\u653e\u7f6e\u5728\u5f53\u524d\u4f4d\u7f6e\uff0c\u5176\u4e8c\u662f\u4f5c\u4e3a\u901a\u914d\u7b26\u3002</p> <p>\u94fe\u63a5\u811a\u672c\u7684\u4e3b\u4f53\u662fSECTIONS\u90e8\u5206\uff0c\u5728\u8fd9\u91cc\u94fe\u63a5\u811a\u672c\u7684\u5de5\u4f5c\u662f\u5c06\u7a0b\u5e8f\u7684\u5404\u4e2a\u6bb5\u6309\u987a\u5e8f\u653e\u5728\u5404\u4e2a\u5730\u5740\u4e0a\uff0c\u5728\u4f8b\u5b50\u4e2d\u5c31\u662f\u4ece0x80200000\u5730\u5740\u5f00\u59cb\u653e\u7f6e\u4e86 <code>.text</code> \uff0c <code>.rodata</code> \uff0c <code>.data</code> \u548c <code>.bss</code> \u6bb5\u3002\u5404\u4e2a\u6bb5\u7684\u4f5c\u7528\u53ef\u4ee5\u7b80\u8981\u6982\u62ec\u6210\uff1a</p> \u6bb5\u540d \u4e3b\u8981\u4f5c\u7528 .text \u901a\u5e38\u5b58\u653e\u7a0b\u5e8f\u6267\u884c\u4ee3\u7801 .rodata \u901a\u5e38\u5b58\u653e\u5e38\u91cf\u7b49\u53ea\u8bfb\u6570\u636e .data \u901a\u5e38\u5b58\u653e\u5df2\u521d\u59cb\u5316\u7684\u5168\u5c40\u53d8\u91cf\u3001\u9759\u6001\u53d8\u91cf .bss \u901a\u5e38\u5b58\u653e\u672a\u521d\u59cb\u5316\u7684\u5168\u5c40\u53d8\u91cf\u3001\u9759\u6001\u53d8\u91cf <p>\u5728\u94fe\u63a5\u811a\u672c\u4e2d\u53ef\u4ee5\u81ea\u5b9a\u4e49\u7b26\u53f7\uff0c\u4f8b\u5982\u4ee5\u4e0a\u6240\u6709 <code>_s</code> \u4e0e  <code>_e</code>\u5f00\u5934\u7684\u7b26\u53f7\u90fd\u662f\u6211\u4eec\u81ea\u5df1\u5b9a\u4e49\u7684\u3002</p> <p>\u66f4\u591a\u6709\u5173\u94fe\u63a5\u811a\u672c\u8bed\u6cd5\u53ef\u4ee5\u53c2\u8003\u8fd9\u91cc\u3002</p>"},{"location":"course/oslab/oslab1/#vmlinux","title":"vmlinux","text":"<p>vmlinux \u901a\u5e38\u6307 Linux Kernel \u7f16\u8bd1\u51fa\u7684\u53ef\u6267\u884c\u6587\u4ef6 (Executable and Linkable Format / ELF)\uff0c\u7279\u70b9\u662f\u672a\u538b\u7f29\u7684\uff0c\u5e26\u8c03\u8bd5\u4fe1\u606f\u548c\u7b26\u53f7\u8868\u7684\u3002\u5728\u6574\u5957 OS \u5b9e\u9a8c\u4e2d\uff0cvmlinux \u901a\u5e38\u6307\u5c06\u4f60\u7684\u4ee3\u7801\u8fdb\u884c\u7f16\u8bd1\uff0c\u94fe\u63a5\u540e\u751f\u6210\u7684\u53ef\u4f9b QEMU \u8fd0\u884c\u7684 RV64 \u67b6\u6784\u7a0b\u5e8f\u3002\u5982\u679c\u5bf9 vmlinux \u4f7f\u7528 <code>file</code> \u547d\u4ee4\uff0c\u4f60\u5c06\u770b\u5230\u5982\u4e0b\u4fe1\u606f\uff1a</p> <pre><code>$ file vmlinux \nvmlinux: ELF 64-bit LSB executable, UCB RISC-V, version 1 (SYSV), statically linked, not stripped\n</code></pre>"},{"location":"course/oslab/oslab1/#systemmap","title":"System.map","text":"<p>System.map \u662f\u5185\u6838\u7b26\u53f7\u8868\uff08Kernel Symbol Table\uff09\u6587\u4ef6\uff0c\u662f\u5b58\u50a8\u4e86\u6240\u6709\u5185\u6838\u7b26\u53f7\u53ca\u5176\u5730\u5740\u7684\u4e00\u4e2a\u5217\u8868\u3002\u201c\u7b26\u53f7\u201d\u901a\u5e38\u6307\u7684\u662f\u51fd\u6570\u540d\uff0c\u5168\u5c40\u53d8\u91cf\u540d\u7b49\u7b49\u3002\u4f7f\u7528 <code>nm vmlinux</code> \u547d\u4ee4\u5373\u53ef\u6253\u5370 vmlinux \u7684\u7b26\u53f7\u8868\uff0c\u7b26\u53f7\u8868\u7684\u6837\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>0000000000000800 A __vdso_rt_sigreturn\nffffffe000000000 T __init_begin\nffffffe000000000 T _sinittext\nffffffe000000000 T _start\nffffffe000000040 T _start_kernel\nffffffe000000076 t clear_bss\nffffffe000000080 t clear_bss_done\nffffffe0000000c0 t relocate\nffffffe00000017c t set_reset_devices\nffffffe000000190 t debug_kernel\n</code></pre> <p>\u4f7f\u7528 System.map \u53ef\u4ee5\u65b9\u4fbf\u5730\u8bfb\u51fa\u51fd\u6570\u6216\u53d8\u91cf\u7684\u5730\u5740\uff0c\u4e3a Debug \u63d0\u4f9b\u4e86\u65b9\u4fbf\u3002</p>"},{"location":"course/oslab/oslab1/#rv64_1","title":"RV64 \u65f6\u949f\u4e2d\u65ad\u5904\u7406","text":"<p>\u5982\u679c\u5b8c\u6210\u4e86 3.1 \u4e2d\u7684 RV64 \u5185\u6838\u5f15\u5bfc\uff0c\u6211\u4eec\u80fd\u6210\u529f\u5730\u5c06\u4e00\u4e2a\u6700\u7b80\u5355\u7684 OS \u542f\u52a8\u8d77\u6765\uff0c \u4f46\u8fd8\u6ca1\u6709\u529e\u6cd5\u4e0e\u4e4b\u4ea4\u4e92\u3002\u6211\u4eec\u5728\u8bfe\u7a0b\u4e2d\u8bb2\u8fc7\u64cd\u4f5c\u7cfb\u7edf\u542f\u52a8\u4e4b\u540e\u7531**\u4e8b\u4ef6**\uff08 event \uff09\u9a71\u52a8\uff0c\u5728\u672c\u6b21\u5b9e\u9a8c\u7684\u540e\u534a\u90e8\u5206\u4e2d\uff0c\u6211\u4eec\u5c06\u5f15\u5165\u4e00\u79cd\u91cd\u8981\u7684\u4e8b\u4ef6 trap\uff0ctrap \u7ed9\u4e86 OS \u4e0e\u786c\u4ef6\u3001\u8f6f\u4ef6\u4ea4\u4e92\u7684\u80fd\u529b\u3002\u5728 3.1 \u4e2d\u6211\u4eec\u4ecb\u7ecd\u4e86\u5728 RISC-V \u4e2d\u6709\u4e09\u79cd\u7279\u6743\u7ea7 ( M \u6001\u3001 S \u6001\u3001 U \u6001 )\uff0c \u5728 Boot \u9636\u6bb5\uff0c OpenSBI \u5df2\u7ecf\u5e2e\u6211\u4eec\u5c06 M \u6001\u7684 trap \u5904\u7406\u8fdb\u884c\u4e86\u521d\u59cb\u5316\uff0c\u8fd9\u4e00\u90e8\u5206\u4e0d\u9700\u8981\u6211\u4eec\u518d\u53bb\u5b9e\u73b0\uff0c\u56e0\u6b64\u540e\u7eed\u6211\u4eec\u91cd\u70b9\u5173\u6ce8 S \u6001\u7684 trap \u5904\u7406\u3002</p>"},{"location":"course/oslab/oslab1/#risc-v-interrupt-exception","title":"RISC-V \u4e2d\u7684 Interrupt \u548c Exception","text":""},{"location":"course/oslab/oslab1/#interrupt-exception","title":"\u4ec0\u4e48\u662f Interrupt \u548c Exception","text":"<p>We use the term exception to refer to an unusual condition occurring at run time associated with an instruction in the current RISC-V hart. We use the term interrupt to refer to an external asynchronous event that may cause a RISC-V hart to experience an unexpected transfer of control. We use the term trap to refer to the transfer of control to a trap handler caused by either an exception or an interrupt.</p> <p>\u4e0a\u8ff0\u662f RISC-V Unprivileged Spec 1.6 \u8282\u4e2d\u5bf9\u4e8e <code>Trap</code>\u3001 <code>Interrupt</code> \u4e0e <code>Exception</code> \u7684\u63cf\u8ff0\u3002\u603b\u7ed3\u8d77\u6765 <code>Interrupt</code> \u4e0e <code>Exception</code> \u7684\u4e3b\u8981\u533a\u522b\u5982\u4e0b\u8868\uff1a</p> Interrupt Exception Hardware generate Software generate These are asynchronous external requests for service (like keyboard or printer needs service). These are synchronous internal requests for service based upon abnormal events (think of illegal instructions, illegal address, overflow etc). These are normal events and shouldn\u2019t interfere with the normal running of a computer. These are abnormal events and often result in the termination of a program <p>\u4e0a\u6587\u4e2d\u7684 <code>Trap</code> \u63cf\u8ff0\u7684\u662f\u4e00\u79cd\u63a7\u5236\u8f6c\u79fb\u7684\u8fc7\u7a0b, \u8fd9\u4e2a\u8fc7\u7a0b\u662f\u7531 <code>Interrupt</code> \u6216\u8005 <code>Exception</code> \u5f15\u8d77\u7684\u3002\u8fd9\u91cc\u4e3a\u4e86\u65b9\u4fbf\u8d77\u89c1\uff0c\u6211\u4eec\u5728\u8fd9\u91cc\u7ea6\u5b9a <code>Trap</code> \u4e3a <code>Interrput</code> \u4e0e <code>Exception</code> \u7684\u603b\u79f0\u3002</p>"},{"location":"course/oslab/oslab1/#_9","title":"\u76f8\u5173\u5bc4\u5b58\u5668","text":"<p>\u9664\u4e8632\u4e2a\u901a\u7528\u5bc4\u5b58\u5668\u4e4b\u5916\uff0cRISC-V \u67b6\u6784\u8fd8\u6709\u5927\u91cf\u7684 \u63a7\u5236\u72b6\u6001\u5bc4\u5b58\u5668 <code>Control and Status Registers(CSRs)</code>\uff0c\u4e0b\u9762\u5c06\u4ecb\u7ecd\u51e0\u4e2a\u548c trap \u673a\u5236\u76f8\u5173\u7684\u91cd\u8981\u5bc4\u5b58\u5668\u3002</p> <p>Supervisor Mode \u4e0b trap \u76f8\u5173\u5bc4\u5bc4\u5b58\u5668:</p> <ul> <li><code>sstatus</code> ( Supervisor Status Register )\u4e2d\u5b58\u5728\u4e00\u4e2a SIE ( Supervisor Interrupt Enable ) \u6bd4\u7279\u4f4d\uff0c\u5f53\u8be5\u6bd4\u7279\u4f4d\u8bbe\u7f6e\u4e3a 1 \u65f6\uff0c\u4f1a**\u54cd\u5e94**\u6240\u6709\u7684 S \u6001 trap\uff0c \u5426\u5219\u5c06\u4f1a\u7981\u7528\u6240\u6709 S \u6001 trap\u3002</li> <li><code>sie</code> ( Supervisor Interrupt Eable Register )\u3002\u5728 RISC-V \u4e2d\uff0c<code>Interrupt</code> \u88ab\u5212\u5206\u4e3a\u4e09\u7c7b <code>Software Interrupt</code>\uff0c <code>Timer Interrupt</code>\uff0c <code>External Interrupt</code>\u3002\u5728\u5f00\u542f\u4e86 <code>sstatus[SIE]</code>\u4e4b\u540e\uff0c\u7cfb\u7edf\u4f1a\u6839\u636e <code>sie</code> \u4e2d\u7684\u76f8\u5173\u6bd4\u7279\u4f4d\u6765\u51b3\u5b9a\u662f\u5426\u5bf9\u8be5 <code>Interrupt</code> \u8fdb\u884c**\u5904\u7406**\u3002</li> <li><code>stvec</code> ( Supervisor Trap Vector Base Address Register ) \u5373\u6240\u8c13\u7684\u201c\u4e2d\u65ad\u5411\u91cf\u8868\u57fa\u5740\u201d\u3002 <code>stvec</code> \u6709\u4e24\u79cd\u6a21\u5f0f\uff1a<code>Direct \u6a21\u5f0f</code>\uff0c\u9002\u7528\u4e8e\u7cfb\u7edf\u4e2d\u53ea\u6709\u4e00\u4e2a\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f, \u5176\u6307\u5411\u4e2d\u65ad\u5904\u7406\u5165\u53e3\u51fd\u6570 \uff08 \u672c\u6b21\u5b9e\u9a8c\u4e2d\u6211\u4eec\u6240\u7528\u7684\u6a21\u5f0f \uff09\u3002<code>Vectored \u6a21\u5f0f</code>\uff0c\u6307\u5411\u4e2d\u65ad\u5411\u91cf\u8868\uff0c \u9002\u7528\u4e8e\u7cfb\u7edf\u4e2d\u6709\u591a\u4e2a\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f \uff08 \u8be5\u6a21\u5f0f\u53ef\u4ee5\u53c2\u8003 RISC-V \u5185\u6838\u6e90\u7801 \uff09\u3002</li> <li><code>scause</code> ( Supervisor Cause Register ), \u4f1a\u8bb0\u5f55 trap \u53d1\u751f\u7684\u539f\u56e0\uff0c\u8fd8\u4f1a\u8bb0\u5f55\u8be5 trap \u662f <code>Interrupt</code> \u8fd8\u662f <code>Exception</code>\u3002</li> <li><code>sepc</code> ( Supervisor Exception Program Counter ), \u4f1a\u8bb0\u5f55\u89e6\u53d1 exception \u7684\u90a3\u6761\u6307\u4ee4\u7684\u5730\u5740\u3002</li> </ul> <p>Machine Mode \u5f02\u5e38\u76f8\u5173\u5bc4\u5bc4\u5b58\u5668:</p> <ul> <li>\u7c7b\u4f3c\u4e8e Supervisor Mode\uff0c Machine Mode \u4e5f\u6709\u76f8\u5bf9\u5e94\u7684\u5bc4\u5b58\u5668\uff0c\u4f46\u7531\u4e8e\u672c\u5b9e\u9a8c\u540c\u5b66\u4e0d\u9700\u8981\u64cd\u4f5c\u8fd9\u4e9b\u5bc4\u5b58\u5668\uff0c\u6545\u4e0d\u5728\u6b64\u4f5c\u4ecb\u7ecd\u3002</li> </ul> <p>\u4ee5\u4e0a\u5bc4\u5b58\u5668\u7684\u8be6\u7ec6\u4ecb\u7ecd\u8bf7\u540c\u5b66\u4eec\u53c2\u8003 RISC-V Privileged Spec</p>"},{"location":"course/oslab/oslab1/#_10","title":"\u76f8\u5173\u7279\u6743\u6307\u4ee4","text":"<ul> <li><code>ecall</code> ( Environment Call )\uff0c\u5f53\u6211\u4eec\u5728 S \u6001\u6267\u884c\u8fd9\u6761\u6307\u4ee4\u65f6\uff0c\u4f1a\u89e6\u53d1\u4e00\u4e2a <code>ecall-from-s-mode-exception</code>\uff0c\u4ece\u800c\u8fdb\u5165 M Mode \u4e0b\u7684\u5904\u7406\u6d41\u7a0b( \u5982\u8bbe\u7f6e\u5b9a\u65f6\u5668\u7b49 )\uff1b\u5f53\u6211\u4eec\u5728 U \u6001\u6267\u884c\u8fd9\u6761\u6307\u4ee4\u65f6\uff0c\u4f1a\u89e6\u53d1\u4e00\u4e2a <code>ecall-from-u-mode-exception</code>\uff0c\u4ece\u800c\u8fdb\u5165 S Mode \u4e0b\u7684\u5904\u7406\u6d41\u7a0b ( \u5e38\u7528\u6765\u8fdb\u884c\u7cfb\u7edf\u8c03\u7528 )\u3002</li> <li><code>sret</code> \u7528\u4e8e S \u6001 trap \u8fd4\u56de, \u901a\u8fc7 <code>sepc</code> \u6765\u8bbe\u7f6e <code>pc</code> \u7684\u503c\uff0c \u8fd4\u56de\u5230\u4e4b\u524d\u7a0b\u5e8f\u7ee7\u7eed\u8fd0\u884c\u3002</li> </ul> <p>\u4ee5\u4e0a\u6307\u4ee4\u7684\u8be6\u7ec6\u4ecb\u7ecd\u8bf7\u540c\u5b66\u4eec\u53c2\u8003 RISC-V Privileged Spec</p>"},{"location":"course/oslab/oslab1/#_11","title":"\u4e0a\u4e0b\u6587\u5904\u7406","text":"<p>\u7531\u4e8e\u5728\u5904\u7406 trap \u65f6\uff0c\u6709\u53ef\u80fd\u4f1a\u6539\u53d8\u7cfb\u7edf\u7684\u72b6\u6001\u3002\u6240\u4ee5\u5728\u771f\u6b63\u5904\u7406 trap \u4e4b\u524d\uff0c\u6211\u4eec\u6709\u5fc5\u8981\u5bf9\u7cfb\u7edf\u7684\u5f53\u524d\u72b6\u6001\u8fdb\u884c\u4fdd\u5b58\uff0c\u5728\u5904\u7406\u5b8c\u6210\u4e4b\u540e\uff0c\u6211\u4eec\u518d\u5c06\u7cfb\u7edf\u6062\u590d\u81f3\u539f\u5148\u7684\u72b6\u6001\uff0c\u5c31\u53ef\u4ee5\u786e\u4fdd\u4e4b\u524d\u7684\u7a0b\u5e8f\u7ee7\u7eed\u6b63\u5e38\u8fd0\u884c\u3002 \u8fd9\u91cc\u7684\u7cfb\u7edf\u72b6\u6001\u901a\u5e38\u662f\u6307\u5bc4\u5b58\u5668\uff0c\u8fd9\u4e9b\u5bc4\u5b58\u5668\u4e5f\u53eb\u505aCPU\u7684\u4e0a\u4e0b\u6587 ( <code>Context</code> ).</p>"},{"location":"course/oslab/oslab1/#trap","title":"trap \u5904\u7406\u7a0b\u5e8f","text":"<p>trap \u5904\u7406\u7a0b\u5e8f\u6839\u636e <code>scause</code> \u7684\u503c\uff0c \u8fdb\u5165\u4e0d\u540c\u7684\u5904\u7406\u903b\u8f91\uff0c\u5728\u672c\u6b21\u8bd5\u9a8c\u4e2d\u6211\u4eec\u9700\u8981\u5173\u5fc3\u7684\u53ea\u6709 <code>Superviosr Timer Interrupt</code> \u3002</p>"},{"location":"course/oslab/oslab1/#_12","title":"\u65f6\u949f\u4e2d\u65ad","text":"<p>\u65f6\u949f\u4e2d\u65ad\u9700\u8981 CPU \u786c\u4ef6\u7684\u652f\u6301\u3002CPU \u4ee5\u201c\u65f6\u949f\u5468\u671f\u201d\u4e3a\u5de5\u4f5c\u7684\u57fa\u672c\u65f6\u95f4\u5355\u4f4d\uff0c\u5bf9\u903b\u8f91\u95e8\u7684\u65f6\u5e8f\u7535\u8def\u8fdb\u884c\u540c\u6b65\u3002\u800c\u65f6\u949f\u4e2d\u65ad\u5b9e\u9645\u4e0a\u5c31\u662f\u201c\u6bcf\u9694\u82e5\u5e72\u4e2a\u65f6\u949f\u5468\u671f\u6267\u884c\u4e00\u6b21\u7684\u7a0b\u5e8f\u201d\u3002\u4e0b\u9762\u4ecb\u7ecd\u4e0e\u65f6\u949f\u4e2d\u65ad\u76f8\u5173\u7684\u5bc4\u5b58\u5668\u4ee5\u53ca\u5982\u4f55\u4ea7\u751f\u65f6\u949f\u4e2d\u65ad\u3002</p> <ul> <li><code>mtime</code> \u4e0e <code>mtimecmp</code> ( Machine Timer Register )\u3002 <code>mtime</code> \u662f\u4e00\u4e2a\u5b9e\u65f6\u8ba1\u65f6\u5668\uff0c \u7531\u786c\u4ef6\u4ee5\u6052\u5b9a\u7684\u9891\u7387\u81ea\u589e\u3002<code>mtimecmp</code> \u4e2d\u4fdd\u5b58\u7740\u4e0b\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad\u53d1\u751f\u7684\u65f6\u95f4\u70b9\uff0c\u5f53 <code>mtime</code> \u7684\u503c\u5927\u4e8e\u6216\u7b49\u4e8e <code>mtimecmp</code> \u7684\u503c\uff0c\u7cfb\u7edf\u5c31\u4f1a\u89e6\u53d1\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad\u3002\u56e0\u6b64\u6211\u4eec\u53ea\u9700\u8981\u66f4\u65b0 <code>mtimecmp</code> \u4e2d\u7684\u503c\uff0c\u5c31\u53ef\u4ee5\u8bbe\u7f6e\u4e0b\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad\u7684\u89e6\u53d1\u70b9\u3002 <code>OpenSBI</code> \u5df2\u7ecf\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u66f4\u65b0 <code>mtimecmp</code> \u7684\u63a5\u53e3 <code>sbi_set_timer</code> ( \u89c1 <code>lab1</code> 4.4\u8282 )\u3002</li> <li><code>mcounteren</code> ( Counter-Enable Registers )\u3002\u7531\u4e8e <code>mtime</code> \u662f\u5c5e\u4e8e M \u6001\u7684\u5bc4\u5b58\u5668\uff0c\u6211\u4eec\u5728 S \u6001\u65e0\u6cd5\u76f4\u63a5\u5bf9\u5176\u8bfb\u5199\uff0c \u5e78\u8fd0\u7684\u662f OpenSBI \u5728 M \u6001\u5df2\u7ecf\u901a\u8fc7\u8bbe\u7f6e <code>mcounteren</code> \u5bc4\u5b58\u5668\u7684 <code>TM</code> \u6bd4\u7279\u4f4d\uff0c \u8ba9\u6211\u4eec\u53ef\u4ee5\u5728 S \u6001\u4e2d\u53ef\u4ee5\u901a\u8fc7 <code>time</code> \u8fd9\u4e2a**\u53ea\u8bfb**\u5bc4\u5b58\u5668\u8bfb\u53d6\u5230 <code>mtime</code>\u7684\u5f53\u524d\u503c\uff0c\u76f8\u5173\u6c47\u7f16\u6307\u4ee4\u662f <code>rdtime</code>\u3002</li> </ul> <p>\u4ee5\u4e0a\u5bc4\u5b58\u5668\u7684\u8be6\u7ec6\u4ecb\u7ecd\u8bf7\u540c\u5b66\u4eec\u53c2\u8003 RISC-V Privileged Spec</p>"},{"location":"course/oslab/oslab1/#_13","title":"\u5b9e\u9a8c\u6b65\u9aa4","text":""},{"location":"course/oslab/oslab1/#_14","title":"\u51c6\u5907\u5de5\u7a0b","text":"<p>\u4ece repo \u540c\u6b65\u5b9e\u9a8c\u4ee3\u7801\u6846\u67b6\u3002\u4e3a\u4e86\u51cf\u5c11\u5927\u5bb6\u7684\u5de5\u4f5c\u91cf\uff0c\u5728\u8fd9\u91cc\u6211\u4eec\u63d0\u4f9b\u4e86\u7b80\u5316\u7248\u7684 <code>printk</code> \u6765\u8f93\u51fa\u683c\u5f0f\u5316\u5b57\u7b26\u4e32\u3002</p> <pre><code>\u251c\u2500\u2500 arch\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 riscv\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 include\n\u2502\u00a0\u00a0     \u2502\u00a0\u00a0 \u251c\u2500\u2500 defs.h\n\u2502\u00a0\u00a0     \u2502\u00a0\u00a0 \u2514\u2500\u2500 sbi.h\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 kernel\n\u2502\u00a0\u00a0     \u2502\u00a0\u00a0 \u251c\u2500\u2500 head.S\n\u2502\u00a0\u00a0     \u2502\u00a0\u00a0 \u251c\u2500\u2500 Makefile\n\u2502\u00a0\u00a0     \u2502\u00a0\u00a0 \u251c\u2500\u2500 sbi.c\n\u2502\u00a0\u00a0     \u2502\u00a0\u00a0 \u2514\u2500\u2500 vmlinux.lds\n\u2502\u00a0\u00a0     \u2514\u2500\u2500 Makefile\n\u251c\u2500\u2500 include\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 printk.h\n|   \u251c\u2500\u2500 stddef.h\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 types.h\n\u251c\u2500\u2500 init\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 main.c\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 Makefile\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 test.c\n\u251c\u2500\u2500 lib\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 Makefile\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 printk.c\n\u2514\u2500\u2500 Makefile\n</code></pre> <p>\u5b8c\u6210 RV64 \u5185\u6838\u5f15\u5bfc\uff0c\u9700\u8981\u5b8c\u5584\u4ee5\u4e0b\u6587\u4ef6\uff1a</p> <ul> <li>arch/riscv/kernel/head.S</li> <li>lib/Makefile</li> <li>arch/riscv/kernel/sbi.c</li> <li>arch/riscv/include/defs.h</li> </ul> <p>\u5b8c\u6210 RV64 \u65f6\u949f\u4e2d\u65ad\u5904\u7406\uff0c\u9700\u8981\u5b8c\u5584 / \u6dfb\u52a0\u4ee5\u4e0b\u6587\u4ef6\uff1a</p> <ul> <li>arch/riscv/kernel/head.S</li> <li>arch/riscv/kernel/entry.S</li> <li>arch/riscv/kernel/trap.c</li> <li>arch/riscv/kernel/clock.c</li> </ul>"},{"location":"course/oslab/oslab1/#rv64_2","title":"RV64 \u5185\u6838\u5f15\u5bfc","text":""},{"location":"course/oslab/oslab1/#heads","title":"\u7f16\u5199head.S","text":"<p>\u5b66\u4e60riscv\u7684\u6c47\u7f16\u3002</p> <p>\u5b8c\u6210 arch/riscv/kernel/head.S \u3002\u6211\u4eec\u9996\u5148\u4e3a\u5373\u5c06\u8fd0\u884c\u7684\u7b2c\u4e00\u4e2a C \u51fd\u6570\u8bbe\u7f6e\u7a0b\u5e8f\u6808\uff08\u6808\u7684\u5927\u5c0f\u53ef\u4ee5\u8bbe\u7f6e\u4e3a4KB\uff09\uff0c\u5e76\u5c06\u8be5\u6808\u653e\u7f6e\u5728<code>.bss.stack</code> \u6bb5\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u53ea\u9700\u8981\u901a\u8fc7\u8df3\u8f6c\u6307\u4ee4\uff0c\u8df3\u8f6c\u81f3 main.c \u4e2d\u7684 <code>start_kernel</code> \u51fd\u6570\u5373\u53ef\u3002</p>"},{"location":"course/oslab/oslab1/#makefile_1","title":"\u5b8c\u5584 Makefile \u811a\u672c","text":"<p>\u9605\u8bfb\u6587\u6863\u4e2d\u5173\u4e8e Makefile \u7684\u7ae0\u8282\uff0c\u4ee5\u53ca\u5de5\u7a0b\u6587\u4ef6\u4e2d\u7684 Makefile \u6587\u4ef6\uff0c\u6839\u636e\u6ce8\u91ca\u5b66\u4f1a Makefile \u7684\u4f7f\u7528\u89c4\u5219\u540e\uff0c\u8865\u5145 <code>lib/Makefile</code>\uff0c\u4f7f\u5de5\u7a0b\u5f97\u4ee5\u7f16\u8bd1\u3002  </p> <p>\u5b8c\u6210\u6b64\u6b65\u540e\u5728\u5de5\u7a0b\u6839\u6587\u4ef6\u5939\u6267\u884c make\uff0c\u53ef\u4ee5\u770b\u5230\u5de5\u7a0b\u6210\u529f\u7f16\u8bd1\u51fa vmlinux\u3002</p>"},{"location":"course/oslab/oslab1/#sbic","title":"\u8865\u5145 <code>sbi.c</code>","text":"<p>OpenSBI \u5728 M \u6001\uff0c\u4e3a S \u6001\u63d0\u4f9b\u4e86\u591a\u79cd\u63a5\u53e3\uff0c\u6bd4\u5982\u5b57\u7b26\u4e32\u8f93\u5165\u8f93\u51fa\u3002\u56e0\u6b64\u6211\u4eec\u9700\u8981\u5b9e\u73b0\u8c03\u7528 OpenSBI \u63a5\u53e3\u7684\u529f\u80fd\u3002\u7ed9\u51fa\u51fd\u6570\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <pre><code>struct sbiret {\n    long error;\n    long value;\n};\n\nstruct sbiret sbi_ecall(int ext, int fid, \n                    uint64 arg0, uint64 arg1, uint64 arg2,\n                    uint64 arg3, uint64 arg4, uint64 arg5);\n</code></pre> <p>sbi_ecall \u51fd\u6570\u4e2d\uff0c\u9700\u8981\u5b8c\u6210\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <ol> <li>\u5c06 ext (Extension ID) \u653e\u5165\u5bc4\u5b58\u5668 a7 \u4e2d\uff0cfid (Function ID) \u653e\u5165\u5bc4\u5b58\u5668 a6 \u4e2d\uff0c\u5c06 arg0 ~ arg5 \u653e\u5165\u5bc4\u5b58\u5668 a0 ~ a5 \u4e2d\u3002</li> <li>\u4f7f\u7528 <code>ecall</code> \u6307\u4ee4\u3002<code>ecall</code> \u4e4b\u540e\u7cfb\u7edf\u4f1a\u8fdb\u5165 M \u6a21\u5f0f\uff0c\u4e4b\u540e OpenSBI \u4f1a\u5b8c\u6210\u76f8\u5173\u64cd\u4f5c\u3002</li> <li>OpenSBI \u7684\u8fd4\u56de\u7ed3\u679c\u4f1a\u5b58\u653e\u5728\u5bc4\u5b58\u5668 a0 \uff0c a1 \u4e2d\uff0c\u5176\u4e2d a0 \u4e3a error code\uff0c a1 \u4e3a\u8fd4\u56de\u503c\uff0c \u6211\u4eec\u7528 sbiret \u6765\u63a5\u53d7\u8fd9\u4e24\u4e2a\u8fd4\u56de\u503c\u3002</li> </ol> <p>\u540c\u5b66\u4eec\u53ef\u4ee5\u53c2\u7167\u5185\u8054\u6c47\u7f16\u7684\u793a\u4f8b\u4e00\u5b8c\u6210\u8be5\u51fd\u6570\u7684\u7f16\u5199\u3002 \u7f16\u5199\u6210\u529f\u540e\uff0c\u8c03\u7528 <code>sbi_ecall(0x1, 0x0, 0x30, 0, 0, 0, 0, 0)</code> \u5c06\u4f1a\u8f93\u51fa\u5b57\u7b26'0'\u3002\u5176\u4e2d<code>0x1</code>\u4ee3\u8868 <code>sbi_console_putchar</code> \u7684 ExtensionID\uff0c<code>0x0</code>\u4ee3\u8868FunctionID, 0x30\u4ee3\u8868'0'\u7684ascii\u503c\uff0c\u5176\u4f59\u53c2\u6570\u586b0\u3002</p> <p>\u8bf7\u5728 <code>arch/riscv/kernel/sbi.c</code> \u4e2d\u8865\u5145 <code>sbi_ecall()</code>\u3002</p> <p>\u4e0b\u9762\u5217\u51fa\u4e86\u4e00\u4e9b\u5728\u540e\u7eed\u7684\u5b9e\u9a8c\u4e2d\u53ef\u80fd\u9700\u8981\u4f7f\u7528\u7684\u529f\u80fd\u3002</p> Function Name Function ID Extension ID sbi_set_timer \uff08\u8bbe\u7f6e\u65f6\u949f\u76f8\u5173\u5bc4\u5b58\u5668\uff09 0 0x00 sbi_console_putchar \uff08\u6253\u5370\u5b57\u7b26\uff09 0 0x01 sbi_console_getchar \uff08\u63a5\u6536\u5b57\u7b26\uff09 0 0x02 sbi_shutdown \uff08\u5173\u673a\uff09 0 0x08"},{"location":"course/oslab/oslab1/#defs","title":"\u4fee\u6539 defs","text":"<p>\u5185\u8054\u6c47\u7f16\u7684\u76f8\u5173\u77e5\u8bc6\u89c1\u5185\u8054\u6c47\u7f16\u3002 </p> <p>\u5b66\u4e60\u4e86\u89e3\u4e86\u4ee5\u4e0a\u77e5\u8bc6\u540e\uff0c\u8865\u5145 <code>arch/riscv/include/defs.h</code> \u4e2d\u7684\u4ee3\u7801\u5b8c\u6210\uff1a</p> <p>\u8865\u5145\u5b8c <code>read_csr</code> \u8fd9\u4e2a\u5b8f\u5b9a\u4e49\u3002\u8fd9\u91cc\u6709\u76f8\u5173\u793a\u4f8b\u3002</p> <p>\u5982\u679c\u5b8c\u6210\u5230\u6b64\u5904\uff0c\u4f60\u5c31\u5df2\u7ecf\u53ef\u4ee5\u5728 qemu \u8fd0\u884c <code>make</code> \u5f97\u5230\u7684\u5185\u6838\uff0c\u4ece\u800c\u81f3\u5c11\u5b8c\u6210\u601d\u8003\u9898 1\uff5e4 \u4e86\u3002</p>"},{"location":"course/oslab/oslab1/#rv64_3","title":"RV64 \u65f6\u949f\u4e2d\u65ad\u5904\u7406","text":"<ul> <li>\u51c6\u5907\u5de5\u4f5c\uff0c\u5148\u4fee\u6539 <code>vmlinux.lds</code> \u4ee5\u53ca <code>head.S</code> </li> </ul> <pre><code>  &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; \u539f\u5148\u7684 vmlinux.lds\n  ...\n\n  .text : ALIGN(0x1000){\n      _stext = .;\n\n      *(.text.entry)\n      *(.text .text.*)\n\n      _etext = .;\n  }\n\n  ...\n\n  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; \u4fee\u6539\u4e4b\u540e\u7684 vmlinux.lds\n  ...\n\n  .text : ALIGN(0x1000){\n      _stext = .;\n\n      *(.text.init)      &lt;- \u52a0\u5165\u4e86 .text.init\n      *(.text.entry)     &lt;- \u4e4b\u540e\u6211\u4eec\u5b9e\u73b0 \u4e2d\u65ad\u5904\u7406\u903b\u8f91 \u4f1a\u653e\u7f6e\u5728 .text.entry\n      *(.text .text.*)\n\n      _etext = .;\n  }\n\n  ...  \n</code></pre> <pre><code>  &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; \u539f\u5148\u7684 head.S\n  extern start_kernel\n\n      .section .text.entry        &lt;- \u4e4b\u524d\u7684 _start \u653e\u7f6e\u5728 .text.entry section       \n      .globl _start\n  _start:\n      ...\n\n      .section .bss.stack\n      .globl boot_stack\n  boot_stack:\n      .space 4096\n\n      .globl boot_stack_top\n  boot_stack_top:\n\n  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; \u4fee\u6539\u4e4b\u540e\u7684 head.S\n  extern start_kernel\n\n      .section .text.init         &lt;- \u5c06 _start \u653e\u5165.text.init section \n      .globl _start\n  _start:\n      ...\n\n      .section .bss.stack\n      .globl boot_stack\n  boot_stack:\n      .space 4096\n\n      .globl boot_stack_top\n  boot_stack_top:  \n</code></pre>"},{"location":"course/oslab/oslab1/#trap_1","title":"\u5f00\u542f trap \u5904\u7406","text":"<p>\u5728\u8fd0\u884c <code>start_kernel</code> \u4e4b\u524d\uff0c\u6211\u4eec\u8981\u5bf9\u4e0a\u9762\u63d0\u5230\u7684 CSR \u8fdb\u884c\u521d\u59cb\u5316\uff0c\u521d\u59cb\u5316\u5305\u62ec\u4ee5\u4e0b\u51e0\u4e2a\u6b65\u9aa4\uff1a</p> <ol> <li>\u8bbe\u7f6e <code>stvec</code>\uff0c \u5c06 <code>_traps</code> ( <code>_trap</code> \u5728 4.3 \u4e2d\u5b9e\u73b0 ) \u6240\u8868\u793a\u7684\u5730\u5740\u5199\u5165 <code>stvec</code>\uff0c\u8fd9\u91cc\u6211\u4eec\u91c7\u7528 <code>Direct \u6a21\u5f0f</code>, \u800c <code>_traps</code> \u5219\u662f trap \u5904\u7406\u5165\u53e3\u51fd\u6570\u7684\u57fa\u5730\u5740\u3002</li> <li>\u5f00\u542f\u65f6\u949f\u4e2d\u65ad\uff0c\u5c06 <code>sie[STIE]</code> \u7f6e 1\u3002</li> <li>\u8bbe\u7f6e\u7b2c\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad\uff0c\u53c2\u8003 <code>clock_set_next_event()</code> ( <code>clock_set_next_event()</code> \u5728 4.3.4 \u4e2d\u4ecb\u7ecd ) \u4e2d\u7684\u903b\u8f91\u7528\u6c47\u7f16\u5b9e\u73b0\u3002</li> <li>\u5f00\u542f S \u6001\u4e0b\u7684\u4e2d\u65ad\u54cd\u5e94\uff0c \u5c06 <code>sstatus[SIE]</code> \u7f6e 1\u3002</li> </ol> <p>\u6309\u7167\u4e0b\u65b9\u6a21\u7248\u4fee\u6539 <code>arch/riscv/kernel/head.S</code>\uff0c \u5e76\u8865\u5168 <code>_start</code> \u4e2d\u7684\u903b\u8f91\u3002</p> <pre><code>.extern start_kernel\n\n    .section .text.init\n    .globl _start\n_start:\n    # YOUR CODE HERE\n\n    # ------------------\n\n        # set stvec = _traps\n\n    # ------------------\n\n        # set sie[STIE] = 1\n\n    # ------------------\n\n        # set first time interrupt\n\n    # ------------------\n\n        # set sstatus[SIE] = 1\n\n    # ------------------\n\n    # ------------------\n    # - your lab1 code -\n    # ------------------\n\n    ...\n</code></pre> <p>Debug \u63d0\u793a\uff1a\u53ef\u4ee5\u5148\u4e0d\u5b9e\u73b0 stvec \u548c first time interrupt\uff0c\u5148\u5173\u6ce8 sie \u548c sstatus \u662f\u5426\u8bbe\u7f6e\u6b63\u786e\u3002</p>"},{"location":"course/oslab/oslab1/#_15","title":"\u5b9e\u73b0\u4e0a\u4e0b\u6587\u5207\u6362","text":"<p>\u6211\u4eec\u8981\u4f7f\u7528\u6c47\u7f16\u5b9e\u73b0\u4e0a\u4e0b\u6587\u5207\u6362\u673a\u5236\uff0c \u5305\u542b\u4ee5\u4e0b\u51e0\u4e2a\u6b65\u9aa4\uff1a</p> <ol> <li>\u5728 <code>arch/riscv/kernel/</code> \u76ee\u5f55\u4e0b\u6dfb\u52a0 <code>entry.S</code> \u6587\u4ef6\u3002</li> <li>\u4fdd\u5b58 CPU \u7684\u5bc4\u5b58\u5668\uff08\u4e0a\u4e0b\u6587\uff09\u5230\u5185\u5b58\u4e2d\uff08\u6808\u4e0a\uff09\u3002</li> <li>\u5c06 <code>scause</code> \u548c <code>sepc</code> \u4e2d\u7684\u503c\u4f20\u5165 trap \u5904\u7406\u51fd\u6570 <code>trap_handler</code> ( <code>trap_handler</code> \u5728 4.4 \u4e2d\u4ecb\u7ecd ) \uff0c\u6211\u4eec\u5c06\u4f1a\u5728 <code>trap_handler</code> \u4e2d\u5b9e\u73b0\u5bf9 trap \u7684\u5904\u7406\u3002</li> <li>\u5728\u5b8c\u6210\u5bf9 trap \u7684\u5904\u7406\u4e4b\u540e\uff0c \u6211\u4eec\u4ece\u5185\u5b58\u4e2d\uff08\u6808\u4e0a\uff09\u6062\u590dCPU\u7684\u5bc4\u5b58\u5668\uff08\u4e0a\u4e0b\u6587\uff09\u3002</li> <li>\u4ece trap \u4e2d\u8fd4\u56de\u3002</li> </ol> <p>\u6309\u7167\u4e0b\u65b9\u6a21\u7248\u4fee\u6539 <code>arch/riscv/kernel/entry.S</code>\uff0c \u5e76\u8865\u5168 <code>_traps</code> \u4e2d\u7684\u903b\u8f91\u3002</p> <pre><code>    .section .text.entry\n    .align 2\n    .globl _traps \n_traps:\n    # YOUR CODE HERE\n    # -----------\n\n        # 1. save 32 registers and sepc to stack\n\n    # -----------\n\n        # 2. call trap_handler\n\n    # -----------\n\n        # 3. restore sepc and 32 registers (x2(sp) should be restore last) from stack\n\n    # -----------\n\n        # 4. return from trap\n\n    # -----------\n</code></pre> <p>Debug \u63d0\u793a\uff1a \u53ef\u4ee5\u5148\u4e0d\u5b9e\u73b0 call trap_handler\uff0c \u5148\u5b9e\u73b0\u4e0a\u4e0b\u6587\u5207\u6362\u903b\u8f91\u3002\u901a\u8fc7 gdb \u8ddf\u8e2a\u5404\u4e2a\u5bc4\u5b58\u5668\uff0c\u786e\u4fdd\u4e0a\u4e0b\u6587\u7684 save \u4e0e restore \u6b63\u786e\u5b9e\u73b0\u5e76\u6b63\u786e\u8fd4\u56de\u3002</p>"},{"location":"course/oslab/oslab1/#trap_2","title":"\u5b9e\u73b0 trap \u5904\u7406\u51fd\u6570","text":"<ol> <li>\u5728 <code>arch/riscv/kernel/</code> \u76ee\u5f55\u4e0b\u6dfb\u52a0 <code>trap.c</code> \u6587\u4ef6\u3002</li> <li>\u5728 <code>trap.c</code> \u4e2d\u5b9e\u73b0 trap \u5904\u7406\u51fd\u6570 <code>trap_handler()</code>, \u5176\u63a5\u6536\u7684\u4e24\u4e2a\u53c2\u6570\u5206\u522b\u662f <code>scause</code> \u548c <code>sepc</code> \u4e24\u4e2a\u5bc4\u5b58\u5668\u4e2d\u7684\u503c\u3002</li> </ol> <pre><code>// trap.c \n\nvoid trap_handler(unsigned long scause, unsigned long sepc) {\n    // \u901a\u8fc7 `scause` \u5224\u65adtrap\u7c7b\u578b\n    // \u5982\u679c\u662finterrupt \u5224\u65ad\u662f\u5426\u662ftimer interrupt\n    // \u5982\u679c\u662ftimer interrupt \u5219\u6253\u5370\u8f93\u51fa\u76f8\u5173\u4fe1\u606f, \u5e76\u901a\u8fc7 `clock_set_next_event()` \u8bbe\u7f6e\u4e0b\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad\n    // `clock_set_next_event()` \u89c1 4.3.4 \u8282\n    // \u5176\u4ed6interrupt / exception \u53ef\u4ee5\u76f4\u63a5\u5ffd\u7565\n\n    // YOUR CODE HERE\n}\n</code></pre>"},{"location":"course/oslab/oslab1/#_16","title":"\u5b9e\u73b0\u65f6\u949f\u4e2d\u65ad\u76f8\u5173\u51fd\u6570","text":"<ol> <li>\u5728 <code>arch/riscv/kernel/</code> \u76ee\u5f55\u4e0b\u6dfb\u52a0 <code>clock.c</code> \u6587\u4ef6\u3002</li> <li>\u5728 <code>clock.c</code> \u4e2d\u5b9e\u73b0 get_cycles ( ) : \u4f7f\u7528 <code>rdtime</code> \u6c47\u7f16\u6307\u4ee4\u83b7\u5f97\u5f53\u524d <code>time</code> \u5bc4\u5b58\u5668\u4e2d\u7684\u503c\u3002</li> <li>\u5728 <code>clock.c</code> \u4e2d\u5b9e\u73b0 clock_set_next_event ( ) : \u8c03\u7528 <code>sbi_ecall</code>\uff0c\u8bbe\u7f6e\u4e0b\u4e00\u4e2a\u65f6\u949f\u4e2d\u65ad\u4e8b\u4ef6\u3002</li> </ol> <pre><code>// clock.c\n\n// QEMU\u4e2d\u65f6\u949f\u7684\u9891\u7387\u662f10MHz, \u4e5f\u5c31\u662f1\u79d2\u949f\u76f8\u5f53\u4e8e10000000\u4e2a\u65f6\u949f\u5468\u671f\u3002\nunsigned long TIMECLOCK = 10000000;\n\nunsigned long get_cycles() {\n    // \u7f16\u5199\u5185\u8054\u6c47\u7f16\uff0c\u4f7f\u7528 rdtime \u83b7\u53d6 time \u5bc4\u5b58\u5668\u4e2d (\u4e5f\u5c31\u662fmtime \u5bc4\u5b58\u5668 )\u7684\u503c\u5e76\u8fd4\u56de\n    // YOUR CODE HERE\n\n}\n\nvoid clock_set_next_event() {\n    // \u4e0b\u4e00\u6b21 \u65f6\u949f\u4e2d\u65ad \u7684\u65f6\u95f4\u70b9\n    unsigned long next = get_cycles() + TIMECLOCK;\n\n    // \u4f7f\u7528 sbi_ecall \u6765\u5b8c\u6210\u5bf9\u4e0b\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad\u7684\u8bbe\u7f6e\n    // YOUR CODE HERE\n} \n</code></pre>"},{"location":"course/oslab/oslab1/#_17","title":"\u7f16\u8bd1\u53ca\u6d4b\u8bd5","text":"<p>\u7531\u4e8e\u52a0\u5165\u4e86\u4e00\u4e9b\u65b0\u7684 .c \u6587\u4ef6\uff0c\u53ef\u80fd\u9700\u8981\u4fee\u6539\u4e00\u4e9bMakefile\u6587\u4ef6\uff0c\u8bf7\u540c\u5b66\u81ea\u5df1\u5c1d\u8bd5\u4fee\u6539\uff0c\u4f7f\u9879\u76ee\u53ef\u4ee5\u7f16\u8bd1\u5e76\u8fd0\u884c\u3002</p> <p>\u4e0b\u9762\u662f\u4e00\u4e2a\u6b63\u786e\u5b9e\u73b0\u7684\u8f93\u51fa\u6837\u4f8b\u3002\uff08 \u4ec5\u4f9b\u53c2\u8003 \uff09</p> <pre><code>kernel is running!\n[S] Supervisor Mode Timer Interrupt\nkernel is running!\n[S] Supervisor Mode Timer Interrupt\nkernel is running!\n[S] Supervisor Mode Timer Interrupt\nkernel is running!\n[S] Supervisor Mode Timer Interrupt\nkernel is running!\n[S] Supervisor Mode Timer Interrupt\nkernel is running!\n[S] Supervisor Mode Timer Interrupt\nkernel is running!\n[S] Supervisor Mode Timer Interrupt\nkernel is running!\n[S] Supervisor Mode Timer Interrupt\nkernel is running!\n[S] Supervisor Mode Timer Interrupt\n</code></pre>"},{"location":"course/oslab/oslab1/#aarch64","title":"\u5176\u4ed6\u67b6\u6784\u7684\u4ea4\u53c9\u7f16\u8bd1\u2014\u2014\u4ee5 Aarch64 \u4e3a\u4f8b","text":""},{"location":"course/oslab/oslab1/#_18","title":"\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\u7684\u5b89\u88c5","text":"<p>\u90a3\u4e48\u5982\u4f55\u5b89\u88c5\u4e0d\u540c\u67b6\u6784\u7684\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\u5462\uff1f\u6700\u7b80\u5355\u7684\u65b9\u6cd5\u662f\u7528 Ubuntu \u81ea\u5e26\u7684\u8f6f\u4ef6\u5305\u7ba1\u7406\u5668 <code>apt</code>\uff0c\u5148\u627e\u5230\u6709\u4ec0\u4e48\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u53ef\u4ee5\u88c5</p> <pre><code># \u641c\u7d22\u5305\u542b aarch64 \u7684\u8f6f\u4ef6\u5305\uff0c\u4e00\u822c\u662f\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\napt-cache search aarch64\n...\n# \u641c\u7d22\u7ed3\u679c\u4e2d\u5982\u679c\u6709 gcc-xxx-linux-gnu\uff0c\u4e00\u822c\u9700\u6c42\u4e0b\u88c5\u5b83\u5c31\u884c\u4e86\uff08\u5177\u4f53\u60c5\u51b5\u5177\u4f53\u5206\u6790\u54c8\uff09\nsudo apt install gcc-aarch64-linux-gnu\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u6709 aarch64 \u7684\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\u4e86\uff0c\u5f00\u59cb\u7f16\u8bd1\u5427\uff01</p>"},{"location":"course/oslab/oslab1/#_19","title":"\u600e\u4e48\u83b7\u5f97\u7f16\u8bd1\u8fc7\u7a0b\u7684\u4e2d\u95f4\u4ea7\u7269","text":"<p>\u6ce8\u610f\uff1a\u8fd9\u91cc\u8bf4\u7684\u201c\u7f16\u8bd1\u8fc7\u7a0b\u201d\u5305\u62ec\u9884\u5904\u7406\u3001\u7f16\u8bd1\u3001\u6c47\u7f16\u3001\u94fe\u63a5</p> <p>\u5bf9\u4e8e Linux kernel\uff0c\u7f16\u8bd1\u547d\u4ee4\u548c\u9009\u9879\u5728\u4e0d\u540c\u67b6\u6784\u4e4b\u95f4\u90fd\u5927\u540c\u5c0f\u5f02\uff0c\u4e00\u822c\u9075\u5faa\u4ee5\u4e0b\u5f62\u5f0f\uff08\u7c7b\u6bd4 lab0 \u505a\u8fc7\u7684 riscv64 \u5373\u53ef\uff09</p> <pre><code>make ARCH=xxx CROSS_COMPILE=some-certain-arch- &lt;options&gt; &lt;files&gt;\n</code></pre> <p>\u6bd4\u5982\uff0c\u60f3\u83b7\u5f97 kernel \u4e2d <code>xxx.c</code> \u7684\u9884\u5904\u7406\u4ea7\u7269\uff08\u56de\u5fc6\u4e00\u4e0b\u9884\u5904\u7406\u505a\u4e86\u4ec0\u4e48\uff09<code>xxx.i</code>\uff0c\u6211\u4eec\u53ef\u4ee5</p> <pre><code># \u5148 config\nmake ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig\n\n# \u7136\u540e\u6307\u5b9a\u8981\u751f\u6210\u7684\u6587\u4ef6\nmake ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- path/to/file/xxx.i\n</code></pre> <p>\u8bfe\u4ef6\u91cc\u4e5f\u7ed9\u51fa\u4e86 <code>make</code> \u5de5\u5177\u3002</p>"},{"location":"course/oslab/oslab1/#_20","title":"\u601d\u8003\u9898","text":"<ol> <li>\u8bf7\u603b\u7ed3\u4e00\u4e0b RISC-V \u7684 calling convention\uff0c\u5e76\u89e3\u91ca Caller / Callee Saved Register \u6709\u4ec0\u4e48\u533a\u522b\uff1f</li> <li>\u7f16\u8bd1\u4e4b\u540e\uff0c\u901a\u8fc7 System.map \u67e5\u770b vmlinux.lds \u4e2d\u81ea\u5b9a\u4e49\u7b26\u53f7\u7684\u503c\uff08\u622a\u56fe\uff09\u3002</li> <li>\u7528 <code>csr_read</code> \u5b8f\u8bfb\u53d6 <code>sstatus</code> \u5bc4\u5b58\u5668\u7684\u503c\uff0c\u5bf9\u7167 RISC-V \u624b\u518c\u89e3\u91ca\u5176\u542b\u4e49\uff08\u622a\u56fe\uff09\u3002</li> <li> <p>\u7528 <code>csr_write</code> \u5b8f\u5411 <code>sscratch</code> \u5bc4\u5b58\u5668\u5199\u5165\u6570\u636e\uff0c\u5e76\u9a8c\u8bc1\u662f\u5426\u5199\u5165\u6210\u529f\uff08\u622a\u56fe\uff09\u3002</p> </li> <li> <p>Detail your steps about how to get <code>arch/arm64/kernel/sys.i</code></p> </li> <li>Find system call table of Linux v6.0 for <code>ARM32</code>, <code>RISC-V(32 bit)</code>, <code>RISC-V(64 bit)</code>, <code>x86(32 bit)</code>, <code>x86_64</code>    List source code file, the whole system call table with macro expanded, screenshot every step.</li> <li>Explain what is ELF file? Try readelf and objdump command on an ELF file, give screenshot of the output.    Run an ELF file and cat <code>/proc/PID/maps</code> to give its memory layout.</li> <li>\u5728\u6211\u4eec\u4f7f\u7528make run\u65f6\uff0c OpenSBI \u4f1a\u4ea7\u751f\u5982\u4e0b\u8f93\u51fa:</li> </ol> <pre><code>    OpenSBI v0.9\n     ____                    _____ ____ _____\n    / __ \\                  / ____|  _ \\_   _|\n   | |  | |_ __   ___ _ __ | (___ | |_) || |\n   | |  | | '_ \\ / _ \\ '_ \\ \\___ \\|  _ &lt; | |\n   | |__| | |_) |  __/ | | |____) | |_) || |_\n    \\____/| .__/ \\___|_| |_|_____/|____/_____|\n          | |\n          |_|\n\n    ......\n\n    Boot HART MIDELEG         : 0x0000000000000222\n    Boot HART MEDELEG         : 0x000000000000b109\n\n    ......\n</code></pre> <p>\u901a\u8fc7\u67e5\u770b <code>RISC-V Privileged Spec</code> \u4e2d\u7684 <code>medeleg</code> \u548c <code>mideleg</code> \uff0c\u89e3\u91ca\u4e0a\u9762 <code>MIDELEG</code> \u503c\u7684\u542b\u4e49\u3002</p> <p>5, 6, 7, 8 need to have screenshots.</p>"},{"location":"course/oslab/oslab1/#_21","title":"\u4f5c\u4e1a\u63d0\u4ea4","text":"<p>\u5b9e\u9a8c\u62a5\u544a\u9700\u8981\u5305\u542b\u5bf9\u6240\u6709\u601d\u8003\u9898\u7684\u56de\u7b54\uff0c\u6709\u622a\u56fe\u8981\u6c42\u7684\u8981\u622a\u56fe\u3002</p> <p>\u540c\u5b66\u9700\u8981\u63d0\u4ea4\u5b9e\u9a8c\u62a5\u544a\u4ee5\u53ca\u6574\u4e2a\u5de5\u7a0b\u4ee3\u7801\u3002\u5728\u63d0\u4ea4\u524d\u8bf7\u4f7f\u7528 <code>make clean</code> \u6e05\u9664\u6240\u6709\u6784\u5efa\u4ea7\u7269\u3002</p>"},{"location":"dev/","title":"Talk is cheap, show me the code.","text":"<p>\u5728\u8fd9\u91cc\u8bb0\u5f55\u4e00\u4e0b\u5f00\u53d1\u7ecf\u9a8c\u5427\u3002 \u83dc\u83dc\uff0c\u545c\u545c\u3002</p>"},{"location":"blog/archive/2023/","title":"2023","text":""},{"location":"blog/category/go/","title":"Go","text":""},{"location":"blog/category/interesting/","title":"Interesting","text":""},{"location":"blog/category/debug/","title":"Debug","text":""}]}