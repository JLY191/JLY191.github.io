
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="JLY">
      
      
        <link rel="canonical" href="https://jly191.github.io/course/oslab/oslab4/">
      
      
        <link rel="prev" href="../oslab3/">
      
      
        <link rel="next" href="../oslab5/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS è®¢é˜…" href="../../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="å·²æ›´æ–°å†…å®¹çš„ RSS è®¢é˜…" href="../../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../../images/favicon.jpg">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.6">
    
    
      
        <title>oslab4æŒ‡å¯¼ - The Nowhere Inn</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.35e1ed30.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.356b1318.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=San+Francisco:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"San Francisco";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-XXXXXXXXXX"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-XXXXXXXXXX",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="light-blue" data-md-color-accent="deep-purple">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lab-4-rv64" class="md-skip">
          è·³è½¬è‡³
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="é¡µçœ‰">
    <a href="../../.." title="The Nowhere Inn" class="md-header__button md-logo" aria-label="The Nowhere Inn" data-md-component="logo">
      
  <img src="../../../images/favicon.jpg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            The Nowhere Inn
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              oslab4æŒ‡å¯¼
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="light-blue" data-md-color-accent="deep-purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="light-blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="æœç´¢" placeholder="æœç´¢" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="æŸ¥æ‰¾">
        
        <button type="reset" class="md-search__icon md-icon" title="æ¸…ç©ºå½“å‰å†…å®¹" aria-label="æ¸…ç©ºå½“å‰å†…å®¹" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            æ­£åœ¨åˆå§‹åŒ–æœç´¢å¼•æ“
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/JLY191/ZJU_SE_Course" title="å‰å¾€ä»“åº“" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    ZJU_SE_Course
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="æ ‡ç­¾" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
    
  
  ğŸ  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../blog/" class="md-tabs__link">
          
  
  âœï¸ Blog

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../dev/" class="md-tabs__link">
          
  
  ğŸ§‘â€ğŸ’» Dev

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
  ğŸ“– Course

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="å¯¼èˆªæ " data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="The Nowhere Inn" class="md-nav__button md-logo" aria-label="The Nowhere Inn" data-md-component="logo">
      
  <img src="../../../images/favicon.jpg" alt="logo">

    </a>
    The Nowhere Inn
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/JLY191/ZJU_SE_Course" title="å‰å¾€ä»“åº“" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    ZJU_SE_Course
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ğŸ  Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    âœï¸ Blog
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            âœï¸ Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Blog
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    å½’æ¡£
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            å½’æ¡£
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/archive/2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    åˆ†ç±»
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            åˆ†ç±»
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/category/go/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Go
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/category/interesting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Interesting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/category/debug/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Debug
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    ğŸ§‘â€ğŸ’» Dev
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            ğŸ§‘â€ğŸ’» Dev
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../dev/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Talk is cheap, show me the code.
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    regex
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            regex
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../dev/regex/regex/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    regex basic
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    ğŸ“– Course
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            ğŸ“– Course
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    æ—©å…«è°‹æ€äººç±»
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" checked>
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    oslab
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            oslab
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../oslab0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    oslab0æŒ‡å¯¼
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../oslab1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    oslab1æŒ‡å¯¼
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../oslab2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    oslab2æŒ‡å¯¼
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../oslab3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    oslab3æŒ‡å¯¼
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    oslab4æŒ‡å¯¼
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    oslab4æŒ‡å¯¼
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="ç›®å½•">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      ç›®å½•
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1 å®éªŒç›®çš„
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    2 å®éªŒç¯å¢ƒ
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3 èƒŒæ™¯çŸ¥è¯†
  </a>
  
    <nav class="md-nav" aria-label="3 èƒŒæ™¯çŸ¥è¯†">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#30" class="md-nav__link">
    3.0 å‰è¨€
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#31-user" class="md-nav__link">
    3.1 User æ¨¡å¼åŸºç¡€ä»‹ç»
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32" class="md-nav__link">
    3.2 ç³»ç»Ÿè°ƒç”¨çº¦å®š
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-sstatussum-pteu" class="md-nav__link">
    3.3 sstatus[SUM] PTE[U]
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34" class="md-nav__link">
    3.4 ç”¨æˆ·æ€æ ˆä¸å†…æ ¸æ€æ ˆ
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35-elf" class="md-nav__link">
    3.5 ELF ç¨‹åº
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4 å®éªŒæ­¥éª¤
  </a>
  
    <nav class="md-nav" aria-label="4 å®éªŒæ­¥éª¤">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41" class="md-nav__link">
    4.1 å‡†å¤‡å·¥ç¨‹
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42" class="md-nav__link">
    4.2 åˆ›å»ºç”¨æˆ·æ€è¿›ç¨‹
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-_trap-trap_handler" class="md-nav__link">
    4.3 ä¿®æ”¹ä¸­æ–­å…¥å£/è¿”å›é€»è¾‘ ( _trap ) ä»¥åŠä¸­æ–­å¤„ç†å‡½æ•° ï¼ˆ trap_handler ï¼‰
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44" class="md-nav__link">
    4.4 æ·»åŠ ç³»ç»Ÿè°ƒç”¨
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#45-heads-start_kernel" class="md-nav__link">
    4.5 ä¿®æ”¹ head.S ä»¥åŠ start_kernel
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#46" class="md-nav__link">
    4.6 æµ‹è¯•çº¯äºŒè¿›åˆ¶æ–‡ä»¶
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#47-elf" class="md-nav__link">
    4.7 æ·»åŠ  ELF æ”¯æŒ
  </a>
  
    <nav class="md-nav" aria-label="4.7 æ·»åŠ  ELF æ”¯æŒ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#elf-header" class="md-nav__link">
    ELF Header
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    æ‰€ä»¥ä»£ç æ€ä¹ˆå†™ï¼Ÿ
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    5. æ€è€ƒé¢˜
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    ä½œä¸šæäº¤
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../oslab5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    oslab5æŒ‡å¯¼
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    blockchain
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            blockchain
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/basics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    basics
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../blockchain/general/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    general
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="lab-4-rv64">Lab 4: RV64 ç”¨æˆ·æ€ç¨‹åº<a class="headerlink" href="#lab-4-rv64" title="Permanent link">&para;</a></h1>
<h2 id="1">1 å®éªŒç›®çš„<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<ul>
<li>åˆ›å»ºç”¨æˆ·æ€è¿›ç¨‹ï¼Œå¹¶è®¾ç½® <code>sstatus</code> æ¥å®Œæˆå†…æ ¸æ€è½¬æ¢è‡³ç”¨æˆ·æ€ã€‚</li>
<li>æ­£ç¡®è®¾ç½®ç”¨æˆ·è¿›ç¨‹çš„ <strong>ç”¨æˆ·æ€æ ˆ</strong> å’Œ <strong>å†…æ ¸æ€æ ˆ</strong> ï¼Œå¹¶åœ¨å¼‚å¸¸å¤„ç†æ—¶æ­£ç¡®åˆ‡æ¢ã€‚</li>
<li>è¡¥å……å¼‚å¸¸å¤„ç†é€»è¾‘ï¼Œå®ŒæˆæŒ‡å®šçš„ç³»ç»Ÿè°ƒç”¨ï¼ˆ SYS_WRITE, SYS_GETPID ï¼‰åŠŸèƒ½ã€‚</li>
</ul>
<h2 id="2">2 å®éªŒç¯å¢ƒ<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<ul>
<li>Same as previous labs.</li>
</ul>
<h2 id="3">3 èƒŒæ™¯çŸ¥è¯†<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<h3 id="30">3.0 å‰è¨€<a class="headerlink" href="#30" title="Permanent link">&para;</a></h3>
<p>åœ¨ <a href="./lab3.md">lab3</a> ä¸­ï¼Œæˆ‘ä»¬å¼€å¯è™šæ‹Ÿå†…å­˜ï¼Œè¿™ä¸ºè¿›ç¨‹é—´åœ°å€ç©ºé—´ç›¸äº’éš”ç¦»æ‰“ä¸‹äº†åŸºç¡€ã€‚ä¹‹å‰çš„å®éªŒä¸­æˆ‘ä»¬åªåˆ›å»ºäº†å†…æ ¸çº¿ç¨‹ï¼Œä»–ä»¬å…±ç”¨äº†åœ°å€ç©ºé—´ ï¼ˆå…±ç”¨ä¸€ä¸ª <strong>å†…æ ¸é¡µè¡¨</strong> <code>swapper_pg_dir</code> ï¼‰ã€‚åœ¨æœ¬æ¬¡å®éªŒä¸­æˆ‘ä»¬å°†å¼•å…¥ç”¨æˆ·æ€è¿›ç¨‹ã€‚å½“å¯åŠ¨ç”¨æˆ·æ¨¡å¼åº”ç”¨ç¨‹åºæ—¶ï¼Œå†…æ ¸å°†ä¸ºè¯¥åº”ç”¨ç¨‹åºåˆ›å»ºä¸€ä¸ªè¿›ç¨‹ï¼Œä¸ºåº”ç”¨ç¨‹åºæä¾›äº†ä¸“ç”¨è™šæ‹Ÿåœ°å€ç©ºé—´ç­‰èµ„æºã€‚å› ä¸ºåº”ç”¨ç¨‹åºçš„è™šæ‹Ÿåœ°å€ç©ºé—´æ˜¯ç§æœ‰çš„ï¼Œæ‰€ä»¥ä¸€ä¸ªåº”ç”¨ç¨‹åºæ— æ³•æ›´æ”¹å±äºå¦ä¸€ä¸ªåº”ç”¨ç¨‹åºçš„æ•°æ®ã€‚æ¯ä¸ªåº”ç”¨ç¨‹åºéƒ½æ˜¯ç‹¬ç«‹è¿è¡Œçš„ï¼Œå¦‚æœä¸€ä¸ªåº”ç”¨ç¨‹åºå´©æºƒï¼Œå…¶ä»–åº”ç”¨ç¨‹åºå’Œæ“ä½œç³»ç»Ÿä¸ä¼šå—åˆ°å½±å“ã€‚åŒæ—¶ï¼Œç”¨æˆ·æ¨¡å¼åº”ç”¨ç¨‹åºå¯è®¿é—®çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¹Ÿå—åˆ°é™åˆ¶ï¼Œåœ¨ç”¨æˆ·æ¨¡å¼ä¸‹æ— æ³•è®¿é—®å†…æ ¸çš„è™šæ‹Ÿåœ°å€ï¼Œé˜²æ­¢åº”ç”¨ç¨‹åºä¿®æ”¹å…³é”®æ“ä½œç³»ç»Ÿæ•°æ®ã€‚å½“ç”¨æˆ·æ€ç¨‹åºéœ€è¦è®¿é—®å…³é”®èµ„æºçš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨æ¥å®Œæˆç”¨æˆ·æ€ç¨‹åºä¸æ“ä½œç³»ç»Ÿä¹‹é—´çš„äº’åŠ¨ã€‚</p>
<h3 id="31-user">3.1 User æ¨¡å¼åŸºç¡€ä»‹ç»<a class="headerlink" href="#31-user" title="Permanent link">&para;</a></h3>
<p>å¤„ç†å™¨å…·æœ‰ä¸¤ç§ä¸åŒçš„æ¨¡å¼ï¼šç”¨æˆ·æ¨¡å¼å’Œå†…æ ¸æ¨¡å¼ã€‚åœ¨å†…æ ¸æ¨¡å¼ä¸‹ï¼Œæ‰§è¡Œä»£ç å¯¹åº•å±‚ç¡¬ä»¶å…·æœ‰å®Œæ•´ä¸”ä¸å—é™åˆ¶çš„è®¿é—®æƒé™ï¼Œå®ƒå¯ä»¥æ‰§è¡Œä»»ä½• CPU æŒ‡ä»¤å¹¶å¼•ç”¨ä»»ä½•å†…å­˜åœ°å€ã€‚åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹ï¼Œæ‰§è¡Œä»£ç æ— æ³•ç›´æ¥è®¿é—®ç¡¬ä»¶ï¼Œå¿…é¡»å§”æ‰˜ç»™ç³»ç»Ÿæä¾›çš„æ¥å£æ‰èƒ½è®¿é—®ç¡¬ä»¶æˆ–å†…å­˜ã€‚å¤„ç†å™¨æ ¹æ®å¤„ç†å™¨ä¸Šè¿è¡Œçš„ä»£ç ç±»å‹åœ¨ä¸¤ç§æ¨¡å¼ä¹‹é—´åˆ‡æ¢ã€‚åº”ç”¨ç¨‹åºä»¥ç”¨æˆ·æ¨¡å¼è¿è¡Œï¼Œè€Œæ ¸å¿ƒæ“ä½œç³»ç»Ÿç»„ä»¶ä»¥å†…æ ¸æ¨¡å¼è¿è¡Œã€‚</p>
<h3 id="32">3.2 ç³»ç»Ÿè°ƒç”¨çº¦å®š<a class="headerlink" href="#32" title="Permanent link">&para;</a></h3>
<p>ç³»ç»Ÿè°ƒç”¨æ˜¯ç”¨æˆ·æ€åº”ç”¨ç¨‹åºè¯·æ±‚å†…æ ¸æœåŠ¡çš„ä¸€ç§æ–¹å¼ã€‚åœ¨ RISC-V ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>ecall</code> æŒ‡ä»¤è¿›è¡Œç³»ç»Ÿè°ƒç”¨ã€‚å½“æ‰§è¡Œè¿™æ¡æŒ‡ä»¤æ—¶å¤„ç†å™¨ä¼šæå‡ç‰¹æƒæ¨¡å¼ï¼Œè·³è½¬åˆ°å¼‚å¸¸å¤„ç†å‡½æ•°å¤„ç†è¿™æ¡ç³»ç»Ÿè°ƒç”¨ã€‚</p>
<p>Linux ä¸­ RISC-V ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨å¯ä»¥åœ¨ <code>include/uapi/asm-generic/unistd.h</code> ä¸­æ‰¾åˆ°ï¼Œ<a href="https://man7.org/linux/man-pages/man2/syscall.2.html"> syscall(2) </a>æ‰‹å†Œé¡µä¸Šå¯¹RISC-Væ¶æ„ä¸Šçš„è°ƒç”¨è¯´æ˜è¿›è¡Œäº†æ€»ç»“ï¼Œç³»ç»Ÿè°ƒç”¨å‚æ•°ä½¿ç”¨ a0 - a5 ï¼Œç³»ç»Ÿè°ƒç”¨å·ä½¿ç”¨ a7 ï¼Œ ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼ä¼šè¢«ä¿å­˜åˆ° a0, a1 ä¸­ã€‚</p>
<h3 id="33-sstatussum-pteu">3.3 sstatus[SUM] PTE[U]<a class="headerlink" href="#33-sstatussum-pteu" title="Permanent link">&para;</a></h3>
<p>å½“é¡µè¡¨é¡¹ PTE[U] ç½® 0 æ—¶ï¼Œè¯¥é¡µè¡¨é¡¹å¯¹åº”çš„å†…å­˜é¡µä¸ºå†…æ ¸é¡µï¼Œè¿è¡Œåœ¨ U-Mode ä¸‹çš„ä»£ç  <strong>æ— æ³•è®¿é—®</strong> ã€‚å½“é¡µè¡¨é¡¹ PTE[U] ç½® 1 æ—¶ï¼Œè¯¥é¡µè¡¨é¡¹å¯¹åº”çš„å†…å­˜é¡µä¸ºç”¨æˆ·é¡µï¼Œè¿è¡Œåœ¨ S-Mode ä¸‹çš„ä»£ç  <strong>æ— æ³•è®¿é—®</strong> ã€‚å¦‚æœæƒ³è®© S ç‰¹æƒçº§ä¸‹çš„ç¨‹åºèƒ½å¤Ÿè®¿é—®ç”¨æˆ·é¡µï¼Œéœ€è¦å¯¹ sstatus[SUM] ä½ç½® 1 ã€‚ä½†æ˜¯æ— è®ºä»€ä¹ˆæ ·çš„æƒ…å†µä¸‹ï¼Œç”¨æˆ·é¡µä¸­çš„æŒ‡ä»¤å¯¹äº S-Mode è€Œè¨€éƒ½æ˜¯ <strong>æ— æ³•æ‰§è¡Œ</strong> çš„ã€‚ </p>
<h3 id="34">3.4 ç”¨æˆ·æ€æ ˆä¸å†…æ ¸æ€æ ˆ<a class="headerlink" href="#34" title="Permanent link">&para;</a></h3>
<p>å½“ç”¨æˆ·æ€ç¨‹åºåœ¨ç”¨æˆ·æ€è¿è¡Œæ—¶ï¼Œå…¶ä½¿ç”¨çš„æ ˆä¸º <strong>ç”¨æˆ·æ€æ ˆ</strong> ï¼Œå½“è°ƒç”¨ SYSCALLæ—¶å€™ï¼Œé™·å…¥å†…æ ¸å¤„ç†æ—¶ä½¿ç”¨çš„æ ˆä¸º <strong>å†…æ ¸æ€æ ˆ</strong> ï¼Œå› æ­¤éœ€è¦åŒºåˆ†ç”¨æˆ·æ€æ ˆå’Œå†…æ ¸æ€æ ˆï¼Œå¹¶åœ¨å¼‚å¸¸å¤„ç†çš„è¿‡ç¨‹ä¸­éœ€è¦å¯¹æ ˆè¿›è¡Œåˆ‡æ¢ã€‚</p>
<h3 id="35-elf">3.5 ELF ç¨‹åº<a class="headerlink" href="#35-elf" title="Permanent link">&para;</a></h3>
<p>ELF, short for Executable and Linkable Format. æ˜¯å½“ä»Šè¢«å¹¿æ³›ä½¿ç”¨çš„åº”ç”¨ç¨‹åºæ ¼å¼ã€‚ä¾‹å¦‚å½“æˆ‘ä»¬è¿è¡Œ <code>gcc &lt;some-name&gt;.c</code> åäº§ç”Ÿçš„ <code>a.out</code> è¾“å‡ºæ–‡ä»¶çš„æ ¼å¼å°±æ˜¯ ELFã€‚</p>
<div class="highlight"><pre><span></span><code>$ cat hello.c
#include &lt;stdio.h&gt;

int main() {
    printf(&quot;hello, world\n&quot;);
    return 0;
}
$ gcc hello.c
$ file a.out
a.out: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, 
interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=dd33139196142abd22542134c20d85c571a78b0c, 
for GNU/Linux 3.2.0, not stripped
</code></pre></div>
<p>å°†ç¨‹åºå°è£…æˆ ELF æ ¼å¼çš„é‡è¦æ„ä¹‰æ˜¯ï¼Œåœ¨å…¶ä¸­å¯ä»¥åŒ…å«å¦‚ä½•å°†ç¨‹åºæ­£ç¡®åœ°åŠ è½½å…¥å†…å­˜çš„ metadataï¼Œå¹¶ä¸”åœ¨è¿è¡Œæ—¶å¯ä»¥ç”± loader æ¥å°†åŠ¨æ€é“¾æ¥åœ¨ç¨‹åºä¸Šçš„åŠ¨æ€é“¾æ¥åº“(shared library)æ­£ç¡®åœ°ä»ç£ç›˜æˆ–å†…å­˜ä¸­åŠ è½½(load)ï¼Œä»¥åŠï¼ŒELF æ–‡ä»¶ä¸­åŒ…å«çš„é‡å®šä½ä¿¡æ¯å¯ä»¥è®©è¯¥ç¨‹åºç»§ç»­å’Œåˆ«çš„å¯é‡å®šä½æ–‡ä»¶å’Œåº“å†æ¬¡é“¾æ¥ï¼Œæ„æˆæ–°çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p>
<p>ä¸ºäº†ç®€åŒ–å®éªŒæ­¥éª¤ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯é™æ€é“¾æ¥çš„ç¨‹åºï¼Œæ‰€ä»¥ä¸ä¼šæ¶‰åŠé“¾æ¥åŠ¨æ€é“¾æ¥åº“çš„å†…å®¹ã€‚</p>
<h2 id="4">4 å®éªŒæ­¥éª¤<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<h3 id="41">4.1 å‡†å¤‡å·¥ç¨‹<a class="headerlink" href="#41" title="Permanent link">&para;</a></h3>
<ul>
<li>æ­¤æ¬¡å®éªŒåŸºäº lab4 åŒå­¦æ‰€å®ç°çš„ä»£ç è¿›è¡Œã€‚</li>
<li>éœ€è¦ä¿®æ”¹ <code>vmlinux.lds.S</code>ï¼Œå°†ç”¨æˆ·æ€ç¨‹åº <code>uapp</code> åŠ è½½è‡³ <code>.data</code> æ®µã€‚æŒ‰å¦‚ä¸‹ä¿®æ”¹ï¼š</li>
</ul>
<div class="highlight"><pre><span></span><code>...

.data : ALIGN(0x1000){
        _sdata = .;

        *(.sdata .sdata*)
        *(.data .data.*)

        _edata = .;

        . = ALIGN(0x1000);
        uapp_start = .;
        *(.uapp .uapp*)
        uapp_end = .;
        . = ALIGN(0x1000);

    } &gt;ramv AT&gt;ram

...
</code></pre></div>
<blockquote>
<p>å¦‚æœä½ è¦ä½¿ç”¨ <code>uapp_start</code> è¿™ä¸ªç¬¦å·ï¼Œå¯ä»¥åœ¨ä»£ç é‡Œè¿™æ ·æ¥å£°æ˜å®ƒï¼š<code>extern char uapp_start[]</code>ï¼Œè¿™æ ·å°±å¯ä»¥åƒä¸€ä¸ªå­—ç¬¦æ•°ç»„ä¸€æ ·æ¥è®¿é—®è¿™å—å†…å­˜çš„å†…å®¹ã€‚ä¾‹å¦‚ï¼Œç¨‹åºçš„ç¬¬ä¸€ä¸ªå­—èŠ‚å°±æ˜¯ <code>uapp_start[0]</code>ã€‚</p>
</blockquote>
<ul>
<li>éœ€è¦ä¿®æ”¹ <code>defs.h</code>ï¼Œåœ¨ <code>defs.h</code> <strong>æ·»åŠ </strong> å¦‚ä¸‹å†…å®¹ï¼š</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="cp">#define USER_START (0x0000000000000000) </span><span class="c1">// user space start virtual address</span>
<span class="cp">#define USER_END   (0x0000004000000000) </span><span class="c1">// user space end virtual address</span>
</code></pre></div>
<ul>
<li>ä» <code>repo</code> åŒæ­¥ä»¥ä¸‹æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ã€‚å¹¶æŒ‰ç…§ä¸‹é¢çš„ä½ç½®æ¥æ”¾ç½®è¿™äº›æ–°æ–‡ä»¶ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨ <code>mm</code> ä¸­æ·»åŠ äº† <code>buddy system</code>ï¼Œä½†æ˜¯ä¹Ÿä¿è¯äº†åŸæ¥è°ƒç”¨çš„ <code>kalloc</code> å’Œ <code>kfree</code> çš„å…¼å®¹ã€‚ä½ åº”è¯¥æ— éœ€ä¿®æ”¹åŸå…ˆä½¿ç”¨äº† <code>kalloc</code> çš„ç›¸å…³ä»£ç ï¼Œå¦‚æœå‡ºç°å…¼å®¹æ€§é—®é¢˜å¯ä»¥è”ç³»åŠ©æ•™ã€‚ä¸ºäº†å‡å°å¤§å®¶çš„å·¥ä½œé‡ï¼Œæˆ‘ä»¬æ›¿å¤§å®¶å®ç°äº† Buddy Systemï¼Œå¤§å®¶å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™äº›å‡½æ•°æ¥ç®¡ç†å†…å­˜ï¼š</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// åˆ†é… page_cnt ä¸ªé¡µçš„åœ°å€ç©ºé—´ï¼Œè¿”å›åˆ†é…å†…å­˜çš„åœ°å€ã€‚ä¿è¯åˆ†é…çš„å†…å­˜åœ¨è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€ä¸Šéƒ½æ˜¯è¿ç»­çš„</span>
<span class="kt">uint64_t</span><span class="w"> </span><span class="nf">alloc_pages</span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">page_cnt</span><span class="p">);</span>
<span class="c1">// ç›¸å½“äº alloc_pages(1);</span>
<span class="kt">uint64_t</span><span class="w"> </span><span class="nf">alloc_page</span><span class="p">();</span>
<span class="c1">// é‡Šæ”¾ä» addr å¼€å§‹çš„ä¹‹å‰æŒ‰åˆ†é…çš„å†…å­˜</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">free_pages</span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>.
â”œâ”€â”€ arch
â”‚Â Â  â””â”€â”€ riscv
â”‚Â Â      â””â”€â”€ Makefile
â”‚Â Â      â””â”€â”€ include
â”‚Â Â          â””â”€â”€ mm.h
â”‚Â Â          â””â”€â”€ stdint.h
â”‚Â Â      â””â”€â”€ kernel
â”‚Â Â          â””â”€â”€ mm.c
â”œâ”€â”€ include
â”‚Â Â  â””â”€â”€ elf.h (this is copied from newlib)
â””â”€â”€ user
    â”œâ”€â”€ Makefile
    â”œâ”€â”€ getpid.c
    â”œâ”€â”€ link.lds
    â”œâ”€â”€ printf.c
    â”œâ”€â”€ start.S
    â”œâ”€â”€ stddef.h
    â”œâ”€â”€ stdio.h
    â”œâ”€â”€ syscall.h
    â””â”€â”€ uapp.S
</code></pre></div>
<ul>
<li>ä¿®æ”¹ <strong>æ ¹ç›®å½•</strong> ä¸‹çš„ Makefile, å°† <code>user</code> çº³å…¥å·¥ç¨‹ç®¡ç†ã€‚</li>
<li>åœ¨æ ¹ç›®å½•ä¸‹ <code>make</code> ä¼šç”Ÿæˆ <code>user/uapp.o</code> <code>user/uapp.elf</code> <code>user/uapp.bin</code>ï¼Œä»¥åŠæˆ‘ä»¬æœ€ç»ˆæµ‹è¯•ä½¿ç”¨çš„ ELF å¯æ‰§è¡Œæ–‡ä»¶ <code>user/uapp</code> ã€‚ é€šè¿‡ <code>objdump</code> æˆ‘ä»¬å¯ä»¥çœ‹åˆ° uapp ä½¿ç”¨ ecall æ¥è°ƒç”¨ SYSCALL (åœ¨ U-Mode ä¸‹ä½¿ç”¨ ecall ä¼šè§¦å‘environment-call-from-U-modeå¼‚å¸¸)ã€‚ä»è€Œå°†æ§åˆ¶æƒäº¤ç»™å¤„åœ¨ S-Mode çš„ OSï¼Œ ç”±å†…æ ¸æ¥å¤„ç†ç›¸å…³å¼‚å¸¸ã€‚</li>
<li>åœ¨æœ¬æ¬¡å®éªŒä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆä¼šå°†ç”¨æˆ·æ€ç¨‹åº strip æˆçº¯äºŒè¿›åˆ¶æ–‡ä»¶æ¥è¿è¡Œã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œç”¨æˆ·ç¨‹åºè¿è¡Œçš„ç¬¬ä¸€æ¡æŒ‡ä»¤ä½äºäºŒè¿›åˆ¶æ–‡ä»¶çš„å¼€å§‹ä½ç½®, ä¹Ÿå°±æ˜¯è¯´ <code>uapp_start</code> å¤„çš„æŒ‡ä»¤å°±æ˜¯æˆ‘ä»¬è¦æ‰§è¡Œçš„ç¬¬ä¸€æ¡æŒ‡ä»¤ã€‚æˆ‘ä»¬å°†è¿è¡Œçº¯äºŒè¿›åˆ¶æ–‡ä»¶ä½œä¸ºç¬¬ä¸€æ­¥ï¼Œåœ¨ç¡®è®¤ç”¨æˆ·æ€çš„çº¯äºŒè¿›åˆ¶æ–‡ä»¶èƒ½å¤Ÿè¿è¡Œåï¼Œæˆ‘ä»¬å†å°†å­˜å‚¨åˆ°å†…å­˜ä¸­çš„ç”¨æˆ·ç¨‹åºæ–‡ä»¶æ¢ä¸º ELF æ¥è¿›è¡Œæ‰§è¡Œã€‚</li>
</ul>
<div class="highlight"><pre><span></span><code>0000000000000004 &lt;getpid&gt;:                                                                       
  4:   fe010113             addi    sp,sp,-32                                                
  8:   00813c23             sd      s0,24(sp)                                                
  c:   02010413             addi    s0,sp,32                                                 
 10:   fe843783             ld      a5,-24(s0)                                               
 14:   0ac00893             li      a7,172                                                   
 18:   00000073             ecall                               &lt;- SYS_GETPID                        
...

00000000000000d8 &lt;vprintfmt&gt;:
...
60c:    00070513            mv  a0,a4
610:    00068593            mv  a1,a3
614:    00060613            mv  a2,a2
618:    00000073            ecall                               &lt;- SYS_WRITE
...
</code></pre></div>
<h3 id="42">4.2 åˆ›å»ºç”¨æˆ·æ€è¿›ç¨‹<a class="headerlink" href="#42" title="Permanent link">&para;</a></h3>
<ul>
<li>æœ¬æ¬¡å®éªŒåªéœ€è¦åˆ›å»º 4 ä¸ªç”¨æˆ·æ€è¿›ç¨‹ï¼Œä¿®æ”¹ <code>proc.h</code> ä¸­çš„ <code>NR_TASKS</code> å³å¯ã€‚</li>
<li>ç”±äºåˆ›å»ºç”¨æˆ·æ€è¿›ç¨‹è¦å¯¹ <code>sepc</code> <code>sstatus</code> <code>sscratch</code> åšè®¾ç½®ï¼Œæˆ‘ä»¬å°†å…¶åŠ å…¥ <code>thread_struct</code> ä¸­ã€‚</li>
<li>ç”±äºå¤šä¸ªç”¨æˆ·æ€è¿›ç¨‹éœ€è¦ä¿è¯ç›¸å¯¹éš”ç¦»ï¼Œå› æ­¤ä¸å¯ä»¥å…±ç”¨é¡µè¡¨ã€‚æˆ‘ä»¬ä¸ºæ¯ä¸ªç”¨æˆ·æ€è¿›ç¨‹éƒ½åˆ›å»ºä¸€ä¸ªé¡µè¡¨ã€‚ä¿®æ”¹ <code>task_struct</code> å¦‚ä¸‹ã€‚</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// proc.h </span>

<span class="k">typedef</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="o">*</span><span class="w"> </span><span class="n">pagetable_t</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">thread_struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">ra</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">sp</span><span class="p">;</span><span class="w">                     </span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">s</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>

<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">sepc</span><span class="p">,</span><span class="w"> </span><span class="n">sstatus</span><span class="p">,</span><span class="w"> </span><span class="n">sscratch</span><span class="p">;</span><span class="w"> </span>
<span class="p">};</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">thread_info</span><span class="o">*</span><span class="w"> </span><span class="n">thread_info</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">state</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">counter</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">priority</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">thread_struct</span><span class="w"> </span><span class="kr">thread</span><span class="p">;</span>

<span class="w">    </span><span class="n">pagetable_t</span><span class="w"> </span><span class="n">pgd</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<blockquote>
<p><strong>Warningï¼š</strong> ç»æµ‹è¯•å®ç°ä¸­å¹¶ä¸éœ€è¦ <code>thread_info</code> è¿™ä¸ªæˆå‘˜ï¼Œå¯ä»¥è€ƒè™‘ä¸ä½¿ç”¨è¿™ä¸ªæˆå‘˜ï¼Œæˆ–è€…å°†å…¶åˆ é™¤ï¼Œå¹¶æ›´æ”¹ <code>switch_to</code> ä¸­å„ä¸ªå˜é‡çš„åç§»é‡ï¼Œè®©æˆ‘ä»¬çš„ OS ä¿æŒåŸæ¥çš„è¡Œä¸ºã€‚</p>
</blockquote>
<ul>
<li>ä¿®æ”¹ task_init</li>
<li>å¯¹æ¯ä¸ªç”¨æˆ·æ€è¿›ç¨‹ï¼Œå…¶æ‹¥æœ‰ä¸¤ä¸ª stackï¼š <code>U-Mode Stack</code> ä»¥åŠ <code>S-Mode Stack</code>ï¼Œ å…¶ä¸­ <code>S-Mode Stack</code> åœ¨ <code>lab3</code> ä¸­æˆ‘ä»¬å·²ç»è®¾ç½®å¥½äº†ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>alloc_page</code> æ¥å£ç”³è¯·ä¸€ä¸ªç©ºçš„é¡µé¢æ¥ä½œä¸º <code>U-Mode Stack</code>ã€‚</li>
<li>ä¸ºæ¯ä¸ªç”¨æˆ·æ€è¿›ç¨‹åˆ›å»ºè‡ªå·±çš„é¡µè¡¨ å¹¶å°† <code>uapp</code> æ‰€åœ¨é¡µé¢ï¼Œä»¥åŠ <code>U-Mode Stack</code> åšç›¸åº”çš„æ˜ å°„ï¼ŒåŒæ—¶ä¸ºäº†é¿å… <code>U-Mode</code> å’Œ <code>S-Mode</code> åˆ‡æ¢çš„æ—¶å€™åˆ‡æ¢é¡µè¡¨ï¼Œæˆ‘ä»¬ä¹Ÿå°†å†…æ ¸é¡µè¡¨ ï¼ˆ <code>swapper_pg_dir</code> ï¼‰ å¤åˆ¶åˆ°æ¯ä¸ªè¿›ç¨‹çš„é¡µè¡¨ä¸­ã€‚æ³¨æ„ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæœ‰éƒ¨åˆ†æ•°æ®ä¸åœ¨æ ˆä¸Šï¼Œè€Œåœ¨åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­å°±å·²ç»è¢«åˆ†é…äº†ç©ºé—´ï¼ˆæ¯”å¦‚æˆ‘ä»¬çš„ <code>uapp</code> ä¸­çš„ <code>counter</code> å˜é‡ï¼‰ï¼Œæ‰€ä»¥äºŒè¿›åˆ¶æ–‡ä»¶éœ€è¦å…ˆè¢« <strong>æ‹·è´</strong> åˆ°ä¸€å—æŸä¸ªè¿›ç¨‹ä¸“ç”¨çš„å†…å­˜ä¹‹åå†è¿›è¡Œæ˜ å°„ï¼Œé˜²æ­¢æ‰€æœ‰çš„è¿›ç¨‹å…±äº«æ•°æ®ï¼Œé€ æˆæœŸæœ›å¤–çš„è¿›ç¨‹é—´ç›¸äº’å½±å“ã€‚</li>
<li>å¯¹æ¯ä¸ªç”¨æˆ·æ€è¿›ç¨‹æˆ‘ä»¬éœ€è¦å°† <code>sepc</code> ä¿®æ”¹ä¸º <code>USER_START</code>ï¼Œé…ç½®ä¿®æ”¹å¥½ <code>sstatus</code> ä¸­çš„ <code>SPP</code> ï¼ˆ ä½¿å¾— sret è¿”å›è‡³ U-Mode ï¼‰ï¼Œ <code>SPIE</code> ï¼ˆ sret ä¹‹åå¼€å¯ä¸­æ–­ ï¼‰ï¼Œ <code>SUM</code> ï¼ˆ S-Mode å¯ä»¥è®¿é—® User é¡µé¢ ï¼‰ï¼Œ <code>sscratch</code> è®¾ç½®ä¸º <code>U-Mode</code> çš„ spï¼Œå…¶å€¼ä¸º <code>USER_END</code> ï¼ˆå³  <code>U-Mode Stack</code> è¢«æ”¾ç½®åœ¨ <code>user space</code> çš„æœ€åä¸€ä¸ªé¡µé¢ï¼‰ã€‚</li>
<li>ä¿®æ”¹ __switch_toï¼Œ éœ€è¦åŠ å…¥ ä¿å­˜/æ¢å¤ <code>sepc</code> <code>sstatus</code> <code>sscratch</code> ä»¥åŠ åˆ‡æ¢é¡µè¡¨çš„é€»è¾‘ã€‚</li>
<li>åœ¨åˆ‡æ¢äº†é¡µè¡¨ä¹‹åï¼Œéœ€è¦é€šè¿‡ <code>fence.i</code> å’Œ <code>vma.fence</code> æ¥åˆ·æ–° TLB å’Œ ICacheã€‚</li>
</ul>
<div class="highlight"><pre><span></span><code>                PHY_START                                                                PHY_END
                     new allocated memory            allocated space end
                   â”‚         â”‚                                â”‚                                                 â”‚
                   â–¼         â–¼                                â–¼                                                 â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 PA    â”‚           â”‚         â”‚ uapp (copied from uapp_start)  â”‚                                                 â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–²                                â–²
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
       â”‚            (map)                                     â”‚
       â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                        â”‚
       â”‚                        â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 VA    â”‚           UAPP         â”‚                                                                   â”‚u mode stackâ”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–²                                                                                                         â–²
       â”‚                                                                                                         â”‚

   USER_START                                                                                                USER_END
</code></pre></div>
<h3 id="43-_trap-trap_handler">4.3 ä¿®æ”¹ä¸­æ–­å…¥å£/è¿”å›é€»è¾‘ ( _trap ) ä»¥åŠä¸­æ–­å¤„ç†å‡½æ•° ï¼ˆ trap_handler ï¼‰<a class="headerlink" href="#43-_trap-trap_handler" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>ä¸ ARM æ¶æ„ä¸åŒçš„æ˜¯ï¼ŒRISC-V ä¸­åªæœ‰ä¸€ä¸ªæ ˆæŒ‡é’ˆå¯„å­˜å™¨( sp )ï¼Œå› æ­¤éœ€è¦æˆ‘ä»¬æ¥å®Œæˆç”¨æˆ·æ ˆä¸å†…æ ¸æ ˆçš„åˆ‡æ¢ã€‚</p>
</li>
<li>
<p>ç”±äºæˆ‘ä»¬çš„ç”¨æˆ·æ€è¿›ç¨‹è¿è¡Œåœ¨ <code>U-Mode</code> ä¸‹ï¼Œ ä½¿ç”¨çš„è¿è¡Œæ ˆä¹Ÿæ˜¯ <code>U-Mode Stack</code>ï¼Œ å› æ­¤å½“è§¦å‘å¼‚å¸¸æ—¶ï¼Œ æˆ‘ä»¬é¦–å…ˆè¦å¯¹æ ˆè¿›è¡Œåˆ‡æ¢ ï¼ˆ <code>U-Mode Stack</code> -&gt; <code>S-Mode Stack</code> ï¼‰ã€‚åŒç† è®©æˆ‘ä»¬å®Œæˆäº†å¼‚å¸¸å¤„ç†ï¼Œ ä» <code>S-Mode</code> è¿”å›è‡³ <code>U-Mode</code>ï¼Œ ä¹Ÿéœ€è¦è¿›è¡Œæ ˆåˆ‡æ¢ ï¼ˆ <code>S-Mode Stack</code> -&gt; <code>U-Mode Stack</code> ï¼‰ã€‚</p>
</li>
<li>
<p>ä¿®æ”¹ <code>__dummy</code>ã€‚åœ¨ <strong>4.2</strong> ä¸­ æˆ‘ä»¬åˆå§‹åŒ–æ—¶ï¼Œ <code>thread_struct.sp</code> ä¿å­˜äº† <code>S-Mode sp</code>ï¼Œ <code>thread_struct.sscratch</code> ä¿å­˜äº† <code>U-Mode sp</code>ï¼Œ å› æ­¤åœ¨ <code>S-Mode -&gt; U-&gt;Mode</code> çš„æ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦äº¤æ¢å¯¹åº”çš„å¯„å­˜å™¨çš„å€¼å³å¯ã€‚</p>
</li>
<li>
<p>ä¿®æ”¹ <code>_trap</code> ã€‚åŒç† åœ¨ <code>_trap</code> çš„é¦–å°¾æˆ‘ä»¬éƒ½éœ€è¦åšç±»ä¼¼çš„æ“ä½œã€‚<strong>æ³¨æ„å¦‚æœæ˜¯ å†…æ ¸çº¿ç¨‹( æ²¡æœ‰ U-Mode Stack ) è§¦å‘äº†å¼‚å¸¸ï¼Œåˆ™ä¸éœ€è¦è¿›è¡Œåˆ‡æ¢ã€‚ï¼ˆå†…æ ¸çº¿ç¨‹çš„ sp æ°¸è¿œæŒ‡å‘çš„ S-Mode Stackï¼Œ sscratch ä¸º 0ï¼‰</strong></p>
</li>
<li>
<p><code>uapp</code> ä½¿ç”¨ <code>ecall</code> ä¼šäº§ç”Ÿ <code>ECALL_FROM_U_MODE</code> <strong>exception</strong>ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦åœ¨ <code>trap_handler</code> é‡Œé¢è¿›è¡Œæ•è·ã€‚ä¿®æ”¹ <code>trap_handler</code> å¦‚ä¸‹ï¼š</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">trap_handler</span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">scause</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">sepc</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">pt_regs</span><span class="w"> </span><span class="o">*</span><span class="n">regs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
<p>è¿™é‡Œéœ€è¦è§£é‡Šæ–°å¢åŠ çš„ç¬¬ä¸‰ä¸ªå‚æ•° <code>regs</code>ï¼Œ åœ¨ _trap ä¸­æˆ‘ä»¬å°†å¯„å­˜å™¨çš„å†…å®¹ <strong>è¿ç»­</strong> çš„ä¿å­˜åœ¨ S-Mode Stackä¸Šï¼Œ å› æ­¤æˆ‘ä»¬å¯ä»¥å°†è¿™ä¸€æ®µçœ‹åšä¸€ä¸ªå«åš <code>pt_regs</code>çš„ç»“æ„ä½“ã€‚æˆ‘ä»¬å¯ä»¥ä»è¿™ä¸ªç»“æ„ä½“ä¸­å–åˆ°ç›¸åº”çš„å¯„å­˜å™¨çš„å€¼ï¼ˆ æ¯”å¦‚ syscall ä¸­æˆ‘ä»¬éœ€è¦ä» a0 ~ a7 å¯„å­˜å™¨ä¸­å–åˆ°å‚æ•° ï¼‰ã€‚è¿™ä¸ªç»“æ„ä½“ä¸­çš„å€¼ä¹Ÿå¯ä»¥æŒ‰éœ€æ·»åŠ ï¼ŒåŒæ—¶éœ€è¦åœ¨ <code>_trap</code> ä¸­å­˜å…¥å¯¹åº”çš„å¯„å­˜å™¨å€¼ä»¥ä¾›ä½¿ç”¨ï¼Œ ç¤ºä¾‹å¦‚ä¸‹å›¾ï¼š</p>
<div class="highlight"><pre><span></span><code>    High Addr â”€â”€â”€â–º  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   sstatus   â”‚
                    â”‚             â”‚
                    â”‚     sepc    â”‚
                    â”‚             â”‚
                    â”‚     x31     â”‚
                    â”‚             â”‚
                    â”‚      .      â”‚
                    â”‚      .      â”‚
                    â”‚      .      â”‚
                    â”‚             â”‚
                    â”‚     x1      â”‚
                    â”‚             â”‚
                    â”‚     x0      â”‚
 sp (pt_regs)  â”€â”€â–º  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚             â”‚
                    â”‚             â”‚
                    â”‚             â”‚
                    â”‚             â”‚
                    â”‚             â”‚
                    â”‚             â”‚
                    â”‚             â”‚
                    â”‚             â”‚
                    â”‚             â”‚
    Low  Addr â”€â”€â”€â–º  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>
<p>è¯·åŒå­¦è‡ªå·±è¡¥å…… <code>struct pt_regs</code>çš„å®šä¹‰ï¼Œ ä»¥åŠåœ¨ <code>trap_handler</code> ä¸­è¡¥å……å¤„ç† SYSCALL çš„é€»è¾‘ã€‚</p>
<h3 id="44">4.4 æ·»åŠ ç³»ç»Ÿè°ƒç”¨<a class="headerlink" href="#44" title="Permanent link">&para;</a></h3>
<ul>
<li>æœ¬æ¬¡å®éªŒè¦æ±‚çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°åŸå‹ä»¥åŠå…·ä½“åŠŸèƒ½å¦‚ä¸‹ï¼š</li>
<li>64 å·ç³»ç»Ÿè°ƒç”¨ <code>sys_write(unsigned int fd, const char* buf, size_t count)</code> è¯¥è°ƒç”¨å°†ç”¨æˆ·æ€ä¼ é€’çš„å­—ç¬¦ä¸²æ‰“å°åˆ°å±å¹•ä¸Šï¼Œæ­¤å¤„fdä¸ºæ ‡å‡†è¾“å‡ºï¼ˆ1ï¼‰ï¼Œbufä¸ºç”¨æˆ·éœ€è¦æ‰“å°çš„èµ·å§‹åœ°å€ï¼Œcountä¸ºå­—ç¬¦ä¸²é•¿åº¦ï¼Œè¿”å›æ‰“å°çš„å­—ç¬¦æ•°ã€‚( å…·ä½“è§ user/printf.c )</li>
<li>172 å·ç³»ç»Ÿè°ƒç”¨ <code>sys_getpid()</code> è¯¥è°ƒç”¨ä»currentä¸­è·å–å½“å‰çš„pidæ”¾å…¥a0ä¸­è¿”å›ï¼Œæ— å‚æ•°ã€‚ï¼ˆ å…·ä½“è§ user/getpid.c ï¼‰</li>
<li>å¢åŠ  <code>syscall.c</code> <code>syscall.h</code> æ–‡ä»¶ï¼Œ å¹¶åœ¨å…¶ä¸­å®ç° <code>getpid</code> ä»¥åŠ <code>write</code> é€»è¾‘ã€‚</li>
<li>ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å‚æ•°æ”¾ç½®åœ¨ <code>a0</code> ä¸­ (ä¸å¯ä»¥ç›´æ¥ä¿®æ”¹å¯„å­˜å™¨ï¼Œ åº”è¯¥ä¿®æ”¹ regs ä¸­ä¿å­˜çš„å†…å®¹)ã€‚</li>
<li>é’ˆå¯¹ç³»ç»Ÿè°ƒç”¨è¿™ä¸€ç±»å¼‚å¸¸ï¼Œ æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨å°† <code>sepc + 4</code> ï¼ˆ <code>sepc</code> è®°å½•çš„æ˜¯è§¦å‘å¼‚å¸¸çš„æŒ‡ä»¤åœ°å€ï¼Œ ç”±äºç³»ç»Ÿè°ƒç”¨è¿™ç±»å¼‚å¸¸å¤„ç†å®Œæˆä¹‹åï¼Œ æˆ‘ä»¬åº”è¯¥ç»§ç»­æ‰§è¡Œåç»­çš„æŒ‡ä»¤ï¼Œå› æ­¤éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨ä¿®æ”¹ <code>sepc</code> çš„åœ°å€ï¼Œä½¿å¾— <code>sret</code> ä¹‹å ç¨‹åºç»§ç»­æ‰§è¡Œï¼‰ã€‚</li>
</ul>
<h3 id="45-heads-start_kernel">4.5 ä¿®æ”¹ head.S ä»¥åŠ start_kernel<a class="headerlink" href="#45-heads-start_kernel" title="Permanent link">&para;</a></h3>
<ul>
<li>åœ¨ä¹‹å‰çš„ lab ä¸­ï¼Œ åœ¨ OS boot ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦ç­‰å¾…ä¸€ä¸ªæ—¶é—´ç‰‡ï¼Œæ‰ä¼šè¿›è¡Œè°ƒåº¦ã€‚æˆ‘ä»¬ç°åœ¨æ›´æ”¹ä¸º OS boot å®Œæˆä¹‹åç«‹å³è°ƒåº¦ uapp è¿è¡Œã€‚</li>
<li>åœ¨ start_kernel ä¸­è°ƒç”¨ schedule() æ³¨æ„æ”¾ç½®åœ¨ test() ä¹‹å‰ã€‚</li>
<li>å°† head.S ä¸­ enable interrupt sstatus.SIE é€»è¾‘æ³¨é‡Šï¼Œç¡®ä¿ schedule è¿‡ç¨‹ä¸å—ä¸­æ–­å½±å“ã€‚</li>
</ul>
<h3 id="46">4.6 æµ‹è¯•çº¯äºŒè¿›åˆ¶æ–‡ä»¶<a class="headerlink" href="#46" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>ç”±äºåŠ å…¥äº†ä¸€äº›æ–°çš„ .c æ–‡ä»¶ï¼Œå¯èƒ½éœ€è¦ä¿®æ”¹ä¸€äº›Makefileæ–‡ä»¶ï¼Œè¯·åŒå­¦è‡ªå·±å°è¯•ä¿®æ”¹ï¼Œä½¿é¡¹ç›®å¯ä»¥ç¼–è¯‘å¹¶è¿è¡Œã€‚</p>
</li>
<li>
<p>è¾“å‡ºç¤ºä¾‹</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code>OpenSBI v0.9
      ____                    _____ ____ _____
     / __ \                  / ____|  _ \_   _|
    | |  | |_ __   ___ _ __ | (___ | |_) || |
    | |  | | &#39;_ \ / _ \ &#39;_ \ \___ \|  _ &lt; | |
    | |__| | |_) |  __/ | | |____) | |_) || |_
     \____/| .__/ \___|_| |_|_____/|____/_____|
           | |
           |_|

    ...

    Boot HART MIDELEG         : 0x0000000000000222
    Boot HART MEDELEG         : 0x000000000000b109

    ...mm_init done!
    ...proc_init done!
    [S-MODE] Hello RISC-V

    [U-MODE] pid: 4, sp is 0000003fffffffe0, this is print No.*
    [U-MODE] pid: 3, sp is 0000003fffffffe0, this is print No.*
    [U-MODE] pid: 2, sp is 0000003fffffffe0, this is print No.*
    [U-MODE] pid: 1, sp is 0000003fffffffe0, this is print No.*

    [U-MODE] pid: 4, sp is 0000003fffffffe0, this is print No.*
    [U-MODE] pid: 3, sp is 0000003fffffffe0, this is print No.*
    [U-MODE] pid: 2, sp is 0000003fffffffe0, this is print No.*
    [U-MODE] pid: 1, sp is 0000003fffffffe0, this is print No.*

    [U-MODE] pid: 4, sp is 0000003fffffffe0, this is print No.*
    [U-MODE] pid: 3, sp is 0000003fffffffe0, this is print No.*
    [U-MODE] pid: 2, sp is 0000003fffffffe0, this is print No.*
    [U-MODE] pid: 1, sp is 0000003fffffffe0, this is print No.*

    [U-MODE] pid: 4, sp is 0000003fffffffe0, this is print No.*
    [U-MODE] pid: 3, sp is 0000003fffffffe0, this is print No.*
    [U-MODE] pid: 2, sp is 0000003fffffffe0, this is print No.*
    [U-MODE] pid: 1, sp is 0000003fffffffe0, this is print No.*
    ...
</code></pre></div>
<h3 id="47-elf">4.7 æ·»åŠ  ELF æ”¯æŒ<a class="headerlink" href="#47-elf" title="Permanent link">&para;</a></h3>
<h4 id="elf-header">ELF Header<a class="headerlink" href="#elf-header" title="Permanent link">&para;</a></h4>
<p>ELF æ–‡ä»¶ä¸­åŒ…å«äº†å°†ç¨‹åºåŠ è½½åˆ°å†…å­˜æ‰€éœ€çš„ä¿¡æ¯ã€‚å½“æˆ‘ä»¬é€šè¿‡ <code>readelf</code> æ¥æŸ¥çœ‹ä¸€ä¸ª ELF å¯æ‰§è¡Œæ–‡ä»¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥è¯»åˆ°è¢«åŒ…å«åœ¨ ELF Header ä¸­çš„ä¿¡æ¯ï¼š</p>
<div class="highlight"><pre><span></span><code>$ readelf -a uapp
ELF Header:
  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 
  Class:                             ELF64
  Data:                              2&#39;s complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0
  Type:                              EXEC (Executable file)
  Machine:                           RISC-V
  Version:                           0x1
  Entry point address:               0x100e8
  Start of program headers:          64 (bytes into file)
  Start of section headers:          3200 (bytes into file)
  Flags:                             0x0
  Size of this header:               64 (bytes)
  Size of program headers:           56 (bytes)
  Number of program headers:         3
  Size of section headers:           64 (bytes)
  Number of section headers:         9
  Section header string table index: 8

Section Headers:
  [Nr] Name              Type             Address           Offset
       Size              EntSize          Flags  Link  Info  Align
  [ 0]                   NULL             0000000000000000  00000000
       0000000000000000  0000000000000000           0     0     0
  [ 1] .text             PROGBITS         00000000000100e8  000000e8
       00000000000006fc  0000000000000000  AX       0     0     4
  [ 2] .rodata           PROGBITS         00000000000107e8  000007e8
       0000000000000078  0000000000000000   A       0     0     8
  [ 3] .bss              NOBITS           0000000000011860  00000860
       00000000000003f0  0000000000000000  WA       0     0     8
  [ 4] .comment          PROGBITS         0000000000000000  00000860
       000000000000002b  0000000000000001  MS       0     0     1
  [ 5] .riscv.attributes RISCV_ATTRIBUTE  0000000000000000  0000088b
       000000000000002e  0000000000000000           0     0     1
  [ 6] .symtab           SYMTAB           0000000000000000  000008c0
       00000000000002d0  0000000000000018           7    17     8
  [ 7] .strtab           STRTAB           0000000000000000  00000b90
       00000000000000a1  0000000000000000           0     0     1
  [ 8] .shstrtab         STRTAB           0000000000000000  00000c31
       0000000000000049  0000000000000000           0     0     1
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),
  L (link order), O (extra OS processing required), G (group), T (TLS),
  C (compressed), x (unknown), o (OS specific), E (exclude),
  D (mbind), p (processor specific)

There are no section groups in this file.

Program Headers:
  Type           Offset             VirtAddr           PhysAddr
                 FileSiz            MemSiz              Flags  Align
  RISCV_ATTRIBUT 0x000000000000088b 0x0000000000000000 0x0000000000000000
                 0x000000000000002e 0x0000000000000000  R      0x1
  LOAD           0x00000000000000e8 0x00000000000100e8 0x00000000000100e8
                 0x0000000000000778 0x0000000000001b68  RWE    0x8
  GNU_STACK      0x0000000000000000 0x0000000000000000 0x0000000000000000
                 0x0000000000000000 0x0000000000000000  RW     0x10

 Section to Segment mapping:
  Segment Sections...
   00     .riscv.attributes 
   01     .text .rodata .bss 
   02     

There is no dynamic section in this file.

There are no relocations in this file.

The decoding of unwind sections for machine type RISC-V is not currently supported.

Symbol table &#39;.symtab&#39; contains 30 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND 
     1: 00000000000100e8     0 SECTION LOCAL  DEFAULT    1 .text
     2: 00000000000107e8     0 SECTION LOCAL  DEFAULT    2 .rodata
     3: 0000000000011860     0 SECTION LOCAL  DEFAULT    3 .bss
     4: 0000000000000000     0 SECTION LOCAL  DEFAULT    4 .comment
     5: 0000000000000000     0 SECTION LOCAL  DEFAULT    5 .riscv.attributes
     6: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS start.o
     7: 00000000000100e8     0 NOTYPE  LOCAL  DEFAULT    1 $x
     8: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS getpid.c
     9: 00000000000100ec    52 FUNC    LOCAL  DEFAULT    1 getpid
    10: 00000000000100ec     0 NOTYPE  LOCAL  DEFAULT    1 $x
    11: 0000000000010120     0 NOTYPE  LOCAL  DEFAULT    1 $x
    12: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS printf.c
    13: 000000000001017c     0 NOTYPE  LOCAL  DEFAULT    1 $x
    14: 00000000000101d4  1412 FUNC    LOCAL  DEFAULT    1 vprintfmt
    15: 00000000000101d4     0 NOTYPE  LOCAL  DEFAULT    1 $x
    16: 0000000000010758     0 NOTYPE  LOCAL  DEFAULT    1 $x
    17: 0000000000010758   140 FUNC    GLOBAL DEFAULT    1 printf
    18: 0000000000012060     0 NOTYPE  GLOBAL DEFAULT  ABS __global_pointer$
    19: 0000000000011860     0 NOTYPE  GLOBAL DEFAULT    2 __SDATA_BEGIN__
    20: 0000000000011860     4 OBJECT  GLOBAL DEFAULT    3 tail
    21: 00000000000100e8     0 NOTYPE  GLOBAL DEFAULT    1 _start
    22: 0000000000011868  1000 OBJECT  GLOBAL DEFAULT    3 buffer
    23: 0000000000011c50     0 NOTYPE  GLOBAL DEFAULT    3 __BSS_END__
    24: 0000000000011860     0 NOTYPE  GLOBAL DEFAULT    3 __bss_start
    25: 0000000000010120    92 FUNC    GLOBAL DEFAULT    1 main
    26: 000000000001017c    88 FUNC    GLOBAL DEFAULT    1 putc
    27: 0000000000011860     0 NOTYPE  GLOBAL DEFAULT    2 __DATA_BEGIN__
    28: 0000000000011860     0 NOTYPE  GLOBAL DEFAULT    2 _edata
    29: 0000000000011c50     0 NOTYPE  GLOBAL DEFAULT    3 _end

No version information found in this file.
Attribute Section: riscv
File Attributes
  Tag_RISCV_arch: &quot;rv64i2p0_m2p0_a2p0_f2p0_d2p0&quot;
</code></pre></div>
<p>å…¶ä¸­åŒ…å«äº†ä¸¤ç§å°†ç¨‹åºåˆ†å—çš„ç²’åº¦ï¼ŒSegmentï¼ˆæ®µï¼‰å’Œ Sectionï¼ˆèŠ‚ï¼‰ï¼Œæˆ‘ä»¬ä»¥æ®µä¸ºç²’åº¦å°†ç¨‹åºåŠ è½½è¿›å†…å­˜ä¸­ã€‚å¯ä»¥çœ‹åˆ°ï¼Œç»™å‡ºçš„æ ·ä¾‹ç¨‹åºåŒ…å«äº†ä¸‰ä¸ªæ®µï¼Œè¿™é‡Œæˆ‘ä»¬åªå…³æ³¨ Type ä¸º LOAD çš„æ®µï¼ŒLOAD è¡¨ç¤ºä»–ä»¬éœ€è¦åœ¨å¼€å§‹è¿è¡Œå‰è¢«åŠ è½½è¿›å†…å­˜ä¸­ï¼Œè¿™æ˜¯æˆ‘ä»¬åœ¨åˆå§‹åŒ–è¿›ç¨‹çš„æ—¶å€™éœ€è¦æ‰§è¡Œçš„å·¥ä½œã€‚</p>
<p>è€Œâ€œèŠ‚â€ä»£è¡¨äº†æ›´ç»†åˆ†çš„è¯­ä¹‰ï¼Œæ¯”å¦‚ <code>.text</code> ä¸€èˆ¬åŒ…å«äº†ç¨‹åºçš„æŒ‡ä»¤ï¼Œ<code>.rodata</code> æ˜¯åªè¯»çš„å…¨å±€å˜é‡ç­‰ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œ Google æ¥å­¦ä¹ æ›´å¤šç›¸å…³å†…å®¹ã€‚</p>
<h4 id="_1">æ‰€ä»¥ä»£ç æ€ä¹ˆå†™ï¼Ÿ<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h4>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å°† <code>uapp.S</code> ä¸­çš„ payload ç»™æ¢æˆæˆ‘ä»¬çš„ ELF æ–‡ä»¶ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="cm">/* user/uapp.S */</span>
<span class="p">.</span><span class="n">section</span><span class="w"> </span><span class="p">.</span><span class="n">uapp</span>

<span class="p">.</span><span class="n">incbin</span><span class="w"> </span><span class="s">&quot;uapp&quot;</span>
</code></pre></div>
<p>è¿™æ—¶å€™ä» <code>uapp_start</code> å¼€å§‹çš„æ•°æ®å°±å˜æˆäº†åä¸º <code>uapp</code> çš„ ELF æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´ <code>uapp_start</code> å¤„ 32-bit çš„æ•°æ®ä¸å†æ˜¯æˆ‘ä»¬éœ€è¦æ‰§è¡Œç¬¬ä¸€æ¡æŒ‡ä»¤äº†ï¼Œè€Œæ˜¯ ELF Header çš„å¼€å§‹ã€‚</p>
<p>è¿™æ—¶å€™å°±éœ€è¦ä½ å¯¹ <code>task_init</code> ä¸­çš„åˆå§‹åŒ–æ­¥éª¤è¿›è¡Œä¿®æ”¹ã€‚æˆ‘ä»¬ç»™å‡ºäº† ELF ç›¸å…³çš„ç»“æ„ä½“å®šä¹‰ï¼ˆ<code>elf.h</code>ï¼‰ï¼Œå¤§å®¶å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚ä½ å¯èƒ½ä¼šä½¿ç”¨åˆ°çš„ç»“æ„ä½“æˆ–è€…åŸŸå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code>Elf64_Ehdr   // ä½ å¯ä»¥å°† uapp_start å¼ºåˆ¶è½¬åŒ–ä¸ºæ”¹ç±»å‹çš„æŒ‡é’ˆï¼Œ
                ç„¶åæŠŠé‚£ä¸€å—å†…å­˜å½“æˆæ­¤ç±»ç»“æ„ä½“æ¥è¯»å…¶ä¸­çš„æ•°æ®ï¼Œå…¶ä¸­åŒ…æ‹¬ï¼š
    e_ident  // Magic Number, ä½ å¯ä»¥é€šè¿‡è¿™ä¸ªåŸŸæ¥æ£€æµ‹è‡ªå·±æ˜¯ä¸æ˜¯çœŸçš„æ­£åœ¨è¯»ä¸€ä¸ª Ehdr,
                å€¼ä¸€å®šæ˜¯ 7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00
    e_entry  // ç¨‹åºçš„ç¬¬ä¸€æ¡æŒ‡ä»¤è¢«å­˜å‚¨çš„ç”¨æˆ·æ€è™šæ‹Ÿåœ°å€
    e_phnum  // ELF æ–‡ä»¶åŒ…å«çš„ Segment çš„æ•°é‡
    e_phoff  // ELF æ–‡ä»¶åŒ…å«çš„ Segment æ•°ç»„ç›¸å¯¹äº Ehdr çš„åç§»é‡

Elf64_Phdr   // å­˜å‚¨äº†ç¨‹åºå„ä¸ª Segment ç›¸å…³çš„ metadata
             // ä½ å¯ä»¥å°† uapp_start + e_phoff å¼ºåˆ¶è½¬åŒ–ä¸ºæ­¤ç±»å‹ï¼Œå°±ä¼šæŒ‡å‘ç¬¬ä¸€ä¸ª Phdr,
             // uapp_start + e_phoff + 1 * sizeof(Elf64_Phdr), åˆ™æŒ‡å‘ç¬¬äºŒä¸ªâ€˜
    p_filesz // Segment åœ¨æ–‡ä»¶ä¸­å çš„å¤§å°
    p_memsz  // Segment åœ¨å†…å­˜ä¸­å çš„å¤§å°
    p_vaddr  // Segment èµ·å§‹çš„ç”¨æˆ·æ€è™šæ‹Ÿåœ°å€
    p_offset // Segment åœ¨æ–‡ä»¶ä¸­ç›¸å¯¹äº Ehdr çš„åç§»é‡
    p_type   // Segment çš„ç±»å‹ 
    p_flags  // Segment çš„æƒé™ï¼ˆåŒ…æ‹¬äº†è¯»ã€å†™å’Œæ‰§è¡Œï¼‰
</code></pre></div>
<p>æˆ‘ä»¬å¯ä»¥æŒ‰ç…§è¿™äº›ä¿¡æ¯ï¼Œåœ¨ä» <code>uapp_start</code> - <code>uapp_end</code> è¿™ä¸ª ELF æ–‡ä»¶ä¸­çš„å†…å®¹ <strong>æ‹·è´</strong> åˆ°æˆ‘ä»¬å¼€è¾Ÿçš„å†…å­˜ä¸­ã€‚</p>
<p>å…¶ä¸­ç›¸å¯¹æ–‡ä»¶åç§» <code>p_offset</code> æŒ‡å‡ºç›¸åº” segment çš„å†…å®¹ä» ELF æ–‡ä»¶çš„ç¬¬ <code>p_offset</code> å­—èŠ‚å¼€å§‹, åœ¨æ–‡ä»¶ä¸­çš„å¤§å°ä¸º <code>p_filesz</code>, å®ƒéœ€è¦è¢«åˆ†é…åˆ°ä»¥ <code>p_vaddr</code> ä¸ºé¦–åœ°å€çš„è™šæ‹Ÿå†…å­˜ä½ç½®, åœ¨å†…å­˜ä¸­å®ƒå ç”¨å¤§å°ä¸º <code>p_memsz</code>. ä¹Ÿå°±æ˜¯è¯´, è¿™ä¸ª segment ä½¿ç”¨çš„å†…å­˜å°±æ˜¯ <code>[p_vaddr, p_vaddr + p_memsz)</code> è¿™ä¸€è¿ç»­åŒºé—´, ç„¶åå°† segment çš„å†…å®¹ä»ELFæ–‡ä»¶ä¸­è¯»å…¥åˆ°è¿™ä¸€å†…å­˜åŒºé—´, å¹¶å°† <code>[p_vaddr + p_filesz, p_vaddr + p_memsz)</code> å¯¹åº”çš„ç‰©ç†åŒºé—´æ¸…é›¶. ï¼ˆæœ¬æ®µå†…å®¹å¼•ç”¨è‡ª<a href="https://nju-projectn.github.io/ics-pa-gitbook/ics2022/3.3.html">å—äº¬å¤§å­¦PA</a>)</p>
<p>ä½ ä¹Ÿå¯ä»¥å‚è€ƒè¿™ç¯‡ <a href="https://www.gabriel.urdhr.fr/2015/01/22/elf-linking/">blog</a> ä¸­å…³äº <strong>é™æ€</strong> é“¾æ¥ç¨‹åºçš„è½½å…¥è¿‡ç¨‹æ¥è¿›è¡Œä½ çš„è½½å…¥ã€‚</p>
<p>è¿™é‡Œæœ‰ä¸å°‘ä¾‹å­å¯ä»¥ä¸¾ï¼Œä¸ºäº†é¿å…åŒå­¦ä»¬åœ¨å®éªŒä¸­èŠ±å¤ªå¤šæ—¶é—´ï¼Œæˆ‘ä»¬å‘Šè¯‰å¤§å®¶å¯ä»¥æ€ä¹ˆæ‰¾åˆ°å®éªŒä¸­è¿™äº›ç›¸å…³å˜é‡è¢«å­˜åœ¨äº†å“ªé‡Œï¼š(æ³¨æ„ä»¥ä¸‹çš„ <code>uapp_start</code> ç±»å‹ä½¿ç”¨çš„æ˜¯ <code>char*</code>ï¼Œå¦‚æœä½ åœ¨ä½¿ç”¨å…¶ä»–ç±»å‹ï¼Œéœ€è¦æ ¹æ®ä½ ä½¿ç”¨çš„ç±»å‹å»è°ƒæ•´é’ˆå¯¹æŒ‡é’ˆçš„ç®—æ•°è¿ç®—ã€‚ï¼‰</p>
<ul>
<li><code>Elf64_Ehdr* ehdr = (Elf64_Ehdr*)uapp_start</code>ï¼Œä»åœ°å€ uapp_start å¼€å§‹ï¼Œä¾¿æ˜¯æˆ‘ä»¬è¦æ‰¾çš„ Ehdr.</li>
<li><code>Elf64_Phdr* phdrs = (Elf64_Phdr*)(uapp_start + ehdr-&gt;phoff)</code>ï¼Œæ˜¯ä¸€ä¸ª Phdr æ•°ç»„ï¼Œå…¶ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ª <code>Elf64_Phdr</code>.</li>
<li><code>phdrs[ehdr-&gt;phnum - 1]</code> æ˜¯æœ€åä¸€ä¸ª Phdr.</li>
<li><code>phdrs[0].p_type == PT_LOAD</code>ï¼Œè¯´æ˜è¿™ä¸ª Segment çš„ç±»å‹æ˜¯ LOADï¼Œéœ€è¦åœ¨åˆå§‹åŒ–æ—¶è¢«åŠ è½½è¿›å†…å­˜ã€‚</li>
<li><code>(void*)(uapp_start + phdrs[1].p_offset)</code> å°†ä¼šæŒ‡å‘ç¬¬äºŒä¸ªæ®µä¸­çš„å†…å®¹çš„å¼€å¤´.</li>
</ul>
<p>å‰©ä¸‹çš„åŸŸçš„ç”¨æ³•æˆ‘ä»¬å¸Œæœ›åŒå­¦ä»¬é€šè¿‡é˜…è¯» <code>man elf</code> å‘½ä»¤å’Œä½¿ç”¨ <a href="google.com">Google</a>ï¼ˆæ³¨æ„ä¸æ˜¯ç™¾åº¦ï¼‰æ¥è·å–ã€‚å¤§å®¶å¯ä»¥å‚è€ƒä»¥ä¸‹çš„ä»£ç æ¥å°†ç¨‹åº load è¿›å…¥å†…å­˜ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="nf">load_program</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="o">*</span><span class="w"> </span><span class="n">task</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Elf64_Ehdr</span><span class="o">*</span><span class="w"> </span><span class="n">ehdr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Elf64_Ehdr</span><span class="o">*</span><span class="p">)</span><span class="n">uapp_start</span><span class="p">;</span>

<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">phdr_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">ehdr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ehdr</span><span class="o">-&gt;</span><span class="n">e_phoff</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">phdr_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ehdr</span><span class="o">-&gt;</span><span class="n">e_phnum</span><span class="p">;</span>

<span class="w">    </span><span class="n">Elf64_Phdr</span><span class="o">*</span><span class="w"> </span><span class="n">phdr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">load_phdr_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">phdr_cnt</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">phdr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Elf64_Phdr</span><span class="o">*</span><span class="p">)(</span><span class="n">phdr_start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">Elf64_Phdr</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">phdr</span><span class="o">-&gt;</span><span class="n">p_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PT_LOAD</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// alloc space and copy content</span>
<span class="w">            </span><span class="c1">// do mapping</span>
<span class="w">            </span><span class="c1">// code...</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// allocate user stack and do mapping</span>
<span class="w">    </span><span class="c1">// code...</span>

<span class="w">    </span><span class="c1">// following code has been written for you</span>
<span class="w">    </span><span class="c1">// set user stack</span>
<span class="w">    </span><span class="p">...;</span>
<span class="w">    </span><span class="c1">// pc for the user program</span>
<span class="w">    </span><span class="n">task</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">sepc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ehdr</span><span class="o">-&gt;</span><span class="n">e_entry</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// sstatus bits set</span>
<span class="w">    </span><span class="n">task</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">sstatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...;</span>
<span class="w">    </span><span class="c1">// user stack for user program</span>
<span class="w">    </span><span class="n">task</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">sscratch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...;</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="5">5. æ€è€ƒé¢˜<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<ol>
<li>æˆ‘ä»¬åœ¨å®éªŒä¸­ä½¿ç”¨çš„ç”¨æˆ·æ€çº¿ç¨‹å’Œå†…æ ¸æ€çº¿ç¨‹çš„å¯¹åº”å…³ç³»æ˜¯æ€æ ·çš„ï¼Ÿï¼ˆä¸€å¯¹ä¸€ï¼Œä¸€å¯¹å¤šï¼Œå¤šå¯¹ä¸€è¿˜æ˜¯å¤šå¯¹å¤šï¼‰</li>
<li>ä¸ºä»€ä¹ˆ Phdr ä¸­ï¼Œ<code>p_filesz</code> å’Œ <code>p_memsz</code> æ˜¯ä¸ä¸€æ ·å¤§çš„ï¼Ÿ</li>
<li>ä¸ºä»€ä¹ˆå¤šä¸ªè¿›ç¨‹çš„æ ˆè™šæ‹Ÿåœ°å€å¯ä»¥æ˜¯ç›¸åŒçš„ï¼Ÿç”¨æˆ·æœ‰æ²¡æœ‰å¸¸è§„çš„æ–¹æ³•çŸ¥é“è‡ªå·±æ ˆæ‰€åœ¨çš„ç‰©ç†åœ°å€ï¼Ÿ</li>
</ol>
<h2 id="_2">ä½œä¸šæäº¤<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>åŒå­¦éœ€è¦æäº¤å®éªŒæŠ¥å‘Šä»¥åŠæ•´ä¸ªå·¥ç¨‹ä»£ç ã€‚åœ¨æäº¤å‰è¯·ä½¿ç”¨ <code>make clean</code> æ¸…é™¤æ‰€æœ‰æ„å»ºäº§ç‰©ã€‚</p>


  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        å’¦ï¼Œè¿™é‡Œæ€ä¹ˆæœ‰ä¸€åªå°çŒ«å’ª
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page was helpful" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12 8-1.33.09C9.81 7.07 7.4 4.5 5 4.5c0 0-1.97 2.96-.04 6.91-.55.83-.89 1.26-.96 2.25l-1.93.29.21.98 1.76-.26.14.71-1.57.94.47.89 1.45-.89C5.68 18.76 8.59 20 12 20s6.32-1.24 7.47-3.68l1.45.89.47-.89-1.57-.94.14-.71 1.76.26.21-.98-1.93-.29c-.07-.99-.41-1.42-.96-2.25C20.97 7.46 19 4.5 19 4.5c-2.4 0-4.81 2.57-5.67 3.59L12 8m-3 3a1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1 1 1 0 0 1 1-1m6 0a1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1 1 1 0 0 1 1-1m-4 3h2l-.7 1.39c.2.64.76 1.11 1.45 1.11a1.5 1.5 0 0 0 1.5-1.5h.5a2 2 0 0 1-2 2c-.75 0-1.4-.41-1.75-1-.35.59-1 1-1.75 1a2 2 0 0 1-2-2h.5a1.5 1.5 0 0 0 1.5 1.5c.69 0 1.25-.47 1.45-1.11L11 14Z"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              å°çŒ«å’ªå¾ˆå¼€å¿ƒï¼
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="é¡µè„š" >
        
          
          <a href="../oslab3/" class="md-footer__link md-footer__link--prev" aria-label="ä¸Šä¸€é¡µ: oslab3æŒ‡å¯¼">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                ä¸Šä¸€é¡µ
              </span>
              <div class="md-ellipsis">
                oslab3æŒ‡å¯¼
              </div>
            </div>
          </a>
        
        
          
          <a href="../oslab5/" class="md-footer__link md-footer__link--next" aria-label="ä¸‹ä¸€é¡µ: oslab5æŒ‡å¯¼">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                ä¸‹ä¸€é¡µ
              </span>
              <div class="md-ellipsis">
                oslab5æŒ‡å¯¼
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2023 JLY
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/jly191" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.path", "navigation.prune", "navigation.footer", "toc.follow", "toc.integrate", "search.suggest", "header.autohide", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.aecac24b.min.js"></script>
      
    
  </body>
</html>